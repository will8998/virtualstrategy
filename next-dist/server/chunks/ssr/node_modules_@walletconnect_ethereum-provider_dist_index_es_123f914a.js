module.exports=[737258,a=>{"use strict";a.s(["EthereumProvider",()=>jH,"OPTIONAL_EVENTS",()=>js,"OPTIONAL_METHODS",()=>jq,"REQUIRED_EVENTS",()=>jr,"REQUIRED_METHODS",()=>jp,"default",()=>jG],737258);var b=a.i(427699),c=a.i(15388),d=a.i(673620),e=a.i(679628),f=a.i(741721);let g="2.23.2",h={getDocsUrl:({docsBaseUrl:a,docsPath:b="",docsSlug:c})=>b?`${a??"https://viem.sh"}${b}${c?`#${c}`:""}`:void 0,version:`viem@${g}`};class i extends Error{constructor(a,b={}){let c=b.cause instanceof i?b.cause.details:b.cause?.message?b.cause.message:b.details,d=b.cause instanceof i&&b.cause.docsPath||b.docsPath,e=h.getDocsUrl?.({...b,docsPath:d});super([a||"An error occurred.","",...b.metaMessages?[...b.metaMessages,""]:[],...e?[`Docs: ${e}`]:[],...c?[`Details: ${c}`]:[],...h.version?[`Version: ${h.version}`]:[]].join("\n"),b.cause?{cause:b.cause}:void 0),Object.defineProperty(this,"details",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"docsPath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metaMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"shortMessage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"version",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"BaseError"}),this.details=c,this.docsPath=d,this.metaMessages=b.metaMessages,this.name=b.name??this.name,this.shortMessage=a,this.version=g}walk(a){return function a(b,c){return c?.(b)?b:b&&"object"==typeof b&&"cause"in b&&void 0!==b.cause?a(b.cause,c):c?null:b}(this,a)}}function j(a,{strict:b=!0}={}){return!!a&&"string"==typeof a&&(b?/^0x[0-9a-fA-F]*$/.test(a):a.startsWith("0x"))}class k extends i{constructor({size:a,targetSize:b,type:c}){super(`${c.charAt(0).toUpperCase()}${c.slice(1).toLowerCase()} size (${a}) exceeds padding size (${b}).`,{name:"SizeExceedsPaddingSizeError"})}}function l(a,{dir:b,size:c=32}={}){return"string"==typeof a?function(a,{dir:b,size:c=32}={}){if(null===c)return a;let d=a.replace("0x","");if(d.length>2*c)throw new k({size:Math.ceil(d.length/2),targetSize:c,type:"hex"});return`0x${d["right"===b?"padEnd":"padStart"](2*c,"0")}`}(a,{dir:b,size:c}):function(a,{dir:b,size:c=32}={}){if(null===c)return a;if(a.length>c)throw new k({size:a.length,targetSize:c,type:"bytes"});let d=new Uint8Array(c);for(let e=0;e<c;e++){let f="right"===b;d[f?e:c-e-1]=a[f?e:a.length-e-1]}return d}(a,{dir:b,size:c})}class m extends i{constructor({max:a,min:b,signed:c,size:d,value:e}){super(`Number "${e}" is not in safe ${d?`${8*d}-bit ${c?"signed":"unsigned"} `:""}integer range ${a?`(${b} to ${a})`:`(above ${b})`}`,{name:"IntegerOutOfRangeError"})}}class n extends i{constructor({givenSize:a,maxSize:b}){super(`Size cannot exceed ${b} bytes. Given size: ${a} bytes.`,{name:"SizeOverflowError"})}}function o(a){return j(a,{strict:!1})?Math.ceil((a.length-2)/2):a.length}function p(a,{size:b}){if(o(a)>b)throw new n({givenSize:o(a),maxSize:b})}function q(a,b={}){let{signed:c}=b;b.size&&p(a,{size:b.size});let d=BigInt(a);if(!c)return d;let e=(a.length-2)/2;return d<=(1n<<8n*BigInt(e)-1n)-1n?d:d-BigInt(`0x${"f".padStart(2*e,"f")}`)-1n}let r=Array.from({length:256},(a,b)=>b.toString(16).padStart(2,"0"));function s(a,b={}){return"number"==typeof a||"bigint"==typeof a?u(a,b):"string"==typeof a?function(a,b={}){return t(v.encode(a),b)}(a,b):"boolean"==typeof a?function(a,b={}){let c=`0x${Number(a)}`;return"number"==typeof b.size?(p(c,{size:b.size}),l(c,{size:b.size})):c}(a,b):t(a,b)}function t(a,b={}){let c="";for(let b=0;b<a.length;b++)c+=r[a[b]];let d=`0x${c}`;return"number"==typeof b.size?(p(d,{size:b.size}),l(d,{dir:"right",size:b.size})):d}function u(a,b={}){let c,{signed:d,size:e}=b,f=BigInt(a);e?c=d?(1n<<8n*BigInt(e)-1n)-1n:2n**(8n*BigInt(e))-1n:"number"==typeof a&&(c=BigInt(Number.MAX_SAFE_INTEGER));let g="bigint"==typeof c&&d?-c-1n:0;if(c&&f>c||f<g){let b="bigint"==typeof a?"n":"";throw new m({max:c?`${c}${b}`:void 0,min:`${g}${b}`,signed:d,size:e,value:`${a}${b}`})}let h=`0x${(d&&f<0?(1n<<BigInt(8*e))+BigInt(f):f).toString(16)}`;return e?l(h,{size:e}):h}let v=new TextEncoder,w=new TextEncoder,x={zero:48,nine:57,A:65,F:70,a:97,f:102};function y(a){return a>=x.zero&&a<=x.nine?a-x.zero:a>=x.A&&a<=x.F?a-(x.A-10):a>=x.a&&a<=x.f?a-(x.a-10):void 0}function z(a,b={}){let c=a;b.size&&(p(c,{size:b.size}),c=l(c,{dir:"right",size:b.size}));let d=c.slice(2);d.length%2&&(d=`0${d}`);let e=d.length/2,f=new Uint8Array(e);for(let a=0,b=0;a<e;a++){let c=y(d.charCodeAt(b++)),e=y(d.charCodeAt(b++));if(void 0===c||void 0===e)throw new i(`Invalid byte sequence ("${d[b-2]}${d[b-1]}" in "${d}").`);f[a]=16*c+e}return f}function A(a,b={}){let c=w.encode(a);return"number"==typeof b.size?(p(c,{size:b.size}),l(c,{dir:"right",size:b.size})):c}var B=a.i(597754);let C=BigInt(0x100000000-1),D=BigInt(32);var E=a.i(665235);let F=[],G=[],H=[],I=BigInt(0),J=BigInt(1),K=BigInt(2),L=BigInt(7),M=BigInt(256),N=BigInt(113);for(let a=0,b=J,c=1,d=0;a<24;a++){[c,d]=[d,(2*c+3*d)%5],F.push(2*(5*d+c)),G.push((a+1)*(a+2)/2%64);let e=I;for(let a=0;a<7;a++)(b=(b<<J^(b>>L)*N)%M)&K&&(e^=J<<(J<<BigInt(a))-J);H.push(e)}let[O,P]=function(a,b=!1){let c=new Uint32Array(a.length),d=new Uint32Array(a.length);for(let e=0;e<a.length;e++){let{h:f,l:g}=function(a,b=!1){return b?{h:Number(a&C),l:Number(a>>D&C)}:{h:0|Number(a>>D&C),l:0|Number(a&C)}}(a[e],b);[c[e],d[e]]=[f,g]}return[c,d]}(H,!0),Q=(a,b,c)=>c>32?((a,b,c)=>b<<c-32|a>>>64-c)(a,b,c):((a,b,c)=>a<<c|b>>>32-c)(a,b,c),R=(a,b,c)=>c>32?((a,b,c)=>a<<c-32|b>>>64-c)(a,b,c):((a,b,c)=>b<<c|a>>>32-c)(a,b,c);class S extends E.Hash{constructor(a,b,c,d=!1,e=24){if(super(),this.blockLen=a,this.suffix=b,this.outputLen=c,this.enableXOF=d,this.rounds=e,this.pos=0,this.posOut=0,this.finished=!1,this.destroyed=!1,(0,B.anumber)(c),0>=this.blockLen||this.blockLen>=200)throw Error("Sha3 supports only keccak-f1600 function");this.state=new Uint8Array(200),this.state32=(0,E.u32)(this.state)}keccak(){E.isLE||(0,E.byteSwap32)(this.state32),function(a,b=24){let c=new Uint32Array(10);for(let d=24-b;d<24;d++){for(let b=0;b<10;b++)c[b]=a[b]^a[b+10]^a[b+20]^a[b+30]^a[b+40];for(let b=0;b<10;b+=2){let d=(b+8)%10,e=(b+2)%10,f=c[e],g=c[e+1],h=Q(f,g,1)^c[d],i=R(f,g,1)^c[d+1];for(let c=0;c<50;c+=10)a[b+c]^=h,a[b+c+1]^=i}let b=a[2],e=a[3];for(let c=0;c<24;c++){let d=G[c],f=Q(b,e,d),g=R(b,e,d),h=F[c];b=a[h],e=a[h+1],a[h]=f,a[h+1]=g}for(let b=0;b<50;b+=10){for(let d=0;d<10;d++)c[d]=a[b+d];for(let d=0;d<10;d++)a[b+d]^=~c[(d+2)%10]&c[(d+4)%10]}a[0]^=O[d],a[1]^=P[d]}c.fill(0)}(this.state32,this.rounds),E.isLE||(0,E.byteSwap32)(this.state32),this.posOut=0,this.pos=0}update(a){(0,B.aexists)(this);let{blockLen:b,state:c}=this,d=(a=(0,E.toBytes)(a)).length;for(let e=0;e<d;){let f=Math.min(b-this.pos,d-e);for(let b=0;b<f;b++)c[this.pos++]^=a[e++];this.pos===b&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;let{state:a,suffix:b,pos:c,blockLen:d}=this;a[c]^=b,(128&b)!=0&&c===d-1&&this.keccak(),a[d-1]^=128,this.keccak()}writeInto(a){(0,B.aexists)(this,!1),(0,B.abytes)(a),this.finish();let b=this.state,{blockLen:c}=this;for(let d=0,e=a.length;d<e;){this.posOut>=c&&this.keccak();let f=Math.min(c-this.posOut,e-d);a.set(b.subarray(this.posOut,this.posOut+f),d),this.posOut+=f,d+=f}return a}xofInto(a){if(!this.enableXOF)throw Error("XOF is not possible for this instance");return this.writeInto(a)}xof(a){return(0,B.anumber)(a),this.xofInto(new Uint8Array(a))}digestInto(a){if((0,B.aoutput)(a,this),this.finished)throw Error("digest() was already called");return this.writeInto(a),this.destroy(),a}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,this.state.fill(0)}_cloneInto(a){let{blockLen:b,suffix:c,outputLen:d,rounds:e,enableXOF:f}=this;return a||(a=new S(b,c,d,f,e)),a.state32.set(this.state32),a.pos=this.pos,a.posOut=this.posOut,a.finished=this.finished,a.rounds=e,a.suffix=c,a.outputLen=d,a.enableXOF=f,a.destroyed=this.destroyed,a}}let T=(0,E.wrapConstructor)(()=>new S(136,1,32));function U(a,b){let c=T(j(a,{strict:!1})?function(a,b={}){return"number"==typeof a||"bigint"==typeof a?z(u(a,b)):"boolean"==typeof a?function(a,b={}){let c=new Uint8Array(1);return(c[0]=Number(a),"number"==typeof b.size)?(p(c,{size:b.size}),l(c,{size:b.size})):c}(a,b):j(a)?z(a,b):A(a,b)}(a):a);return"bytes"===(b||"hex")?c:s(c)}class V extends Map{constructor(a){super(),Object.defineProperty(this,"maxSize",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxSize=a}get(a){let b=super.get(a);return super.has(a)&&void 0!==b&&(this.delete(a),super.set(a,b)),b}set(a,b){if(super.set(a,b),this.maxSize&&this.size>this.maxSize){let a=this.keys().next().value;a&&this.delete(a)}return this}}let W=new V(8192);async function X({hash:b,signature:c}){let d=j(b)?b:s(b),{secp256k1:e}=await a.A(482313),f=(()=>{if("object"==typeof c&&"r"in c&&"s"in c){let{r:a,s:b,v:d,yParity:f}=c,g=Y(Number(f??d));return new e.Signature(q(a),q(b)).addRecoveryBit(g)}let a=j(c)?c:s(c),b=Y(function(a,b={}){return Number(q(a,b))}(`0x${a.slice(130)}`));return e.Signature.fromCompact(a.substring(2,130)).addRecoveryBit(b)})().recoverPublicKey(d.substring(2)).toHex(!1);return`0x${f}`}function Y(a){if(0===a||1===a)return a;if(27===a)return 0;if(28===a)return 1;throw Error("Invalid yParityOrV value")}async function Z({hash:a,signature:b}){var c=await X({hash:a,signature:b});let d=U(`0x${c.substring(4)}`).substring(26);return function(a,b){if(W.has(`${a}.undefined`))return W.get(`${a}.${void 0}`);let c=b?`${b}${a.toLowerCase()}`:a.substring(2).toLowerCase(),d=U(A(c),"bytes"),e=(b?c.substring(`${b}0x`.length):c).split("");for(let a=0;a<40;a+=2)d[a>>1]>>4>=8&&e[a]&&(e[a]=e[a].toUpperCase()),(15&d[a>>1])>=8&&e[a+1]&&(e[a+1]=e[a+1].toUpperCase());let f=`0x${e.join("")}`;return W.set(`${a}.${b}`,f),f}(`0x${d}`)}var $=a.i(130934),_=a.i(832819);a.i(78125);var aa=a.i(282800),ab=a.i(864671),ac=a.i(60611),ad=a.i(73915);function ae(a){let[b,c]=a.split(":");return{namespace:b,reference:c}}function af(a,b=[]){let c=[];return Object.keys(a).forEach(d=>{if(b.length&&!b.includes(d))return;let e=a[d];c.push(...e.accounts)}),c}function ag(a,b){return a.includes(":")?[a]:b.chains||[]}var ah=Object.defineProperty,ai=Object.defineProperties,aj=Object.getOwnPropertyDescriptors,ak=Object.getOwnPropertySymbols,al=Object.prototype.hasOwnProperty,am=Object.prototype.propertyIsEnumerable,an=(a,b,c)=>b in a?ah(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c,ao=(a,b)=>{for(var c in b||(b={}))al.call(b,c)&&an(a,c,b[c]);if(ak)for(var c of ak(b))am.call(b,c)&&an(a,c,b[c]);return a};let ap={reactNative:"react-native",node:"node",browser:"browser",unknown:"unknown"};function aq(){return"u">typeof process&&"u">typeof process.versions&&"u">typeof process.versions.node}function ar(){return!(0,e.getDocument)()&&!!(0,e.getNavigator)()&&"ReactNative"===navigator.product}function as(){return!aq()&&!!(0,e.getNavigator)()&&!!(0,e.getDocument)()}function at(){return ar()?ap.reactNative:aq()?ap.node:as()?ap.browser:ap.unknown}function au(){var b;try{return ar()&&"u">typeof(null==a.g?void 0:a.g.Application)?null==(b=a.g.Application)?void 0:b.applicationId:void 0}catch{return}}function av(){return(0,f.getWindowMetadata)()||{name:"",description:"",url:"",icons:[""]}}function aw(b,d,f){let g=function(){if(at()===ap.reactNative&&"u">typeof(null==a.g?void 0:a.g.Platform)){let{OS:b,Version:c}=a.g.Platform;return[b,c].join("-")}let b=(0,c.detect)();if(null===b)return"unknown";let d=b.os?b.os.replace(" ","").toLowerCase():"unknown";return"browser"===b.type?[d,b.name,b.version].join("-"):[d,b.version].join("-")}(),h=function(){var a;let b=at();return b===ap.browser?[b,(null==(a=(0,e.getLocation)())?void 0:a.host)||"unknown"].join(":"):b}();return[[b,d].join("-"),["js",f].join("-"),g,h].join("/")}function ax(a,b){return a.filter(a=>b.includes(a)).length===a.length}function ay(a){return Object.fromEntries(a.entries())}function az(a){return new Map(Object.entries(a))}function aA(a=d.FIVE_MINUTES,b){let c,e,f,g,h=(0,d.toMiliseconds)(a||d.FIVE_MINUTES);return{resolve:a=>{f&&c&&(clearTimeout(f),c(a),g=Promise.resolve(a))},reject:a=>{f&&e&&(clearTimeout(f),e(a))},done:()=>new Promise((a,d)=>{if(g)return a(g);f=setTimeout(()=>{let a=Error(b);g=Promise.reject(a),d(a)},h),c=a,e=d})}}function aB(a,b,c){return new Promise(async(d,e)=>{let f=setTimeout(()=>e(Error(c)),b);try{let b=await a;d(b)}catch(a){e(a)}clearTimeout(f)})}function aC(a,b){if("string"==typeof b&&b.startsWith(`${a}:`))return b;if("topic"===a.toLowerCase()){if("string"!=typeof b)throw Error('Value must be "string" for expirer target type: topic');return`topic:${b}`}if("id"===a.toLowerCase()){if("number"!=typeof b)throw Error('Value must be "number" for expirer target type: id');return`id:${b}`}throw Error(`Unknown expirer target type: ${a}`)}function aD(a){let[b,c]=a.split(":"),d={id:void 0,topic:void 0};if("topic"===b&&"string"==typeof c)d.topic=c;else if("id"===b&&Number.isInteger(Number(c)))d.id=Number(c);else throw Error(`Invalid target, expected id:number or topic:string, got ${b}:${c}`);return d}function aE(a,b){return(0,d.fromMiliseconds)((b||Date.now())+(0,d.toMiliseconds)(a))}function aF(a){return Date.now()>=(0,d.toMiliseconds)(a)}function aG(a,b){return`${a}${b?`:${b}`:""}`}function aH(a=[],b=[]){return[...new Set([...a,...b])]}async function aI({id:b,topic:c,wcDeepLink:d}){var f,g;try{if(!d)return;let h="string"==typeof d?JSON.parse(d):d,i=h?.href;if("string"!=typeof i)return;let j=function(a,b,c){let d=`requestId=${b}&sessionTopic=${c}`;a.endsWith("/")&&(a=a.slice(0,-1));let e=`${a}`;if(a.startsWith("https://t.me")){let b=a.includes("?")?"&startapp=":"?startapp=";e=`${e}${b}${function(a,b=!1){let c=Buffer.from(a).toString("base64");return b?c.replace(/[=]/g,""):c}(d,!0)}`}else e=`${e}/wc?${d}`;return e}(i,b,c),k=at();if(k===ap.browser){let a;if(!(null!=(f=(0,e.getDocument)())&&f.hasFocus()))return void console.warn("Document does not have focus, skipping deeplink.");g=j,a="_self",!function(){try{return window.self!==window.top}catch{return!1}}()?(g.startsWith("https://")||g.startsWith("http://"))&&(a="_blank"):a="_top",window.open(g,a,"noreferrer noopener")}else k===ap.reactNative&&"u">typeof(null==a.g?void 0:a.g.Linking)&&await a.g.Linking.openURL(j)}catch(a){console.error(a)}}async function aJ(a,b){let c="";try{if(as()&&(c=localStorage.getItem(b)))return c;c=await a.getItem(b)}catch(a){console.error(a)}return c}function aK(a,b){if(!a.includes(b))return null;let c=a.split(/([&,?,=])/),d=c.indexOf(b);return c[d+2]}function aL(){return"u">typeof crypto&&null!=crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/gu,a=>{let b=16*Math.random()|0;return("x"===a?b:3&b|8).toString(16)})}function aM(){return"u">typeof process&&"true"===process.env.IS_VITEST}function aN(a){return Buffer.from(a,"base64").toString("utf-8")}function aO(a){if(!Number.isSafeInteger(a)||a<0)throw Error("positive integer expected, got "+a)}function aP(a,...b){if(!(a instanceof Uint8Array||ArrayBuffer.isView(a)&&"Uint8Array"===a.constructor.name))throw Error("Uint8Array expected");if(b.length>0&&!b.includes(a.length))throw Error("Uint8Array expected of length "+b+", got length="+a.length)}function aQ(a){if("function"!=typeof a||"function"!=typeof a.create)throw Error("Hash should be wrapped by utils.wrapConstructor");aO(a.outputLen),aO(a.blockLen)}function aR(a,b=!0){if(a.destroyed)throw Error("Hash instance has been destroyed");if(b&&a.finished)throw Error("Hash#digest() has already been called")}function aS(a,b){aP(a);let c=b.outputLen;if(a.length<c)throw Error("digestInto() expects output buffer of length at least "+c)}let aT=BigInt(0x100000000-1),aU=BigInt(32),aV="object"==typeof globalThis&&"crypto"in globalThis?globalThis.crypto:void 0;function aW(a){return new DataView(a.buffer,a.byteOffset,a.byteLength)}function aX(a,b){return a<<32-b|a>>>b}let aY=68===new Uint8Array(new Uint32Array([0x11223344]).buffer)[0];function aZ(a){for(let c=0;c<a.length;c++){var b;a[c]=(b=a[c])<<24&0xff000000|b<<8&0xff0000|b>>>8&65280|b>>>24&255}}function a$(a){return"string"==typeof a&&(a=function(a){if("string"!=typeof a)throw Error("utf8ToBytes expected string, got "+typeof a);return new Uint8Array(new TextEncoder().encode(a))}(a)),aP(a),a}class a_{clone(){return this._cloneInto()}}function a0(a){let b=b=>a().update(a$(b)).digest(),c=a();return b.outputLen=c.outputLen,b.blockLen=c.blockLen,b.create=()=>a(),b}function a1(a=32){if(aV&&"function"==typeof aV.getRandomValues)return aV.getRandomValues(new Uint8Array(a));if(aV&&"function"==typeof aV.randomBytes)return aV.randomBytes(a);throw Error("crypto.getRandomValues must be defined")}let a2=[],a3=[],a4=[],a5=BigInt(0),a6=BigInt(1),a7=BigInt(2),a8=BigInt(7),a9=BigInt(256),ba=BigInt(113);for(let a=0,b=a6,c=1,d=0;a<24;a++){[c,d]=[d,(2*c+3*d)%5],a2.push(2*(5*d+c)),a3.push((a+1)*(a+2)/2%64);let e=a5;for(let a=0;a<7;a++)(b=(b<<a6^(b>>a8)*ba)%a9)&a7&&(e^=a6<<(a6<<BigInt(a))-a6);a4.push(e)}let[bb,bc]=function(a,b=!1){let c=new Uint32Array(a.length),d=new Uint32Array(a.length);for(let e=0;e<a.length;e++){let{h:f,l:g}=function(a,b=!1){return b?{h:Number(a&aT),l:Number(a>>aU&aT)}:{h:0|Number(a>>aU&aT),l:0|Number(a&aT)}}(a[e],b);[c[e],d[e]]=[f,g]}return[c,d]}(a4,!0),bd=(a,b,c)=>c>32?((a,b,c)=>b<<c-32|a>>>64-c)(a,b,c):((a,b,c)=>a<<c|b>>>32-c)(a,b,c),be=(a,b,c)=>c>32?((a,b,c)=>a<<c-32|b>>>64-c)(a,b,c):((a,b,c)=>b<<c|a>>>32-c)(a,b,c);class bf extends a_{constructor(a,b,c,d=!1,e=24){if(super(),this.blockLen=a,this.suffix=b,this.outputLen=c,this.enableXOF=d,this.rounds=e,this.pos=0,this.posOut=0,this.finished=!1,this.destroyed=!1,aO(c),0>=this.blockLen||this.blockLen>=200)throw Error("Sha3 supports only keccak-f1600 function");this.state=new Uint8Array(200),this.state32=function(a){return new Uint32Array(a.buffer,a.byteOffset,Math.floor(a.byteLength/4))}(this.state)}keccak(){aY||aZ(this.state32),function(a,b=24){let c=new Uint32Array(10);for(let d=24-b;d<24;d++){for(let b=0;b<10;b++)c[b]=a[b]^a[b+10]^a[b+20]^a[b+30]^a[b+40];for(let b=0;b<10;b+=2){let d=(b+8)%10,e=(b+2)%10,f=c[e],g=c[e+1],h=bd(f,g,1)^c[d],i=be(f,g,1)^c[d+1];for(let c=0;c<50;c+=10)a[b+c]^=h,a[b+c+1]^=i}let b=a[2],e=a[3];for(let c=0;c<24;c++){let d=a3[c],f=bd(b,e,d),g=be(b,e,d),h=a2[c];b=a[h],e=a[h+1],a[h]=f,a[h+1]=g}for(let b=0;b<50;b+=10){for(let d=0;d<10;d++)c[d]=a[b+d];for(let d=0;d<10;d++)a[b+d]^=~c[(d+2)%10]&c[(d+4)%10]}a[0]^=bb[d],a[1]^=bc[d]}c.fill(0)}(this.state32,this.rounds),aY||aZ(this.state32),this.posOut=0,this.pos=0}update(a){aR(this);let{blockLen:b,state:c}=this,d=(a=a$(a)).length;for(let e=0;e<d;){let f=Math.min(b-this.pos,d-e);for(let b=0;b<f;b++)c[this.pos++]^=a[e++];this.pos===b&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;let{state:a,suffix:b,pos:c,blockLen:d}=this;a[c]^=b,(128&b)!=0&&c===d-1&&this.keccak(),a[d-1]^=128,this.keccak()}writeInto(a){aR(this,!1),aP(a),this.finish();let b=this.state,{blockLen:c}=this;for(let d=0,e=a.length;d<e;){this.posOut>=c&&this.keccak();let f=Math.min(c-this.posOut,e-d);a.set(b.subarray(this.posOut,this.posOut+f),d),this.posOut+=f,d+=f}return a}xofInto(a){if(!this.enableXOF)throw Error("XOF is not possible for this instance");return this.writeInto(a)}xof(a){return aO(a),this.xofInto(new Uint8Array(a))}digestInto(a){if(aS(a,this),this.finished)throw Error("digest() was already called");return this.writeInto(a),this.destroy(),a}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,this.state.fill(0)}_cloneInto(a){let{blockLen:b,suffix:c,outputLen:d,rounds:e,enableXOF:f}=this;return a||(a=new bf(b,c,d,f,e)),a.state32.set(this.state32),a.pos=this.pos,a.posOut=this.posOut,a.finished=this.finished,a.rounds=e,a.suffix=c,a.outputLen=d,a.enableXOF=f,a.destroyed=this.destroyed,a}}let bg=a0(()=>new bf(136,1,32));function bh(a){let b=`Ethereum Signed Message:
${a.length}`,c=new TextEncoder().encode(b+a);return"0x"+Buffer.from(bg(c)).toString("hex")}async function bi(a,b,c,d,e,f){switch(c.t){case"eip191":return await bj(a,b,c.s);case"eip1271":return await bk(a,b,c.s,d,e,f);default:throw Error(`verifySignature failed: Attempted to verify CacaoSignature with unknown type: ${c.t}`)}}async function bj(a,b,c){return(await Z({hash:bh(b),signature:c})).toLowerCase()===a.toLowerCase()}async function bk(a,b,c,d,e,f){let g=ae(d);if(!g.namespace||!g.reference)throw Error(`isValidEip1271Signature failed: chainId must be in CAIP-2 format, received: ${d}`);try{let g="0x1626ba7e",h=c.substring(2),i=bh(b).substring(2),j=g+i+"00000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000041"+h,k=await fetch(`${f||"https://rpc.walletconnect.org/v1"}/?chainId=${d}&projectId=${e}`,{method:"POST",body:JSON.stringify({id:Date.now()+Math.floor(1e3*Math.random()),jsonrpc:"2.0",method:"eth_call",params:[{to:a,data:j},"latest"]})}),{result:l}=await k.json();return!!l&&l.slice(0,g.length).toLowerCase()===g.toLowerCase()}catch(a){return console.error("isValidEip1271Signature: ",a),!1}}var bl=Object.defineProperty,bm=Object.defineProperties,bn=Object.getOwnPropertyDescriptors,bo=Object.getOwnPropertySymbols,bp=Object.prototype.hasOwnProperty,bq=Object.prototype.propertyIsEnumerable,br=(a,b,c)=>b in a?bl(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c;let bs=a=>a?.split(":"),bt=a=>{let b=a&&bs(a);if(b)return b[2]+":"+b[3]},bu=a=>{let b=a&&bs(a);if(b)return b.pop()};async function bv(a){let{cacao:b,projectId:c}=a,{s:d,p:e}=b,f=bw(e,e.iss),g=bu(e.iss);return await bi(g,f,d,bt(e.iss),c)}let bw=(a,b)=>{let c=`${a.domain} wants you to sign in with your Ethereum account:`,d=bu(b);if(!a.aud&&!a.uri)throw Error("Either `aud` or `uri` is required to construct the message");let e=a.statement||void 0,f=`URI: ${a.aud||a.uri}`,g=`Version: ${a.version}`,h=`Chain ID: ${(a=>{let b=a&&bs(a);if(b)return a.includes("did:pkh:")?b[3]:b[1]})(b)}`,i=`Nonce: ${a.nonce}`,j=`Issued At: ${a.iat}`,k=a.exp?`Expiration Time: ${a.exp}`:void 0,l=a.nbf?`Not Before: ${a.nbf}`:void 0,m=a.requestId?`Request ID: ${a.requestId}`:void 0,n=a.resources?`Resources:${a.resources.map(a=>`
- ${a}`).join("")}`:void 0,o=bC(a.resources);return o&&(e=function(a="",b){bx(b);let c="I further authorize the stated URI to perform the following actions on my behalf: ";if(a.includes(c))return a;let d=[],e=0;Object.keys(b.att).forEach(a=>{let c=Object.keys(b.att[a]).map(a=>({ability:a.split("/")[0],action:a.split("/")[1]}));c.sort((a,b)=>a.action.localeCompare(b.action));let f={};c.forEach(a=>{f[a.ability]||(f[a.ability]=[]),f[a.ability].push(a.action)});let g=Object.keys(f).map(b=>(e++,`(${e}) '${b}': '${f[b].join("', '")}' for '${a}'.`));d.push(g.join(", ").replace(".,","."))});let f=d.join(" "),g=`${c}${f}`;return`${a?a+" ":""}${g}`}(e,bz(o))),[c,d,"",e,"",f,g,h,i,j,k,l,m,n].filter(a=>null!=a).join(`
`)};function bx(a){if(!a)throw Error("No recap provided, value is undefined");if(!a.att)throw Error("No `att` property found");let b=Object.keys(a.att);if(!(null!=b&&b.length))throw Error("No resources found in `att` property");b.forEach(b=>{let c=a.att[b];if(Array.isArray(c)||"object"!=typeof c)throw Error(`Resource must be an object: ${b}`);if(!Object.keys(c).length)throw Error(`Resource object is empty: ${b}`);Object.keys(c).forEach(a=>{let b=c[a];if(!Array.isArray(b))throw Error(`Ability limits ${a} must be an array of objects, found: ${b}`);if(!b.length)throw Error(`Value of ${a} is empty array, must be an array with objects`);b.forEach(b=>{if("object"!=typeof b)throw Error(`Ability limits (${a}) must be an array of objects, found: ${b}`)})})})}function by(a){return bx(a),`urn:recap:${Buffer.from(JSON.stringify(a)).toString("base64").replace(/=/g,"")}`}function bz(a){var b;let c=(b=a.replace("urn:recap:",""),JSON.parse(Buffer.from(b,"base64").toString("utf-8")));return bx(c),c}function bA(a){var b;let c=bz(a);bx(c);let d=null==(b=c.att)?void 0:b.eip155;return d?Object.keys(d).map(a=>a.split("/")[1]):[]}function bB(a){let b=bz(a);bx(b);let c=[];return Object.values(b.att).forEach(a=>{Object.values(a).forEach(a=>{var b;null!=(b=a?.[0])&&b.chains&&c.push(a[0].chains)})}),[...new Set(c.flat())]}function bC(a){if(!a)return;let b=a?.[a.length-1];return b&&b.includes("urn:recap:")?b:void 0}function bD(a){if(!Number.isSafeInteger(a)||a<0)throw Error("positive integer expected, got "+a)}function bE(a){return a instanceof Uint8Array||ArrayBuffer.isView(a)&&"Uint8Array"===a.constructor.name}function bF(a,...b){if(!bE(a))throw Error("Uint8Array expected");if(b.length>0&&!b.includes(a.length))throw Error("Uint8Array expected of length "+b+", got length="+a.length)}function bG(a,b=!0){if(a.destroyed)throw Error("Hash instance has been destroyed");if(b&&a.finished)throw Error("Hash#digest() has already been called")}function bH(a){if("boolean"!=typeof a)throw Error(`boolean expected, not ${a}`)}let bI=a=>new Uint32Array(a.buffer,a.byteOffset,Math.floor(a.byteLength/4));if(68!==new Uint8Array(new Uint32Array([0x11223344]).buffer)[0])throw Error("Non little-endian hardware is not supported");function bJ(a){if("string"==typeof a)a=function(a){if("string"!=typeof a)throw Error("string expected");return new Uint8Array(new TextEncoder().encode(a))}(a);else if(bE(a))a=bM(a);else throw Error("Uint8Array expected, got "+typeof a);return a}function bK(a,b,c=!0){if(void 0===b)return new Uint8Array(a);if(b.length!==a)throw Error("invalid output length, expected "+a+", got: "+b.length);if(c&&b.byteOffset%4!=0)throw Error("invalid output, must be aligned");return b}function bL(a,b,c,d){if("function"==typeof a.setBigUint64)return a.setBigUint64(b,c,d);let e=BigInt(32),f=BigInt(0xffffffff),g=Number(c>>e&f),h=Number(c&f),i=4*!!d,j=4*!d;a.setUint32(b+i,g,d),a.setUint32(b+j,h,d)}function bM(a){return Uint8Array.from(a)}function bN(...a){for(let b=0;b<a.length;b++)a[b].fill(0)}let bO=a=>Uint8Array.from(a.split("").map(a=>a.charCodeAt(0))),bP=bO("expand 16-byte k"),bQ=bO("expand 32-byte k"),bR=bI(bP),bS=bI(bQ);function bT(a,b){return a<<b|a>>>32-b}function bU(a){return a.byteOffset%4==0}let bV=0x100000000-1,bW=new Uint32Array,bX=(a,b)=>255&a[b++]|(255&a[b++])<<8;class bY{constructor(a){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,bF(a=bJ(a),32);let b=bX(a,0),c=bX(a,2),d=bX(a,4),e=bX(a,6),f=bX(a,8),g=bX(a,10),h=bX(a,12),i=bX(a,14);this.r[0]=8191&b,this.r[1]=(b>>>13|c<<3)&8191,this.r[2]=(c>>>10|d<<6)&7939,this.r[3]=(d>>>7|e<<9)&8191,this.r[4]=(e>>>4|f<<12)&255,this.r[5]=f>>>1&8190,this.r[6]=(f>>>14|g<<2)&8191,this.r[7]=(g>>>11|h<<5)&8065,this.r[8]=(h>>>8|i<<8)&8191,this.r[9]=i>>>5&127;for(let b=0;b<8;b++)this.pad[b]=bX(a,16+2*b)}process(a,b,c=!1){let{h:d,r:e}=this,f=e[0],g=e[1],h=e[2],i=e[3],j=e[4],k=e[5],l=e[6],m=e[7],n=e[8],o=e[9],p=bX(a,b+0),q=bX(a,b+2),r=bX(a,b+4),s=bX(a,b+6),t=bX(a,b+8),u=bX(a,b+10),v=bX(a,b+12),w=bX(a,b+14),x=d[0]+(8191&p),y=d[1]+((p>>>13|q<<3)&8191),z=d[2]+((q>>>10|r<<6)&8191),A=d[3]+((r>>>7|s<<9)&8191),B=d[4]+((s>>>4|t<<12)&8191),C=d[5]+(t>>>1&8191),D=d[6]+((t>>>14|u<<2)&8191),E=d[7]+((u>>>11|v<<5)&8191),F=d[8]+((v>>>8|w<<8)&8191),G=d[9]+(w>>>5|2048*!c),H=0,I=0+x*f+5*o*y+5*n*z+5*m*A+5*l*B;H=I>>>13,I&=8191,I+=5*k*C+5*j*D+5*i*E+5*h*F+5*g*G,H+=I>>>13,I&=8191;let J=H+x*g+y*f+5*o*z+5*n*A+5*m*B;H=J>>>13,J&=8191,J+=5*l*C+5*k*D+5*j*E+5*i*F+5*h*G,H+=J>>>13,J&=8191;let K=H+x*h+y*g+z*f+5*o*A+5*n*B;H=K>>>13,K&=8191,K+=5*m*C+5*l*D+5*k*E+5*j*F+5*i*G,H+=K>>>13,K&=8191;let L=H+x*i+y*h+z*g+A*f+5*o*B;H=L>>>13,L&=8191,L+=5*n*C+5*m*D+5*l*E+5*k*F+5*j*G,H+=L>>>13,L&=8191;let M=H+x*j+y*i+z*h+A*g+B*f;H=M>>>13,M&=8191,M+=5*o*C+5*n*D+5*m*E+5*l*F+5*k*G,H+=M>>>13,M&=8191;let N=H+x*k+y*j+z*i+A*h+B*g;H=N>>>13,N&=8191,N+=C*f+5*o*D+5*n*E+5*m*F+5*l*G,H+=N>>>13,N&=8191;let O=H+x*l+y*k+z*j+A*i+B*h;H=O>>>13,O&=8191,O+=C*g+D*f+5*o*E+5*n*F+5*m*G,H+=O>>>13,O&=8191;let P=H+x*m+y*l+z*k+A*j+B*i;H=P>>>13,P&=8191,P+=C*h+D*g+E*f+5*o*F+5*n*G,H+=P>>>13,P&=8191;let Q=H+x*n+y*m+z*l+A*k+B*j;H=Q>>>13,Q&=8191,Q+=C*i+D*h+E*g+F*f+5*o*G,H+=Q>>>13,Q&=8191;let R=H+x*o+y*n+z*m+A*l+B*k;H=R>>>13,R&=8191,R+=C*j+D*i+E*h+F*g+G*f,H+=R>>>13,R&=8191,I=8191&(H=(H=(H<<2)+H|0)+I|0),H>>>=13,J+=H,d[0]=I,d[1]=J,d[2]=K,d[3]=L,d[4]=M,d[5]=N,d[6]=O,d[7]=P,d[8]=Q,d[9]=R}finalize(){let{h:a,pad:b}=this,c=new Uint16Array(10),d=a[1]>>>13;a[1]&=8191;for(let b=2;b<10;b++)a[b]+=d,d=a[b]>>>13,a[b]&=8191;a[0]+=5*d,d=a[0]>>>13,a[0]&=8191,a[1]+=d,d=a[1]>>>13,a[1]&=8191,a[2]+=d,c[0]=a[0]+5,d=c[0]>>>13,c[0]&=8191;for(let b=1;b<10;b++)c[b]=a[b]+d,d=c[b]>>>13,c[b]&=8191;c[9]-=8192;let e=(1^d)-1;for(let a=0;a<10;a++)c[a]&=e;e=~e;for(let b=0;b<10;b++)a[b]=a[b]&e|c[b];a[0]=(a[0]|a[1]<<13)&65535,a[1]=(a[1]>>>3|a[2]<<10)&65535,a[2]=(a[2]>>>6|a[3]<<7)&65535,a[3]=(a[3]>>>9|a[4]<<4)&65535,a[4]=(a[4]>>>12|a[5]<<1|a[6]<<14)&65535,a[5]=(a[6]>>>2|a[7]<<11)&65535,a[6]=(a[7]>>>5|a[8]<<8)&65535,a[7]=(a[8]>>>8|a[9]<<5)&65535;let f=a[0]+b[0];a[0]=65535&f;for(let c=1;c<8;c++)f=(a[c]+b[c]|0)+(f>>>16)|0,a[c]=65535&f;bN(c)}update(a){bG(this);let{buffer:b,blockLen:c}=this,d=(a=bJ(a)).length;for(let e=0;e<d;){let f=Math.min(c-this.pos,d-e);if(f===c){for(;c<=d-e;e+=c)this.process(a,e);continue}b.set(a.subarray(e,e+f),this.pos),this.pos+=f,e+=f,this.pos===c&&(this.process(b,0,!1),this.pos=0)}return this}destroy(){bN(this.h,this.r,this.buffer,this.pad)}digestInto(a){bG(this),function(a,b){bF(a);let c=b.outputLen;if(a.length<c)throw Error("digestInto() expects output buffer of length at least "+c)}(a,this),this.finished=!0;let{buffer:b,h:c}=this,{pos:d}=this;if(d){for(b[d++]=1;d<16;d++)b[d]=0;this.process(b,0,!0)}this.finalize();let e=0;for(let b=0;b<8;b++)a[e++]=c[b]>>>0,a[e++]=c[b]>>>8;return a}digest(){let{buffer:a,outputLen:b}=this;this.digestInto(a);let c=a.slice(0,b);return this.destroy(),c}}let bZ=function(a){let b=(b,c)=>a(c).update(bJ(b)).digest(),c=a(new Uint8Array(32));return b.outputLen=c.outputLen,b.blockLen=c.blockLen,b.create=b=>a(b),b}(a=>new bY(a)),b$=function(a,b){let{allowShortKeys:c,extendNonceFn:d,counterLength:e,counterRight:f,rounds:g}=function(a,b){if(null==b||"object"!=typeof b)throw Error("options must be defined");return Object.assign(a,b)}({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},b);if("function"!=typeof a)throw Error("core must be a function");return bD(e),bD(g),bH(f),bH(c),(b,h,i,j,k=0)=>{bF(b),bF(h),bF(i);let l=i.length;if(void 0===j&&(j=new Uint8Array(l)),bF(j),bD(k),k<0||k>=bV)throw Error("arx: counter overflow");if(j.length<l)throw Error(`arx: output (${j.length}) is shorter than data (${l})`);let m=[],n=b.length,o,p;if(32===n)m.push(o=bM(b)),p=bS;else if(16===n&&c)(o=new Uint8Array(32)).set(b),o.set(b,16),p=bR,m.push(o);else throw Error(`arx: invalid 32-byte key, got length=${n}`);bU(h)||m.push(h=bM(h));let q=bI(o);if(d){if(24!==h.length)throw Error("arx: extended nonce must be 24 bytes");d(p,q,bI(h.subarray(0,16)),q),h=h.subarray(16)}let r=16-e;if(r!==h.length)throw Error(`arx: nonce must be ${r} or 16 bytes`);if(12!==r){let a=new Uint8Array(12);a.set(h,f?0:12-h.length),h=a,m.push(h)}return function(a,b,c,d,e,f,g,h){let i=e.length,j=new Uint8Array(64),k=bI(j),l=bU(e)&&bU(f),m=l?bI(e):bW,n=l?bI(f):bW;for(let o=0;o<i;g++){if(a(b,c,d,k,g,h),g>=bV)throw Error("arx: counter overflow");let p=Math.min(64,i-o);if(l&&64===p){let a=o/4;if(o%4!=0)throw Error("arx: invalid block position");for(let b=0,c;b<16;b++)n[c=a+b]=m[c]^k[b];o+=64;continue}for(let a=0,b;a<p;a++)f[b=o+a]=e[b]^j[a];o+=p}}(a,p,q,bI(h),i,j,k,g),bN(...m),j}}(function(a,b,c,d,e,f=20){let g=a[0],h=a[1],i=a[2],j=a[3],k=b[0],l=b[1],m=b[2],n=b[3],o=b[4],p=b[5],q=b[6],r=b[7],s=c[0],t=c[1],u=c[2],v=g,w=h,x=i,y=j,z=k,A=l,B=m,C=n,D=o,E=p,F=q,G=r,H=e,I=s,J=t,K=u;for(let a=0;a<f;a+=2)D=D+(H=bT(H^(v=v+z|0),16))|0,v=v+(z=bT(z^D,12))|0,D=D+(H=bT(H^v,8))|0,z=bT(z^D,7),E=E+(I=bT(I^(w=w+A|0),16))|0,w=w+(A=bT(A^E,12))|0,E=E+(I=bT(I^w,8))|0,A=bT(A^E,7),F=F+(J=bT(J^(x=x+B|0),16))|0,x=x+(B=bT(B^F,12))|0,F=F+(J=bT(J^x,8))|0,B=bT(B^F,7),G=G+(K=bT(K^(y=y+C|0),16))|0,y=y+(C=bT(C^G,12))|0,G=G+(K=bT(K^y,8))|0,C=bT(C^G,7),F=F+(K=bT(K^(v=v+A|0),16))|0,v=v+(A=bT(A^F,12))|0,F=F+(K=bT(K^v,8))|0,A=bT(A^F,7),G=G+(H=bT(H^(w=w+B|0),16))|0,w=w+(B=bT(B^G,12))|0,G=G+(H=bT(H^w,8))|0,B=bT(B^G,7),D=D+(I=bT(I^(x=x+C|0),16))|0,x=x+(C=bT(C^D,12))|0,D=D+(I=bT(I^x,8))|0,C=bT(C^D,7),E=E+(J=bT(J^(y=y+z|0),16))|0,y=y+(z=bT(z^E,12))|0,E=E+(J=bT(J^y,8))|0,z=bT(z^E,7);let L=0;d[L++]=g+v|0,d[L++]=h+w|0,d[L++]=i+x|0,d[L++]=j+y|0,d[L++]=k+z|0,d[L++]=l+A|0,d[L++]=m+B|0,d[L++]=n+C|0,d[L++]=o+D|0,d[L++]=p+E|0,d[L++]=q+F|0,d[L++]=r+G|0,d[L++]=e+H|0,d[L++]=s+I|0,d[L++]=t+J|0,d[L++]=u+K|0},{counterRight:!1,counterLength:4,allowShortKeys:!1}),b_=new Uint8Array(16),b0=(a,b)=>{a.update(b);let c=b.length%16;c&&a.update(b_.subarray(c))},b1=new Uint8Array(32);function b2(a,b,c,d,e){let f=a(b,c,b1),g=bZ.create(f);e&&b0(g,e),b0(g,d);let h=new Uint8Array(16),i=new DataView(h.buffer,h.byteOffset,h.byteLength);bL(i,0,BigInt(e?e.length:0),!0),bL(i,8,BigInt(d.length),!0),g.update(h);let j=g.digest();return bN(f,h),j}let b3=((a,b)=>{function c(d,...e){if(bF(d),void 0!==a.nonceLength){let b=e[0];if(!b)throw Error("nonce / iv required");a.varSizeNonce?bF(b):bF(b,a.nonceLength)}let f=a.tagLength;f&&void 0!==e[1]&&bF(e[1]);let g=b(d,...e),h=(a,b)=>{if(void 0!==b){if(2!==a)throw Error("cipher output not supported");bF(b)}},i=!1;return{encrypt(a,b){if(i)throw Error("cannot encrypt() twice with same key + nonce");return i=!0,bF(a),h(g.encrypt.length,b),g.encrypt(a,b)},decrypt(a,b){if(bF(a),f&&a.length<f)throw Error("invalid ciphertext length: smaller than tagLength="+f);return h(g.decrypt.length,b),g.decrypt(a,b)}}}return Object.assign(c,a),c})({blockSize:64,nonceLength:12,tagLength:16},(a=>(b,c,d)=>({encrypt(e,f){let g=e.length;(f=bK(g+16,f,!1)).set(e);let h=f.subarray(0,-16);a(b,c,h,h,1);let i=b2(a,b,c,h,d);return f.set(i,g),bN(i),f},decrypt(e,f){f=bK(e.length-16,f,!1);let g=e.subarray(0,-16),h=e.subarray(-16),i=b2(a,b,c,g,d);if(!function(a,b){if(a.length!==b.length)return!1;let c=0;for(let d=0;d<a.length;d++)c|=a[d]^b[d];return 0===c}(h,i))throw Error("invalid tag");return f.set(e.subarray(0,-16)),a(b,c,f,f,1),bN(i),f}}))(b$));class b4 extends a_{constructor(a,b){super(),this.finished=!1,this.destroyed=!1,aQ(a);let c=a$(b);if(this.iHash=a.create(),"function"!=typeof this.iHash.update)throw Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let d=this.blockLen,e=new Uint8Array(d);e.set(c.length>d?a.create().update(c).digest():c);for(let a=0;a<e.length;a++)e[a]^=54;this.iHash.update(e),this.oHash=a.create();for(let a=0;a<e.length;a++)e[a]^=106;this.oHash.update(e),e.fill(0)}update(a){return aR(this),this.iHash.update(a),this}digestInto(a){aR(this),aP(a,this.outputLen),this.finished=!0,this.iHash.digestInto(a),this.oHash.update(a),this.oHash.digestInto(a),this.destroy()}digest(){let a=new Uint8Array(this.oHash.outputLen);return this.digestInto(a),a}_cloneInto(a){a||(a=Object.create(Object.getPrototypeOf(this),{}));let{oHash:b,iHash:c,finished:d,destroyed:e,blockLen:f,outputLen:g}=this;return a.finished=d,a.destroyed=e,a.blockLen=f,a.outputLen=g,a.oHash=b._cloneInto(a.oHash),a.iHash=c._cloneInto(a.iHash),a}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}let b5=(a,b,c)=>new b4(a,b).update(c).digest();b5.create=(a,b)=>new b4(a,b);let b6=new Uint8Array([0]),b7=new Uint8Array;class b8 extends a_{constructor(a,b,c,d){super(),this.blockLen=a,this.outputLen=b,this.padOffset=c,this.isLE=d,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(a),this.view=aW(this.buffer)}update(a){aR(this);let{view:b,buffer:c,blockLen:d}=this,e=(a=a$(a)).length;for(let f=0;f<e;){let g=Math.min(d-this.pos,e-f);if(g===d){let b=aW(a);for(;d<=e-f;f+=d)this.process(b,f);continue}c.set(a.subarray(f,f+g),this.pos),this.pos+=g,f+=g,this.pos===d&&(this.process(b,0),this.pos=0)}return this.length+=a.length,this.roundClean(),this}digestInto(a){aR(this),aS(a,this),this.finished=!0;let{buffer:b,view:c,blockLen:d,isLE:e}=this,{pos:f}=this;b[f++]=128,this.buffer.subarray(f).fill(0),this.padOffset>d-f&&(this.process(c,0),f=0);for(let a=f;a<d;a++)b[a]=0;(function(a,b,c,d){if("function"==typeof a.setBigUint64)return a.setBigUint64(b,c,d);let e=BigInt(32),f=BigInt(0xffffffff),g=Number(c>>e&f),h=Number(c&f),i=4*!!d,j=4*!d;a.setUint32(b+i,g,d),a.setUint32(b+j,h,d)})(c,d-8,BigInt(8*this.length),e),this.process(c,0);let g=aW(a),h=this.outputLen;if(h%4)throw Error("_sha2: outputLen should be aligned to 32bit");let i=h/4,j=this.get();if(i>j.length)throw Error("_sha2: outputLen bigger than state");for(let a=0;a<i;a++)g.setUint32(4*a,j[a],e)}digest(){let{buffer:a,outputLen:b}=this;this.digestInto(a);let c=a.slice(0,b);return this.destroy(),c}_cloneInto(a){a||(a=new this.constructor),a.set(...this.get());let{blockLen:b,buffer:c,length:d,finished:e,destroyed:f,pos:g}=this;return a.length=d,a.pos=g,a.finished=e,a.destroyed=f,d%b&&a.buffer.set(c),a}}let b9=new Uint32Array([0x428a2f98,0x71374491,0xb5c0fbcf,0xe9b5dba5,0x3956c25b,0x59f111f1,0x923f82a4,0xab1c5ed5,0xd807aa98,0x12835b01,0x243185be,0x550c7dc3,0x72be5d74,0x80deb1fe,0x9bdc06a7,0xc19bf174,0xe49b69c1,0xefbe4786,0xfc19dc6,0x240ca1cc,0x2de92c6f,0x4a7484aa,0x5cb0a9dc,0x76f988da,0x983e5152,0xa831c66d,0xb00327c8,0xbf597fc7,0xc6e00bf3,0xd5a79147,0x6ca6351,0x14292967,0x27b70a85,0x2e1b2138,0x4d2c6dfc,0x53380d13,0x650a7354,0x766a0abb,0x81c2c92e,0x92722c85,0xa2bfe8a1,0xa81a664b,0xc24b8b70,0xc76c51a3,0xd192e819,0xd6990624,0xf40e3585,0x106aa070,0x19a4c116,0x1e376c08,0x2748774c,0x34b0bcb5,0x391c0cb3,0x4ed8aa4a,0x5b9cca4f,0x682e6ff3,0x748f82ee,0x78a5636f,0x84c87814,0x8cc70208,0x90befffa,0xa4506ceb,0xbef9a3f7,0xc67178f2]),ca=new Uint32Array([0x6a09e667,0xbb67ae85,0x3c6ef372,0xa54ff53a,0x510e527f,0x9b05688c,0x1f83d9ab,0x5be0cd19]),cb=new Uint32Array(64);class cc extends b8{constructor(){super(64,32,8,!1),this.A=0|ca[0],this.B=0|ca[1],this.C=0|ca[2],this.D=0|ca[3],this.E=0|ca[4],this.F=0|ca[5],this.G=0|ca[6],this.H=0|ca[7]}get(){let{A:a,B:b,C:c,D:d,E:e,F:f,G:g,H:h}=this;return[a,b,c,d,e,f,g,h]}set(a,b,c,d,e,f,g,h){this.A=0|a,this.B=0|b,this.C=0|c,this.D=0|d,this.E=0|e,this.F=0|f,this.G=0|g,this.H=0|h}process(a,b){for(let c=0;c<16;c++,b+=4)cb[c]=a.getUint32(b,!1);for(let a=16;a<64;a++){let b=cb[a-15],c=cb[a-2],d=aX(b,7)^aX(b,18)^b>>>3,e=aX(c,17)^aX(c,19)^c>>>10;cb[a]=e+cb[a-7]+d+cb[a-16]|0}let{A:c,B:d,C:e,D:f,E:g,F:h,G:i,H:j}=this;for(let a=0;a<64;a++){var k,l,m,n;let b=j+(aX(g,6)^aX(g,11)^aX(g,25))+((k=g)&h^~k&i)+b9[a]+cb[a]|0,o=(aX(c,2)^aX(c,13)^aX(c,22))+((l=c)&(m=d)^l&(n=e)^m&n)|0;j=i,i=h,h=g,g=f+b|0,f=e,e=d,d=c,c=b+o|0}c=c+this.A|0,d=d+this.B|0,e=e+this.C|0,f=f+this.D|0,g=g+this.E|0,h=h+this.F|0,i=i+this.G|0,j=j+this.H|0,this.set(c,d,e,f,g,h,i,j)}roundClean(){cb.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}}let cd=a0(()=>new cc),ce=BigInt(0),cf=BigInt(1),cg=BigInt(2);function ch(a){return a instanceof Uint8Array||ArrayBuffer.isView(a)&&"Uint8Array"===a.constructor.name}function ci(a){if(!ch(a))throw Error("Uint8Array expected")}function cj(a,b){if("boolean"!=typeof b)throw Error(a+" boolean expected, got "+b)}let ck=Array.from({length:256},(a,b)=>b.toString(16).padStart(2,"0"));function cl(a){ci(a);let b="";for(let c=0;c<a.length;c++)b+=ck[a[c]];return b}function cm(a){let b=a.toString(16);return 1&b.length?"0"+b:b}function cn(a){if("string"!=typeof a)throw Error("hex string expected, got "+typeof a);return""===a?ce:BigInt("0x"+a)}let co={_0:48,_9:57,A:65,F:70,a:97,f:102};function cp(a){return a>=co._0&&a<=co._9?a-co._0:a>=co.A&&a<=co.F?a-(co.A-10):a>=co.a&&a<=co.f?a-(co.a-10):void 0}function cq(a){if("string"!=typeof a)throw Error("hex string expected, got "+typeof a);let b=a.length,c=b/2;if(b%2)throw Error("hex string expected, got unpadded hex of length "+b);let d=new Uint8Array(c);for(let b=0,e=0;b<c;b++,e+=2){let c=cp(a.charCodeAt(e)),f=cp(a.charCodeAt(e+1));if(void 0===c||void 0===f)throw Error('hex string expected, got non-hex character "'+(a[e]+a[e+1])+'" at index '+e);d[b]=16*c+f}return d}function cr(a){return cn(cl(a))}function cs(a){return ci(a),cn(cl(Uint8Array.from(a).reverse()))}function ct(a,b){return cq(a.toString(16).padStart(2*b,"0"))}function cu(a,b){return ct(a,b).reverse()}function cv(a,b,c){let d;if("string"==typeof b)try{d=cq(b)}catch(b){throw Error(a+" must be hex string or Uint8Array, cause: "+b)}else if(ch(b))d=Uint8Array.from(b);else throw Error(a+" must be hex string or Uint8Array");let e=d.length;if("number"==typeof c&&e!==c)throw Error(a+" of length "+c+" expected, got "+e);return d}function cw(...a){let b=0;for(let c=0;c<a.length;c++){let d=a[c];ci(d),b+=d.length}let c=new Uint8Array(b);for(let b=0,d=0;b<a.length;b++){let e=a[b];c.set(e,d),d+=e.length}return c}let cx=a=>"bigint"==typeof a&&ce<=a;function cy(a,b,c){return cx(a)&&cx(b)&&cx(c)&&b<=a&&a<c}function cz(a,b,c,d){if(!cy(b,c,d))throw Error("expected valid "+a+": "+c+" <= n < "+d+", got "+b)}function cA(a){let b;for(b=0;a>ce;a>>=cf,b+=1);return b}let cB=a=>(cg<<BigInt(a-1))-cf,cC=a=>new Uint8Array(a),cD=a=>Uint8Array.from(a);function cE(a,b,c){if("number"!=typeof a||a<2)throw Error("hashLen must be a number");if("number"!=typeof b||b<2)throw Error("qByteLen must be a number");if("function"!=typeof c)throw Error("hmacFn must be a function");let d=cC(a),e=cC(a),f=0,g=()=>{d.fill(1),e.fill(0),f=0},h=(...a)=>c(e,d,...a),i=(a=cC())=>{e=h(cD([0]),a),d=h(),0!==a.length&&(e=h(cD([1]),a),d=h())},j=()=>{if(f++>=1e3)throw Error("drbg: tried 1000 values");let a=0,c=[];for(;a<b;){let b=(d=h()).slice();c.push(b),a+=d.length}return cw(...c)};return(a,b)=>{let c;for(g(),i(a);!(c=b(j()));)i();return g(),c}}let cF={bigint:a=>"bigint"==typeof a,function:a=>"function"==typeof a,boolean:a=>"boolean"==typeof a,string:a=>"string"==typeof a,stringOrUint8Array:a=>"string"==typeof a||ch(a),isSafeInteger:a=>Number.isSafeInteger(a),array:a=>Array.isArray(a),field:(a,b)=>b.Fp.isValid(a),hash:a=>"function"==typeof a&&Number.isSafeInteger(a.outputLen)};function cG(a,b,c={}){let d=(b,c,d)=>{let e=cF[c];if("function"!=typeof e)throw Error("invalid validator function");let f=a[b];if(!(d&&void 0===f)&&!e(f,a))throw Error("param "+String(b)+" is invalid. Expected "+c+", got "+f)};for(let[a,c]of Object.entries(b))d(a,c,!1);for(let[a,b]of Object.entries(c))d(a,b,!0);return a}function cH(a){let b=new WeakMap;return(c,...d)=>{let e=b.get(c);if(void 0!==e)return e;let f=a(c,...d);return b.set(c,f),f}}var cI=Object.freeze({__proto__:null,isBytes:ch,abytes:ci,abool:cj,bytesToHex:cl,numberToHexUnpadded:cm,hexToNumber:cn,hexToBytes:cq,bytesToNumberBE:cr,bytesToNumberLE:cs,numberToBytesBE:ct,numberToBytesLE:cu,numberToVarBytesBE:function(a){return cq(cm(a))},ensureBytes:cv,concatBytes:cw,equalBytes:function(a,b){if(a.length!==b.length)return!1;let c=0;for(let d=0;d<a.length;d++)c|=a[d]^b[d];return 0===c},utf8ToBytes:function(a){if("string"!=typeof a)throw Error("string expected");return new Uint8Array(new TextEncoder().encode(a))},inRange:cy,aInRange:cz,bitLen:cA,bitGet:function(a,b){return a>>BigInt(b)&cf},bitSet:function(a,b,c){return a|(c?cf:ce)<<BigInt(b)},bitMask:cB,createHmacDrbg:cE,validateObject:cG,notImplemented:()=>{throw Error("not implemented")},memoized:cH});let cJ=BigInt(0),cK=BigInt(1),cL=BigInt(2),cM=BigInt(3),cN=BigInt(4),cO=BigInt(5),cP=BigInt(8);function cQ(a,b){let c=a%b;return c>=cJ?c:b+c}function cR(a,b,c){if(b<cJ)throw Error("invalid exponent, negatives unsupported");if(c<=cJ)throw Error("invalid modulus");if(c===cK)return cJ;let d=cK;for(;b>cJ;)b&cK&&(d=d*a%c),a=a*a%c,b>>=cK;return d}function cS(a,b,c){let d=a;for(;b-- >cJ;)d*=d,d%=c;return d}function cT(a,b){if(a===cJ)throw Error("invert: expected non-zero number");if(b<=cJ)throw Error("invert: expected positive modulus, got "+b);let c=cQ(a,b),d=b,e=cJ,f=cK;for(;c!==cJ;){let a=d/c,b=d%c,g=e-f*a;d=c,c=b,e=f,f=g}if(d!==cK)throw Error("invert: does not exist");return cQ(e,b)}let cU=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function cV(a,b){let c=void 0!==b?b:a.toString(2).length,d=Math.ceil(c/8);return{nBitLength:c,nByteLength:d}}function cW(a,b,c=!1,d={}){let e;if(a<=cJ)throw Error("invalid field: expected ORDER > 0, got "+a);let{nBitLength:f,nByteLength:g}=cV(a,b);if(g>2048)throw Error("invalid field: expected ORDER of <= 2048 bytes");let h=Object.freeze({ORDER:a,isLE:c,BITS:f,BYTES:g,MASK:cB(f),ZERO:cJ,ONE:cK,create:b=>cQ(b,a),isValid:b=>{if("bigint"!=typeof b)throw Error("invalid field element: expected bigint, got "+typeof b);return cJ<=b&&b<a},is0:a=>a===cJ,isOdd:a=>(a&cK)===cK,neg:b=>cQ(-b,a),eql:(a,b)=>a===b,sqr:b=>cQ(b*b,a),add:(b,c)=>cQ(b+c,a),sub:(b,c)=>cQ(b-c,a),mul:(b,c)=>cQ(b*c,a),pow:(a,b)=>(function(a,b,c){if(c<cJ)throw Error("invalid exponent, negatives unsupported");if(c===cJ)return a.ONE;if(c===cK)return b;let d=a.ONE,e=b;for(;c>cJ;)c&cK&&(d=a.mul(d,e)),e=a.sqr(e),c>>=cK;return d})(h,a,b),div:(b,c)=>cQ(b*cT(c,a),a),sqrN:a=>a*a,addN:(a,b)=>a+b,subN:(a,b)=>a-b,mulN:(a,b)=>a*b,inv:b=>cT(b,a),sqrt:d.sqrt||(b=>(e||(e=function(a){if(a%cN===cM){let b=(a+cK)/cN;return function(a,c){let d=a.pow(c,b);if(!a.eql(a.sqr(d),c))throw Error("Cannot find square root");return d}}if(a%cP===cO){let b=(a-cO)/cP;return function(a,c){let d=a.mul(c,cL),e=a.pow(d,b),f=a.mul(c,e),g=a.mul(a.mul(f,cL),e),h=a.mul(f,a.sub(g,a.ONE));if(!a.eql(a.sqr(h),c))throw Error("Cannot find square root");return h}}return function(a){let b,c,d,e=(a-cK)/cL;for(b=a-cK,c=0;b%cL===cJ;b/=cL,c++);for(d=cL;d<a&&cR(d,e,a)!==a-cK;d++)if(d>1e3)throw Error("Cannot find square root: likely non-prime P");if(1===c){let b=(a+cK)/cN;return function(a,c){let d=a.pow(c,b);if(!a.eql(a.sqr(d),c))throw Error("Cannot find square root");return d}}let f=(b+cK)/cL;return function(a,g){if(a.pow(g,e)===a.neg(a.ONE))throw Error("Cannot find square root");let h=c,i=a.pow(a.mul(a.ONE,d),b),j=a.pow(g,f),k=a.pow(g,b);for(;!a.eql(k,a.ONE);){if(a.eql(k,a.ZERO))return a.ZERO;let b=1;for(let c=a.sqr(k);b<h&&!a.eql(c,a.ONE);b++)c=a.sqr(c);let c=a.pow(i,cK<<BigInt(h-b-1));i=a.sqr(c),j=a.mul(j,c),k=a.mul(k,i),h=b}return j}}(a)}(a)),e(h,b))),invertBatch:a=>(function(a,b){let c=Array(b.length),d=b.reduce((b,d,e)=>a.is0(d)?b:(c[e]=b,a.mul(b,d)),a.ONE),e=a.inv(d);return b.reduceRight((b,d,e)=>a.is0(d)?b:(c[e]=a.mul(b,c[e]),a.mul(b,d)),e),c})(h,a),cmov:(a,b,c)=>c?b:a,toBytes:a=>c?cu(a,g):ct(a,g),fromBytes:a=>{if(a.length!==g)throw Error("Field.fromBytes: expected "+g+" bytes, got "+a.length);return c?cs(a):cr(a)}});return Object.freeze(h)}function cX(a){if("bigint"!=typeof a)throw Error("field order must be bigint");return Math.ceil(a.toString(2).length/8)}function cY(a){let b=cX(a);return b+Math.ceil(b/2)}let cZ=BigInt(0),c$=BigInt(1);function c_(a,b){let c=b.negate();return a?c:b}function c0(a,b){if(!Number.isSafeInteger(a)||a<=0||a>b)throw Error("invalid window size, expected [1.."+b+"], got W="+a)}function c1(a,b){return c0(a,b),{windows:Math.ceil(b/a)+1,windowSize:2**(a-1)}}let c2=new WeakMap,c3=new WeakMap;function c4(a){return c3.get(a)||1}function c5(a){return cG(a.Fp,cU.reduce((a,b)=>(a[b]="function",a),{ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"})),cG(a,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...cV(a.n,a.nBitLength),...a,p:a.Fp.ORDER})}BigInt(0),BigInt(1),BigInt(2),BigInt(8);let c6=BigInt(0),c7=BigInt(1),c8=BigInt("57896044618658097711785492504343953926634992332820282019728792003956564819949");BigInt(0);let c9=BigInt(1),da=BigInt(2),db=BigInt(3),dc=BigInt(5);BigInt(8);let dd=function(a){let b=(cG(a,{a:"bigint"},{montgomeryBits:"isSafeInteger",nByteLength:"isSafeInteger",adjustScalarBytes:"function",domain:"function",powPminus2:"function",Gu:"bigint"}),Object.freeze({...a})),{P:c}=b,d=a=>cQ(a,c),e=b.montgomeryBits,f=Math.ceil(e/8),g=b.nByteLength,h=b.adjustScalarBytes||(a=>a),i=b.powPminus2||(a=>cR(a,c-BigInt(2),c));function j(a,b,c){let e=d(a*(b-c));return[b=d(b-e),c=d(c+e)]}let k=(b.a-BigInt(2))/BigInt(4);function l(a,b){let l=function(a,b){cz("u",a,c6,c),cz("scalar",b,c6,c);let f=c7,g=c6,h=a,l=c7,m=c6,n;for(let c=BigInt(e-1);c>=c6;c--){let e=b>>c&c7;m^=e,f=(n=j(m,f,h))[0],h=n[1],g=(n=j(m,g,l))[0],l=n[1],m=e;let i=f+g,o=d(i*i),p=f-g,q=d(p*p),r=o-q,s=h+l,t=d((h-l)*i),u=d(s*p),v=t+u,w=t-u;h=d(v*v),l=d(a*d(w*w)),f=d(o*q),g=d(r*(o+d(k*r)))}return f=(n=j(m,f,h))[0],h=n[1],g=(n=j(m,g,l))[0],l=n[1],d(f*i(g))}(function(a){let b=cv("u coordinate",a,f);return 32===g&&(b[31]&=127),cs(b)}(b),function(a){let b=cv("scalar",a),c=b.length;if(c!==f&&c!==g)throw Error("invalid scalar, expected "+(""+f+" or ")+g+" bytes, got "+c);return cs(h(b))}(a));if(l===c6)throw Error("invalid private or public key received");return cu(d(l),f)}let m=cu(d(b.Gu),f);function n(a){return l(a,m)}return{scalarMult:l,scalarMultBase:n,getSharedSecret:(a,b)=>l(a,b),getPublicKey:a=>n(a),utils:{randomPrivateKey:()=>b.randomBytes(b.nByteLength)},GuBytes:m}}({P:c8,a:BigInt(486662),montgomeryBits:255,nByteLength:32,Gu:BigInt(9),powPminus2:a=>{let{pow_p_5_8:b,b2:c}=function(a){let b=BigInt(10),c=BigInt(20),d=BigInt(40),e=BigInt(80),f=a*a%c8*a%c8,g=cS(f,da,c8)*f%c8,h=cS(g,c9,c8)*a%c8,i=cS(h,dc,c8)*h%c8,j=cS(i,b,c8)*i%c8,k=cS(j,c,c8)*j%c8,l=cS(k,d,c8)*k%c8,m=cS(l,e,c8)*l%c8,n=cS(m,e,c8)*l%c8,o=cS(n,b,c8)*i%c8;return{pow_p_5_8:cS(o,da,c8)*a%c8,b2:f}}(a);return cQ(cS(b,db,c8)*c,c8)},adjustScalarBytes:function(a){return a[0]&=248,a[31]&=127,a[31]|=64,a},randomBytes:a1});function de(a){void 0!==a.lowS&&cj("lowS",a.lowS),void 0!==a.prehash&&cj("prehash",a.prehash)}let{bytesToNumberBE:df,hexToBytes:dg}=cI,dh={Err:class extends Error{constructor(a=""){super(a)}},_tlv:{encode:(a,b)=>{let{Err:c}=dh;if(a<0||a>256)throw new c("tlv.encode: wrong tag");if(1&b.length)throw new c("tlv.encode: unpadded data");let d=b.length/2,e=cm(d);if(e.length/2&128)throw new c("tlv.encode: long form length too big");let f=d>127?cm(e.length/2|128):"";return cm(a)+f+e+b},decode(a,b){let{Err:c}=dh,d=0;if(a<0||a>256)throw new c("tlv.encode: wrong tag");if(b.length<2||b[d++]!==a)throw new c("tlv.decode: wrong tlv");let e=b[d++],f=0;if(128&e){let a=127&e;if(!a)throw new c("tlv.decode(long): indefinite length not supported");if(a>4)throw new c("tlv.decode(long): byte length is too big");let g=b.subarray(d,d+a);if(g.length!==a)throw new c("tlv.decode: length bytes not complete");if(0===g[0])throw new c("tlv.decode(long): zero leftmost byte");for(let a of g)f=f<<8|a;if(d+=a,f<128)throw new c("tlv.decode(long): not minimal encoding")}else f=e;let g=b.subarray(d,d+f);if(g.length!==f)throw new c("tlv.decode: wrong value length");return{v:g,l:b.subarray(d+f)}}},_int:{encode(a){let{Err:b}=dh;if(a<di)throw new b("integer: negative integers are not allowed");let c=cm(a);if(8&Number.parseInt(c[0],16)&&(c="00"+c),1&c.length)throw new b("unexpected DER parsing assertion: unpadded hex");return c},decode(a){let{Err:b}=dh;if(128&a[0])throw new b("invalid signature integer: negative");if(0===a[0]&&!(128&a[1]))throw new b("invalid signature integer: unnecessary leading zero");return df(a)}},toSig(a){let{Err:b,_int:c,_tlv:d}=dh,e="string"==typeof a?dg(a):a;ci(e);let{v:f,l:g}=d.decode(48,e);if(g.length)throw new b("invalid signature: left bytes after parsing");let{v:h,l:i}=d.decode(2,f),{v:j,l:k}=d.decode(2,i);if(k.length)throw new b("invalid signature: left bytes after parsing");return{r:c.decode(h),s:c.decode(j)}},hexFromSig(a){let{_tlv:b,_int:c}=dh,d=b.encode(2,c.encode(a.r)),e=b.encode(2,c.encode(a.s));return b.encode(48,d+e)}},di=BigInt(0),dj=BigInt(1);BigInt(2);let dk=BigInt(3);BigInt(4);let dl=cW(BigInt("0xffffffff00000001000000000000000000000000ffffffffffffffffffffffff")),dm=function(a,b){let c=b=>(function(a){let b=function(a){let b=c5(a);return cG(b,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...b})}(a),{Fp:c,n:d}=b,e=c.BYTES+1,f=2*c.BYTES+1;function g(a){return cQ(a,d)}let{ProjectivePoint:h,normPrivateKeyToScalar:i,weierstrassEquation:j,isWithinCurveOrder:k}=function(a){var b;let c=function(a){let b=c5(a);cG(b,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});let{endo:c,Fp:d,a:e}=b;if(c){if(!d.eql(e,d.ZERO))throw Error("invalid endomorphism, can only be defined for Koblitz curves that have a=0");if("object"!=typeof c||"bigint"!=typeof c.beta||"function"!=typeof c.splitScalar)throw Error("invalid endomorphism, expected beta: bigint and splitScalar: function")}return Object.freeze({...b})}(a),{Fp:d}=c,e=cW(c.n,c.nBitLength),f=c.toBytes||((a,b,c)=>{let e=b.toAffine();return cw(Uint8Array.from([4]),d.toBytes(e.x),d.toBytes(e.y))}),g=c.fromBytes||(a=>{let b=a.subarray(1);return{x:d.fromBytes(b.subarray(0,d.BYTES)),y:d.fromBytes(b.subarray(d.BYTES,2*d.BYTES))}});function h(a){let{a:b,b:e}=c,f=d.sqr(a),g=d.mul(f,a);return d.add(d.add(g,d.mul(a,b)),e)}if(!d.eql(d.sqr(c.Gy),h(c.Gx)))throw Error("bad generator point: equation left != right");function i(a){let b,{allowedPrivateKeyLengths:d,nByteLength:e,wrapPrivateKey:f,n:g}=c;if(d&&"bigint"!=typeof a){if(ch(a)&&(a=cl(a)),"string"!=typeof a||!d.includes(a.length))throw Error("invalid private key");a=a.padStart(2*e,"0")}try{b="bigint"==typeof a?a:cr(cv("private key",a,e))}catch{throw Error("invalid private key, expected hex or "+e+" bytes, got "+typeof a)}return f&&(b=cQ(b,g)),cz("private key",b,dj,g),b}function j(a){if(!(a instanceof m))throw Error("ProjectivePoint expected")}let k=cH((a,b)=>{let{px:c,py:e,pz:f}=a;if(d.eql(f,d.ONE))return{x:c,y:e};let g=a.is0();null==b&&(b=g?d.ONE:d.inv(f));let h=d.mul(c,b),i=d.mul(e,b),j=d.mul(f,b);if(g)return{x:d.ZERO,y:d.ZERO};if(!d.eql(j,d.ONE))throw Error("invZ was invalid");return{x:h,y:i}}),l=cH(a=>{if(a.is0()){if(c.allowInfinityPoint&&!d.is0(a.py))return;throw Error("bad point: ZERO")}let{x:b,y:e}=a.toAffine();if(!d.isValid(b)||!d.isValid(e))throw Error("bad point: x or y not FE");let f=d.sqr(e),g=h(b);if(!d.eql(f,g))throw Error("bad point: equation left != right");if(!a.isTorsionFree())throw Error("bad point: not in prime-order subgroup");return!0});class m{constructor(a,b,c){if(this.px=a,this.py=b,this.pz=c,null==a||!d.isValid(a))throw Error("x required");if(null==b||!d.isValid(b))throw Error("y required");if(null==c||!d.isValid(c))throw Error("z required");Object.freeze(this)}static fromAffine(a){let{x:b,y:c}=a||{};if(!a||!d.isValid(b)||!d.isValid(c))throw Error("invalid affine point");if(a instanceof m)throw Error("projective point not allowed");let e=a=>d.eql(a,d.ZERO);return e(b)&&e(c)?m.ZERO:new m(b,c,d.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(a){let b=d.invertBatch(a.map(a=>a.pz));return a.map((a,c)=>a.toAffine(b[c])).map(m.fromAffine)}static fromHex(a){let b=m.fromAffine(g(cv("pointHex",a)));return b.assertValidity(),b}static fromPrivateKey(a){return m.BASE.multiply(i(a))}static msm(a,b){return function(a,b,c,d){if(function(a,b){if(!Array.isArray(a))throw Error("array expected");a.forEach((a,c)=>{if(!(a instanceof b))throw Error("invalid point at index "+c)})}(c,a),function(a,b){if(!Array.isArray(a))throw Error("array of scalars expected");a.forEach((a,c)=>{if(!b.isValid(a))throw Error("invalid scalar at index "+c)})}(d,b),c.length!==d.length)throw Error("arrays of points and scalars must have equal length");let e=a.ZERO,f=cA(BigInt(c.length)),g=f>12?f-3:f>4?f-2:f?2:1,h=(1<<g)-1,i=Array(h+1).fill(e),j=Math.floor((b.BITS-1)/g)*g,k=e;for(let a=j;a>=0;a-=g){i.fill(e);for(let b=0;b<d.length;b++){let e=Number(d[b]>>BigInt(a)&BigInt(h));i[e]=i[e].add(c[b])}let b=e;for(let a=i.length-1,c=e;a>0;a--)c=c.add(i[a]),b=b.add(c);if(k=k.add(b),0!==a)for(let a=0;a<g;a++)k=k.double()}return k}(m,e,a,b)}_setWindowSize(a){o.setWindowSize(this,a)}assertValidity(){l(this)}hasEvenY(){let{y:a}=this.toAffine();if(d.isOdd)return!d.isOdd(a);throw Error("Field doesn't support isOdd")}equals(a){j(a);let{px:b,py:c,pz:e}=this,{px:f,py:g,pz:h}=a,i=d.eql(d.mul(b,h),d.mul(f,e)),k=d.eql(d.mul(c,h),d.mul(g,e));return i&&k}negate(){return new m(this.px,d.neg(this.py),this.pz)}double(){let{a:a,b:b}=c,e=d.mul(b,dk),{px:f,py:g,pz:h}=this,i=d.ZERO,j=d.ZERO,k=d.ZERO,l=d.mul(f,f),n=d.mul(g,g),o=d.mul(h,h),p=d.mul(f,g);return p=d.add(p,p),k=d.mul(f,h),k=d.add(k,k),i=d.mul(a,k),j=d.mul(e,o),j=d.add(i,j),i=d.sub(n,j),j=d.add(n,j),j=d.mul(i,j),i=d.mul(p,i),k=d.mul(e,k),o=d.mul(a,o),p=d.sub(l,o),p=d.mul(a,p),p=d.add(p,k),k=d.add(l,l),l=d.add(k,l),l=d.add(l,o),l=d.mul(l,p),j=d.add(j,l),o=d.mul(g,h),o=d.add(o,o),l=d.mul(o,p),i=d.sub(i,l),k=d.mul(o,n),k=d.add(k,k),new m(i,j,k=d.add(k,k))}add(a){j(a);let{px:b,py:e,pz:f}=this,{px:g,py:h,pz:i}=a,k=d.ZERO,l=d.ZERO,n=d.ZERO,o=c.a,p=d.mul(c.b,dk),q=d.mul(b,g),r=d.mul(e,h),s=d.mul(f,i),t=d.add(b,e),u=d.add(g,h);t=d.mul(t,u),u=d.add(q,r),t=d.sub(t,u),u=d.add(b,f);let v=d.add(g,i);return u=d.mul(u,v),v=d.add(q,s),u=d.sub(u,v),v=d.add(e,f),k=d.add(h,i),v=d.mul(v,k),k=d.add(r,s),v=d.sub(v,k),n=d.mul(o,u),k=d.mul(p,s),n=d.add(k,n),k=d.sub(r,n),n=d.add(r,n),l=d.mul(k,n),r=d.add(q,q),r=d.add(r,q),s=d.mul(o,s),u=d.mul(p,u),r=d.add(r,s),s=d.sub(q,s),s=d.mul(o,s),u=d.add(u,s),q=d.mul(r,u),l=d.add(l,q),q=d.mul(v,u),k=d.mul(t,k),k=d.sub(k,q),q=d.mul(t,r),n=d.mul(v,n),new m(k,l,n=d.add(n,q))}subtract(a){return this.add(a.negate())}is0(){return this.equals(m.ZERO)}wNAF(a){return o.wNAFCached(this,a,m.normalizeZ)}multiplyUnsafe(a){let{endo:b,n:e}=c;cz("scalar",a,di,e);let f=m.ZERO;if(a===di)return f;if(this.is0()||a===dj)return this;if(!b||o.hasPrecomputes(this))return o.wNAFCachedUnsafe(this,a,m.normalizeZ);let{k1neg:g,k1:h,k2neg:i,k2:j}=b.splitScalar(a),k=f,l=f,n=this;for(;h>di||j>di;)h&dj&&(k=k.add(n)),j&dj&&(l=l.add(n)),n=n.double(),h>>=dj,j>>=dj;return g&&(k=k.negate()),i&&(l=l.negate()),l=new m(d.mul(l.px,b.beta),l.py,l.pz),k.add(l)}multiply(a){let b,e,{endo:f,n:g}=c;if(cz("scalar",a,dj,g),f){let{k1neg:c,k1:g,k2neg:h,k2:i}=f.splitScalar(a),{p:j,f:k}=this.wNAF(g),{p:l,f:n}=this.wNAF(i);j=o.constTimeNegate(c,j),l=o.constTimeNegate(h,l),l=new m(d.mul(l.px,f.beta),l.py,l.pz),b=j.add(l),e=k.add(n)}else{let{p:c,f:d}=this.wNAF(a);b=c,e=d}return m.normalizeZ([b,e])[0]}multiplyAndAddUnsafe(a,b,c){let d=m.BASE,e=(a,b)=>b!==di&&b!==dj&&a.equals(d)?a.multiply(b):a.multiplyUnsafe(b),f=e(this,b).add(e(a,c));return f.is0()?void 0:f}toAffine(a){return k(this,a)}isTorsionFree(){let{h:a,isTorsionFree:b}=c;if(a===dj)return!0;if(b)return b(m,this);throw Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){let{h:a,clearCofactor:b}=c;return a===dj?this:b?b(m,this):this.multiplyUnsafe(c.h)}toRawBytes(a=!0){return cj("isCompressed",a),this.assertValidity(),f(m,this,a)}toHex(a=!0){return cj("isCompressed",a),cl(this.toRawBytes(a))}}m.BASE=new m(c.Gx,c.Gy,d.ONE),m.ZERO=new m(d.ZERO,d.ONE,d.ZERO);let n=c.nBitLength,o=(b=c.endo?Math.ceil(n/2):n,{constTimeNegate:c_,hasPrecomputes:a=>1!==c4(a),unsafeLadder(a,b,c=m.ZERO){let d=a;for(;b>cZ;)b&c$&&(c=c.add(d)),d=d.double(),b>>=c$;return c},precomputeWindow(a,c){let{windows:d,windowSize:e}=c1(c,b),f=[],g=a,h=g;for(let a=0;a<d;a++){h=g,f.push(h);for(let a=1;a<e;a++)h=h.add(g),f.push(h);g=h.double()}return f},wNAF(a,c,d){let{windows:e,windowSize:f}=c1(a,b),g=m.ZERO,h=m.BASE,i=BigInt(2**a-1),j=2**a,k=BigInt(a);for(let a=0;a<e;a++){let b=a*f,e=Number(d&i);d>>=k,e>f&&(e-=j,d+=c$);let l=b+Math.abs(e)-1,m=a%2!=0,n=e<0;0===e?h=h.add(c_(m,c[b])):g=g.add(c_(n,c[l]))}return{p:g,f:h}},wNAFUnsafe(a,c,d,e=m.ZERO){let{windows:f,windowSize:g}=c1(a,b),h=BigInt(2**a-1),i=2**a,j=BigInt(a);for(let a=0;a<f;a++){let b=a*g;if(d===cZ)break;let f=Number(d&h);if(d>>=j,f>g&&(f-=i,d+=c$),0===f)continue;let k=c[b+Math.abs(f)-1];f<0&&(k=k.negate()),e=e.add(k)}return e},getPrecomputes(a,b,c){let d=c2.get(b);return d||(d=this.precomputeWindow(b,a),1!==a&&c2.set(b,c(d))),d},wNAFCached(a,b,c){let d=c4(a);return this.wNAF(d,this.getPrecomputes(d,a,c),b)},wNAFCachedUnsafe(a,b,c,d){let e=c4(a);return 1===e?this.unsafeLadder(a,b,d):this.wNAFUnsafe(e,this.getPrecomputes(e,a,c),b,d)},setWindowSize(a,c){c0(c,b),c3.set(a,c),c2.delete(a)}});return{CURVE:c,ProjectivePoint:m,normPrivateKeyToScalar:i,weierstrassEquation:h,isWithinCurveOrder:function(a){return cy(a,dj,c.n)}}}({...b,toBytes(a,b,d){let e=b.toAffine(),f=c.toBytes(e.x);return cj("isCompressed",d),d?cw(Uint8Array.from([b.hasEvenY()?2:3]),f):cw(Uint8Array.from([4]),f,c.toBytes(e.y))},fromBytes(a){let b=a.length,d=a[0],g=a.subarray(1);if(b===e&&(2===d||3===d)){let a,b=cr(g);if(!cy(b,dj,c.ORDER))throw Error("Point is not on curve");let e=j(b);try{a=c.sqrt(e)}catch(a){throw Error("Point is not on curve"+(a instanceof Error?": "+a.message:""))}return(1&d)==1!=((a&dj)===dj)&&(a=c.neg(a)),{x:b,y:a}}if(b===f&&4===d)return{x:c.fromBytes(g.subarray(0,c.BYTES)),y:c.fromBytes(g.subarray(c.BYTES,2*c.BYTES))};throw Error("invalid Point, expected length of "+e+", or uncompressed "+f+", got "+b)}}),l=a=>cl(ct(a,b.nByteLength)),m=(a,b,c)=>cr(a.slice(b,c));class n{constructor(a,b,c){this.r=a,this.s=b,this.recovery=c,this.assertValidity()}static fromCompact(a){let c=b.nByteLength;return new n(m(a=cv("compactSignature",a,2*c),0,c),m(a,c,2*c))}static fromDER(a){let{r:b,s:c}=dh.toSig(cv("DER",a));return new n(b,c)}assertValidity(){cz("r",this.r,dj,d),cz("s",this.s,dj,d)}addRecoveryBit(a){return new n(this.r,this.s,a)}recoverPublicKey(a){let{r:e,s:f,recovery:i}=this,j=q(cv("msgHash",a));if(null==i||![0,1,2,3].includes(i))throw Error("recovery id invalid");let k=2===i||3===i?e+b.n:e;if(k>=c.ORDER)throw Error("recovery id 2 or 3 invalid");let m=(1&i)==0?"02":"03",n=h.fromHex(m+l(k)),o=cT(k,d),p=g(-j*o),r=g(f*o),s=h.BASE.multiplyAndAddUnsafe(n,p,r);if(!s)throw Error("point at infinify");return s.assertValidity(),s}hasHighS(){return this.s>d>>dj}normalizeS(){return this.hasHighS()?new n(this.r,g(-this.s),this.recovery):this}toDERRawBytes(){return cq(this.toDERHex())}toDERHex(){return dh.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return cq(this.toCompactHex())}toCompactHex(){return l(this.r)+l(this.s)}}function o(a){let b=ch(a),c="string"==typeof a,d=(b||c)&&a.length;return b?d===e||d===f:c?d===2*e||d===2*f:a instanceof h}let p=b.bits2int||function(a){if(a.length>8192)throw Error("input is too large");let c=cr(a),d=8*a.length-b.nBitLength;return d>0?c>>BigInt(d):c},q=b.bits2int_modN||function(a){return g(p(a))},r=cB(b.nBitLength);function s(a){return cz("num < 2^"+b.nBitLength,a,di,r),ct(a,b.nByteLength)}let t={lowS:b.lowS,prehash:!1},u={lowS:b.lowS,prehash:!1};return h.BASE._setWindowSize(8),{CURVE:b,getPublicKey:function(a,b=!0){return h.fromPrivateKey(a).toRawBytes(b)},getSharedSecret:function(a,b,c=!0){if(o(a))throw Error("first arg must be private key");if(!o(b))throw Error("second arg must be public key");return h.fromHex(b).multiply(i(a)).toRawBytes(c)},sign:function(a,e,f=t){let{seed:j,k2sig:l}=function(a,e,f=t){if(["recovered","canonical"].some(a=>a in f))throw Error("sign() legacy options not supported");let{hash:j,randomBytes:l}=b,{lowS:m,prehash:o,extraEntropy:r}=f;null==m&&(m=!0),a=cv("msgHash",a),de(f),o&&(a=cv("prehashed msgHash",j(a)));let u=q(a),v=i(e),w=[s(v),s(u)];if(null!=r&&!1!==r){let a=!0===r?l(c.BYTES):r;w.push(cv("extraEntropy",a))}return{seed:cw(...w),k2sig:function(a){var b;let c=p(a);if(!k(c))return;let e=cT(c,d),f=h.BASE.multiply(c).toAffine(),i=g(f.x);if(i===di)return;let j=g(e*g(u+i*v));if(j===di)return;let l=2*(f.x!==i)|Number(f.y&dj),o=j;return m&&j>d>>dj&&(o=(b=j)>d>>dj?g(-b):b,l^=1),new n(i,o,l)}}}(a,e,f);return cE(b.hash.outputLen,b.nByteLength,b.hmac)(j,l)},verify:function(a,c,e,f=u){let i,j;c=cv("msgHash",c),e=cv("publicKey",e);let{lowS:k,prehash:l,format:m}=f;if(de(f),"strict"in f)throw Error("options.strict was renamed to lowS");if(void 0!==m&&"compact"!==m&&"der"!==m)throw Error("format must be compact or der");let o="string"==typeof a||ch(a),p=!o&&!m&&"object"==typeof a&&null!==a&&"bigint"==typeof a.r&&"bigint"==typeof a.s;if(!o&&!p)throw Error("invalid signature, expected Uint8Array, hex string or Signature instance");try{if(p&&(i=new n(a.r,a.s)),o){try{"compact"!==m&&(i=n.fromDER(a))}catch(a){if(!(a instanceof dh.Err))throw a}i||"der"===m||(i=n.fromCompact(a))}j=h.fromHex(e)}catch{return!1}if(!i||k&&i.hasHighS())return!1;l&&(c=b.hash(c));let{r:r,s:s}=i,t=q(c),v=cT(s,d),w=g(t*v),x=g(r*v),y=h.BASE.multiplyAndAddUnsafe(j,w,x)?.toAffine();return!!y&&g(y.x)===r},ProjectivePoint:h,Signature:n,utils:{isValidPrivateKey(a){try{return i(a),!0}catch{return!1}},normPrivateKeyToScalar:i,randomPrivateKey:()=>{let a=cY(b.n);return function(a,b,c=!1){let d=a.length,e=cX(b),f=cY(b);if(d<16||d<f||d>1024)throw Error("expected "+f+"-1024 bytes of input, got "+d);let g=cQ(c?cs(a):cr(a),b-cK)+cK;return c?cu(g,e):ct(g,e)}(b.randomBytes(a),b.n)},precompute:(a=8,b=h.BASE)=>(b._setWindowSize(a),b.multiply(BigInt(3)),b)}}})({...a,hash:b,hmac:(a,...c)=>b5(b,a,function(...a){let b=0;for(let c=0;c<a.length;c++){let d=a[c];aP(d),b+=d.length}let c=new Uint8Array(b);for(let b=0,d=0;b<a.length;b++){let e=a[b];c.set(e,d),d+=e.length}return c}(...c)),randomBytes:a1});return{...c(b),create:c}}({a:dl.create(BigInt("-3")),b:BigInt("0x5ac635d8aa3a93e7b3ebbd55769886bc651d06b0cc53b0f63bce3c3e27d2604b"),Fp:dl,n:BigInt("0xffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551"),Gx:BigInt("0x6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c296"),Gy:BigInt("0x4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececbb6406837bf51f5"),h:BigInt(1),lowS:!1},cd),dn="base10",dp="base16",dq="base64pad",dr="base64url",ds="utf8";function dt(){let a=a1(32);return(0,aa.toString)(a,dp)}function du(a){let b=cd((0,ab.fromString)(a,dp));return(0,aa.toString)(b,dp)}function dv(a){let b=cd((0,ab.fromString)(a,ds));return(0,aa.toString)(b,dp)}function dw(a){return(0,ab.fromString)(`${a}`,dn)}function dx(a){return Number((0,aa.toString)(a,dn))}function dy(a){return a.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function dz(a){let b=a.replace(/-/g,"+").replace(/_/g,"/"),c=(4-b.length%4)%4;return b+"=".repeat(c)}function dA(a){if(2===dx(a.type))return(0,aa.toString)((0,ac.concat)([a.type,a.sealed]),dq);if(1===dx(a.type)){if(typeof a.senderPublicKey>"u")throw Error("Missing sender public key for type 1 envelope");return(0,aa.toString)((0,ac.concat)([a.type,a.senderPublicKey,a.iv,a.sealed]),dq)}return(0,aa.toString)((0,ac.concat)([a.type,a.iv,a.sealed]),dq)}function dB(a){let b=(a.encoding||dq)===dr?dz(a.encoded):a.encoded,c=(0,ab.fromString)(b,dq),d=c.slice(0,1);if(1===dx(d)){let a=c.slice(1,33),b=c.slice(33,45);return{type:d,sealed:c.slice(45),iv:b,senderPublicKey:a}}if(2===dx(d))return{type:d,sealed:c.slice(1),iv:a1(12)};let e=c.slice(1,13);return{type:d,sealed:c.slice(13),iv:e}}function dC(a){let b=a?.type||0;if(1===b){if(typeof a?.senderPublicKey>"u")throw Error("missing sender public key");if(typeof a?.receiverPublicKey>"u")throw Error("missing receiver public key")}return{type:b,senderPublicKey:a?.senderPublicKey,receiverPublicKey:a?.receiverPublicKey}}function dD(a){return 1===a.type&&"string"==typeof a.senderPublicKey&&"string"==typeof a.receiverPublicKey}function dE(a){return a?.relay||{protocol:"irn"}}function dF(a){let b=ad.RELAY_JSONRPC[a];if(typeof b>"u")throw Error(`Relay Protocol not supported: ${a}`);return b}function dG(a){var b;if(!a.includes("wc:")){let b=aN(a);null!=b&&b.includes("wc:")&&(a=b)}let c=(a=(a=a.includes("wc://")?a.replace("wc://",""):a).includes("wc:")?a.replace("wc:",""):a).indexOf(":"),d=-1!==a.indexOf("?")?a.indexOf("?"):void 0,e=a.substring(0,c),f=a.substring(c+1,d).split("@"),g=new URLSearchParams("u">typeof d?a.substring(d):""),h={};g.forEach((a,b)=>{h[b]=a});let i="string"==typeof h.methods?h.methods.split(","):void 0;return{protocol:e,topic:(b=f[0]).startsWith("//")?b.substring(2):b,version:parseInt(f[1],10),symKey:h.symKey,relay:function(a,b="-"){let c={},d="relay"+b;return Object.keys(a).forEach(b=>{if(b.startsWith(d)){let e=b.replace(d,""),f=a[b];c[e]=f}}),c}(h),methods:i,expiryTimestamp:h.expiryTimestamp?parseInt(h.expiryTimestamp,10):void 0}}function dH(a){let b=new URLSearchParams,c=function(a,b="-"){let c={};return Object.keys(a).forEach(d=>{a[d]&&(c["relay"+b+d]=a[d])}),c}(a.relay);Object.keys(c).sort().forEach(a=>{b.set(a,c[a])}),b.set("symKey",a.symKey),a.expiryTimestamp&&b.set("expiryTimestamp",a.expiryTimestamp.toString()),a.methods&&b.set("methods",a.methods.join(","));let d=b.toString();return`${a.protocol}:${a.topic}@${a.version}?${d}`}function dI(a,b,c){return`${a}?wc_ev=${c}&topic=${b}`}var dJ=Object.defineProperty,dK=Object.defineProperties,dL=Object.getOwnPropertyDescriptors,dM=Object.getOwnPropertySymbols,dN=Object.prototype.hasOwnProperty,dO=Object.prototype.propertyIsEnumerable,dP=(a,b,c)=>b in a?dJ(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c,dQ=(a,b)=>{for(var c in b||(b={}))dN.call(b,c)&&dP(a,c,b[c]);if(dM)for(var c of dM(b))dO.call(b,c)&&dP(a,c,b[c]);return a},dR=(a,b)=>dK(a,dL(b));function dS(a){let b=[];return a.forEach(a=>{let[c,d]=a.split(":");b.push(`${c}:${d}`)}),b}function dT(a){return a.includes(":")}function dU(a){return dT(a)?a.split(":")[0]:a}function dV(a){var b,c,d;let e={};if(!d0(a))return e;for(let[f,g]of Object.entries(a)){let a=dT(f)?[f]:g.chains,h=g.methods||[],i=g.events||[],j=dU(f);e[j]=dR(dQ({},e[j]),{chains:aH(a,null==(b=e[j])?void 0:b.chains),methods:aH(h,null==(c=e[j])?void 0:c.methods),events:aH(i,null==(d=e[j])?void 0:d.events)})}return e}function dW(a,b){let c=function(a){let b={};return a?.forEach(a=>{var c;let[d,e]=a.split(":");b[d]||(b[d]={accounts:[],chains:[],events:[],methods:[]}),b[d].accounts.push(a),null==(c=b[d].chains)||c.push(`${d}:${e}`)}),b}(b=b.map(a=>a.replace("did:pkh:","")));for(let[b,d]of Object.entries(c))d.methods?d.methods=aH(d.methods,a):d.methods=a,d.events=["chainChanged","accountsChanged"];return c}let dX={INVALID_METHOD:{message:"Invalid method.",code:1001},INVALID_EVENT:{message:"Invalid event.",code:1002},INVALID_UPDATE_REQUEST:{message:"Invalid update request.",code:1003},INVALID_EXTEND_REQUEST:{message:"Invalid extend request.",code:1004},INVALID_SESSION_SETTLE_REQUEST:{message:"Invalid session settle request.",code:1005},UNAUTHORIZED_METHOD:{message:"Unauthorized method.",code:3001},UNAUTHORIZED_EVENT:{message:"Unauthorized event.",code:3002},UNAUTHORIZED_UPDATE_REQUEST:{message:"Unauthorized update request.",code:3003},UNAUTHORIZED_EXTEND_REQUEST:{message:"Unauthorized extend request.",code:3004},USER_REJECTED:{message:"User rejected.",code:5e3},USER_REJECTED_CHAINS:{message:"User rejected chains.",code:5001},USER_REJECTED_METHODS:{message:"User rejected methods.",code:5002},USER_REJECTED_EVENTS:{message:"User rejected events.",code:5003},UNSUPPORTED_CHAINS:{message:"Unsupported chains.",code:5100},UNSUPPORTED_METHODS:{message:"Unsupported methods.",code:5101},UNSUPPORTED_EVENTS:{message:"Unsupported events.",code:5102},UNSUPPORTED_ACCOUNTS:{message:"Unsupported accounts.",code:5103},UNSUPPORTED_NAMESPACE_KEY:{message:"Unsupported namespace key.",code:5104},USER_DISCONNECTED:{message:"User disconnected.",code:6e3},SESSION_SETTLEMENT_FAILED:{message:"Session settlement failed.",code:7e3},WC_METHOD_UNSUPPORTED:{message:"Unsupported wc_ method.",code:10001}},dY={NOT_INITIALIZED:{message:"Not initialized.",code:1},NO_MATCHING_KEY:{message:"No matching key.",code:2},RESTORE_WILL_OVERRIDE:{message:"Restore will override.",code:3},RESUBSCRIBED:{message:"Resubscribed.",code:4},MISSING_OR_INVALID:{message:"Missing or invalid.",code:5},EXPIRED:{message:"Expired.",code:6},UNKNOWN_TYPE:{message:"Unknown type.",code:7},MISMATCHED_TOPIC:{message:"Mismatched topic.",code:8},NON_CONFORMING_NAMESPACES:{message:"Non conforming namespaces.",code:9}};function dZ(a,b){let{message:c,code:d}=dY[a];return{message:b?`${c} ${b}`:c,code:d}}function d$(a,b){let{message:c,code:d}=dX[a];return{message:b?`${c} ${b}`:c,code:d}}function d_(a,b){return!!Array.isArray(a)&&(!("u">typeof b)||!a.length||a.every(b))}function d0(a){return Object.getPrototypeOf(a)===Object.prototype&&Object.keys(a).length}function d1(a){return typeof a>"u"}function d2(a,b){return!!(b&&d1(a))||"string"==typeof a&&!!a.trim().length}function d3(a,b){return!!(b&&d1(a))||"number"==typeof a&&!isNaN(a)}function d4(a){return!!(d2(a,!1)&&a.includes(":"))&&2===a.split(":").length}function d5(a){let b=!0;return d_(a)?a.length&&(b=a.every(a=>d2(a,!1))):b=!1,b}function d6(a,b){let c=null;return Object.values(a).forEach(a=>{var d;let e;if(c)return;let f=(d=`${b}, namespace`,e=null,d5(a?.methods)?d5(a?.events)||(e=d$("UNSUPPORTED_EVENTS",`${d}, events should be an array of strings or empty array for no events`)):e=d$("UNSUPPORTED_METHODS",`${d}, methods should be an array of strings or empty array for no methods`),e);f&&(c=f)}),c}function d7(a,b){let c=null;if(a&&d0(a)){let d,e=d6(a,b);e&&(c=e);let f=(d=null,Object.values(a).forEach(a=>{var c,e;let f;if(d)return;let g=(c=a?.accounts,e=`${b} namespace`,f=null,d_(c)?c.forEach(a=>{f||function(a){if(d2(a,!1)&&a.includes(":")){let b=a.split(":");if(3===b.length){let a=b[0]+":"+b[1];return!!b[2]&&d4(a)}}return!1}(a)||(f=d$("UNSUPPORTED_ACCOUNTS",`${e}, account ${a} should be a string and conform to "namespace:chainId:address" format`))}):f=d$("UNSUPPORTED_ACCOUNTS",`${e}, accounts should be an array of strings conforming to "namespace:chainId:address" format`),f);g&&(d=g)}),d);f&&(c=f)}else c=dZ("MISSING_OR_INVALID",`${b}, namespaces should be an object with data`);return c}function d8(a){return d2(a.protocol,!0)}function d9(a){return"u">typeof a}function ea(a,b){return!(!d4(b)||!(function(a){let b=[];return Object.values(a).forEach(a=>{b.push(...dS(a.accounts))}),b})(a).includes(b))}function eb(a,b,c){let d=null,e=function(a){let b={};return Object.keys(a).forEach(c=>{var d;c.includes(":")?b[c]=a[c]:null==(d=a[c].chains)||d.forEach(d=>{b[d]={methods:a[c].methods,events:a[c].events}})}),b}(a),f=function(a){let b={};return Object.keys(a).forEach(c=>{if(c.includes(":"))b[c]=a[c];else{let d=dS(a[c].accounts);d?.forEach(d=>{b[d]={accounts:a[c].accounts.filter(a=>a.includes(`${d}:`)),methods:a[c].methods,events:a[c].events}})}}),b}(b),g=Object.keys(e),h=Object.keys(f),i=ec(Object.keys(a)),j=ec(Object.keys(b)),k=i.filter(a=>!j.includes(a));return k.length&&(d=dZ("NON_CONFORMING_NAMESPACES",`${c} namespaces keys don't satisfy requiredNamespaces.
      Required: ${k.toString()}
      Received: ${Object.keys(b).toString()}`)),ax(g,h)||(d=dZ("NON_CONFORMING_NAMESPACES",`${c} namespaces chains don't satisfy required namespaces.
      Required: ${g.toString()}
      Approved: ${h.toString()}`)),Object.keys(b).forEach(a=>{if(!a.includes(":")||d)return;let e=dS(b[a].accounts);e.includes(a)||(d=dZ("NON_CONFORMING_NAMESPACES",`${c} namespaces accounts don't satisfy namespace accounts for ${a}
        Required: ${a}
        Approved: ${e.toString()}`))}),g.forEach(a=>{d||(ax(e[a].methods,f[a].methods)?ax(e[a].events,f[a].events)||(d=dZ("NON_CONFORMING_NAMESPACES",`${c} namespaces events don't satisfy namespace events for ${a}`)):d=dZ("NON_CONFORMING_NAMESPACES",`${c} namespaces methods don't satisfy namespace methods for ${a}`))}),d}function ec(a){return[...new Set(a.map(a=>a.includes(":")?a.split(":")[0]:a))]}function ed(){let a=at();return new Promise(b=>{switch(a){case ap.browser:b(as()&&navigator?.onLine);break;case ap.reactNative:b(ee());break;case ap.node:default:b(!0)}})}async function ee(){if(ar()&&null!=a.g&&a.g.NetInfo){let b=await (null==a.g?void 0:a.g.NetInfo.fetch());return b?.isConnected}return!0}let ef={};class eg{static get(a){return ef[a]}static set(a,b){ef[a]=b}static delete(a){delete ef[a]}}var eh=a.i(241958),ei=a.i(996840),ej=a.i(31620),ek=a.i(384317);a.i(157938);var el=a.i(693172),em=Object.defineProperty,en=(a,b,c)=>((a,b,c)=>b in a?em(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c)(a,"symbol"!=typeof b?b+"":b,c);class eo extends el.IEvents{constructor(a){super(),this.opts=a,en(this,"protocol","wc"),en(this,"version",2)}}var ep=Object.defineProperty;class eq extends el.IEvents{constructor(a,b){super(),this.core=a,this.logger=b,((a,b,c)=>((a,b,c)=>b in a?ep(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c)(a,"symbol"!=typeof b?b+"":b,c))(this,"records",new Map)}}class er{constructor(a,b){this.logger=a,this.core=b}}class es extends el.IEvents{constructor(a,b){super(),this.relayer=a,this.logger=b}}class et extends el.IEvents{constructor(a){super()}}class eu{constructor(a,b,c,d){this.core=a,this.logger=b,this.name=c}}class ev extends el.IEvents{constructor(a,b){super(),this.relayer=a,this.logger=b}}class ew extends el.IEvents{constructor(a,b){super(),this.core=a,this.logger=b}}class ex{constructor(a,b,c){this.core=a,this.logger=b,this.store=c}}class ey{constructor(a,b){this.projectId=a,this.logger=b}}class ez{constructor(a,b,c){this.core=a,this.logger=b,this.telemetryEnabled=c}}var eA=Object.defineProperty,eB=(a,b,c)=>((a,b,c)=>b in a?eA(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c)(a,"symbol"!=typeof b?b+"":b,c);b.default;class eC{constructor(a){this.opts=a,eB(this,"protocol","wc"),eB(this,"version",2)}}b.EventEmitter;class eD{constructor(a){this.client=a}}var eE=a.i(920275),eF=a.i(271137);a.i(258910);var eG=a.i(499963),eH=a.i(517992),eI=a.i(901631);let eJ="core",eK=`wc@2:${eJ}:`,eL={logger:"error"},eM={database:":memory:"},eN="client_ed25519_seed",eO=d.ONE_DAY,eP=d.SIX_HOURS,eQ="wss://relay.walletconnect.org",eR={message:"relayer_message",message_ack:"relayer_message_ack",connect:"relayer_connect",disconnect:"relayer_disconnect",error:"relayer_error",connection_stalled:"relayer_connection_stalled",publish:"relayer_publish"},eS={payload:"payload",connect:"connect",disconnect:"disconnect",error:"error"},eT="2.21.1",eU={link_mode:"link_mode",relay:"relay"},eV={inbound:"inbound",outbound:"outbound"},eW="WALLETCONNECT_LINK_MODE_APPS",eX={created:"subscription_created",deleted:"subscription_deleted",sync:"subscription_sync",resubscribed:"subscription_resubscribed"},eY=(d.THIRTY_DAYS,d.FIVE_SECONDS,d.THIRTY_DAYS,{wc_pairingDelete:{req:{ttl:d.ONE_DAY,prompt:!1,tag:1e3},res:{ttl:d.ONE_DAY,prompt:!1,tag:1001}},wc_pairingPing:{req:{ttl:d.THIRTY_SECONDS,prompt:!1,tag:1002},res:{ttl:d.THIRTY_SECONDS,prompt:!1,tag:1003}},unregistered_method:{req:{ttl:d.ONE_DAY,prompt:!1,tag:0},res:{ttl:d.ONE_DAY,prompt:!1,tag:0}}}),eZ={create:"pairing_create",expire:"pairing_expire",delete:"pairing_delete",ping:"pairing_ping"},e$={created:"history_created",updated:"history_updated",deleted:"history_deleted",sync:"history_sync"},e_={created:"expirer_created",deleted:"expirer_deleted",expired:"expirer_expired",sync:"expirer_sync"},e0=(d.ONE_DAY,"https://verify.walletconnect.org"),e1=`${e0}/v3`,e2=["https://verify.walletconnect.com",e0],e3={pairing_started:"pairing_started",pairing_uri_validation_success:"pairing_uri_validation_success",pairing_uri_not_expired:"pairing_uri_not_expired",store_new_pairing:"store_new_pairing",subscribing_pairing_topic:"subscribing_pairing_topic",subscribe_pairing_topic_success:"subscribe_pairing_topic_success",existing_pairing:"existing_pairing",pairing_not_expired:"pairing_not_expired",emit_inactive_pairing:"emit_inactive_pairing",emit_session_proposal:"emit_session_proposal"},e4={no_internet_connection:"no_internet_connection",malformed_pairing_uri:"malformed_pairing_uri",active_pairing_already_exists:"active_pairing_already_exists",subscribe_pairing_topic_failure:"subscribe_pairing_topic_failure",pairing_expired:"pairing_expired",proposal_listener_not_found:"proposal_listener_not_found"},e5={session_approve_started:"session_approve_started",session_namespaces_validation_success:"session_namespaces_validation_success",subscribing_session_topic:"subscribing_session_topic",subscribe_session_topic_success:"subscribe_session_topic_success",publishing_session_approve:"publishing_session_approve",session_approve_publish_success:"session_approve_publish_success",store_session:"store_session",publishing_session_settle:"publishing_session_settle",session_settle_publish_success:"session_settle_publish_success"},e6={no_internet_connection:"no_internet_connection",proposal_expired:"proposal_expired",subscribe_session_topic_failure:"subscribe_session_topic_failure",session_approve_publish_failure:"session_approve_publish_failure",session_settle_publish_failure:"session_settle_publish_failure",session_approve_namespace_validation_failure:"session_approve_namespace_validation_failure",proposal_not_found:"proposal_not_found"},e7={authenticated_session_approve_started:"authenticated_session_approve_started",create_authenticated_session_topic:"create_authenticated_session_topic",cacaos_verified:"cacaos_verified",store_authenticated_session:"store_authenticated_session",subscribing_authenticated_session_topic:"subscribing_authenticated_session_topic",subscribe_authenticated_session_topic_success:"subscribe_authenticated_session_topic_success",publishing_authenticated_session_approve:"publishing_authenticated_session_approve"},e8={no_internet_connection:"no_internet_connection",invalid_cacao:"invalid_cacao",subscribe_authenticated_session_topic_failure:"subscribe_authenticated_session_topic_failure",authenticated_session_approve_publish_failure:"authenticated_session_approve_publish_failure",authenticated_session_pending_request_not_found:"authenticated_session_pending_request_not_found"};var e9=function(a,b){if(a.length>=255)throw TypeError("Alphabet too long");for(var c=new Uint8Array(256),d=0;d<c.length;d++)c[d]=255;for(var e=0;e<a.length;e++){var f=a.charAt(e),g=f.charCodeAt(0);if(255!==c[g])throw TypeError(f+" is ambiguous");c[g]=e}var h=a.length,i=a.charAt(0),j=Math.log(h)/Math.log(256),k=Math.log(256)/Math.log(h);function l(a){if("string"!=typeof a)throw TypeError("Expected String");if(0===a.length)return new Uint8Array;var b=0;if(" "!==a[0]){for(var d=0,e=0;a[b]===i;)d++,b++;for(var f=(a.length-b)*j+1>>>0,g=new Uint8Array(f);a[b];){var k=c[a.charCodeAt(b)];if(255===k)return;for(var l=0,m=f-1;(0!==k||l<e)&&-1!==m;m--,l++)k+=h*g[m]>>>0,g[m]=k%256>>>0,k=k/256>>>0;if(0!==k)throw Error("Non-zero carry");e=l,b++}if(" "!==a[b]){for(var n=f-e;n!==f&&0===g[n];)n++;for(var o=new Uint8Array(d+(f-n)),p=d;n!==f;)o[p++]=g[n++];return o}}}return{encode:function(b){if(b instanceof Uint8Array||(ArrayBuffer.isView(b)?b=new Uint8Array(b.buffer,b.byteOffset,b.byteLength):Array.isArray(b)&&(b=Uint8Array.from(b))),!(b instanceof Uint8Array))throw TypeError("Expected Uint8Array");if(0===b.length)return"";for(var c=0,d=0,e=0,f=b.length;e!==f&&0===b[e];)e++,c++;for(var g=(f-e)*k+1>>>0,j=new Uint8Array(g);e!==f;){for(var l=b[e],m=0,n=g-1;(0!==l||m<d)&&-1!==n;n--,m++)l+=256*j[n]>>>0,j[n]=l%h>>>0,l=l/h>>>0;if(0!==l)throw Error("Non-zero carry");d=m,e++}for(var o=g-d;o!==g&&0===j[o];)o++;for(var p=i.repeat(c);o<g;++o)p+=a.charAt(j[o]);return p},decodeUnsafe:l,decode:function(a){var c=l(a);if(c)return c;throw Error(`Non-${b} character`)}}};let fa=a=>{if(a instanceof Uint8Array&&"Uint8Array"===a.constructor.name)return a;if(a instanceof ArrayBuffer)return new Uint8Array(a);if(ArrayBuffer.isView(a))return new Uint8Array(a.buffer,a.byteOffset,a.byteLength);throw Error("Unknown type, must be binary type")};class fb{constructor(a,b,c){this.name=a,this.prefix=b,this.baseEncode=c}encode(a){if(a instanceof Uint8Array)return`${this.prefix}${this.baseEncode(a)}`;throw Error("Unknown type, must be binary type")}}class fc{constructor(a,b,c){if(this.name=a,this.prefix=b,void 0===b.codePointAt(0))throw Error("Invalid prefix character");this.prefixCodePoint=b.codePointAt(0),this.baseDecode=c}decode(a){if("string"==typeof a){if(a.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(a)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(a.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(a){return fe(this,a)}}class fd{constructor(a){this.decoders=a}or(a){return fe(this,a)}decode(a){let b=a[0],c=this.decoders[b];if(c)return c.decode(a);throw RangeError(`Unable to decode multibase string ${JSON.stringify(a)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}let fe=(a,b)=>new fd({...a.decoders||{[a.prefix]:a},...b.decoders||{[b.prefix]:b}});class ff{constructor(a,b,c,d){this.name=a,this.prefix=b,this.baseEncode=c,this.baseDecode=d,this.encoder=new fb(a,b,c),this.decoder=new fc(a,b,d)}encode(a){return this.encoder.encode(a)}decode(a){return this.decoder.decode(a)}}let fg=({name:a,prefix:b,encode:c,decode:d})=>new ff(a,b,c,d),fh=({prefix:a,name:b,alphabet:c})=>{let{encode:d,decode:e}=e9(c,b);return fg({prefix:a,name:b,encode:d,decode:a=>fa(e(a))})},fi=({name:a,prefix:b,bitsPerChar:c,alphabet:d})=>fg({prefix:b,name:a,encode:a=>((a,b,c)=>{let d="="===b[b.length-1],e=(1<<c)-1,f="",g=0,h=0;for(let d=0;d<a.length;++d)for(h=h<<8|a[d],g+=8;g>c;)g-=c,f+=b[e&h>>g];if(g&&(f+=b[e&h<<c-g]),d)for(;f.length*c&7;)f+="=";return f})(a,d,c),decode:b=>((a,b,c,d)=>{let e={};for(let a=0;a<b.length;++a)e[b[a]]=a;let f=a.length;for(;"="===a[f-1];)--f;let g=new Uint8Array(f*c/8|0),h=0,i=0,j=0;for(let b=0;b<f;++b){let f=e[a[b]];if(void 0===f)throw SyntaxError(`Non-${d} character`);i=i<<c|f,(h+=c)>=8&&(h-=8,g[j++]=255&i>>h)}if(h>=c||255&i<<8-h)throw SyntaxError("Unexpected end of data");return g})(b,d,c,a)});var fj=Object.freeze({__proto__:null,identity:fg({prefix:"\0",name:"identity",encode:a=>new TextDecoder().decode(a),decode:a=>new TextEncoder().encode(a)})}),fk=Object.freeze({__proto__:null,base2:fi({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1})}),fl=Object.freeze({__proto__:null,base8:fi({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3})}),fm=Object.freeze({__proto__:null,base10:fh({prefix:"9",name:"base10",alphabet:"0123456789"})}),fn=Object.freeze({__proto__:null,base16:fi({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),base16upper:fi({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4})});let fo=fi({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),fp=fi({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),fq=fi({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),fr=fi({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),fs=fi({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),ft=fi({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),fu=fi({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});var fv=Object.freeze({__proto__:null,base32:fo,base32upper:fp,base32pad:fq,base32padupper:fr,base32hex:fs,base32hexupper:ft,base32hexpad:fu,base32hexpadupper:fi({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),base32z:fi({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5})}),fw=Object.freeze({__proto__:null,base36:fh({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),base36upper:fh({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"})}),fx=Object.freeze({__proto__:null,base58btc:fh({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),base58flickr:fh({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"})});let fy=fi({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),fz=fi({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6});var fA=Object.freeze({__proto__:null,base64:fy,base64pad:fz,base64url:fi({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),base64urlpad:fi({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6})});let fB=Array.from("🚀🪐☄🛰🌌🌑🌒🌓🌔🌕🌖🌗🌘🌍🌏🌎🐉☀💻🖥💾💿😂❤😍🤣😊🙏💕😭😘👍😅👏😁🔥🥰💔💖💙😢🤔😆🙄💪😉☺👌🤗💜😔😎😇🌹🤦🎉💞✌✨🤷😱😌🌸🙌😋💗💚😏💛🙂💓🤩😄😀🖤😃💯🙈👇🎶😒🤭❣😜💋👀😪😑💥🙋😞😩😡🤪👊🥳😥🤤👉💃😳✋😚😝😴🌟😬🙃🍀🌷😻😓⭐✅🥺🌈😈🤘💦✔😣🏃💐☹🎊💘😠☝😕🌺🎂🌻😐🖕💝🙊😹🗣💫💀👑🎵🤞😛🔴😤🌼😫⚽🤙☕🏆🤫👈😮🙆🍻🍃🐶💁😲🌿🧡🎁⚡🌞🎈❌✊👋😰🤨😶🤝🚶💰🍓💢🤟🙁🚨💨🤬✈🎀🍺🤓😙💟🌱😖👶🥴▶➡❓💎💸⬇😨🌚🦋😷🕺⚠🙅😟😵👎🤲🤠🤧📌🔵💅🧐🐾🍒😗🤑🌊🤯🐷☎💧😯💆👆🎤🙇🍑❄🌴💣🐸💌📍🥀🤢👅💡💩👐📸👻🤐🤮🎼🥵🚩🍎🍊👼💍📣🥂"),fC=fB.reduce((a,b,c)=>(a[c]=b,a),[]),fD=fB.reduce((a,b,c)=>(a[b.codePointAt(0)]=c,a),[]);var fE=Object.freeze({__proto__:null,base256emoji:fg({prefix:"🚀",name:"base256emoji",encode:function(a){return a.reduce((a,b)=>a+=fC[b],"")},decode:function(a){let b=[];for(let c of a){let a=fD[c.codePointAt(0)];if(void 0===a)throw Error(`Non-base256emoji character: ${c}`);b.push(a)}return new Uint8Array(b)}})});function fF(a,b,c){b=b||[],c=c||0;for(var d=c;a>=0x80000000;)b[c++]=255&a|128,a/=128;for(;-128&a;)b[c++]=255&a|128,a>>>=7;return b[c]=0|a,fF.bytes=c-d+1,b}var fG={encode:fF,encodingLength:function(a){return a<128?1:a<16384?2:a<2097152?3:a<0x10000000?4:a<0x800000000?5:a<0x40000000000?6:a<0x2000000000000?7:a<0x100000000000000?8:a<0x8000000000000000?9:10}};let fH=(a,b,c=0)=>(fG.encode(a,b,c),b),fI=a=>fG.encodingLength(a),fJ=(a,b)=>{let c=b.byteLength,d=fI(a),e=d+fI(c),f=new Uint8Array(e+c);return fH(a,f,0),fH(c,f,d),f.set(b,e),new fK(a,c,b,f)};class fK{constructor(a,b,c,d){this.code=a,this.size=b,this.digest=c,this.bytes=d}}let fL=({name:a,code:b,encode:c})=>new fM(a,b,c);class fM{constructor(a,b,c){this.name=a,this.code=b,this.encode=c}digest(a){if(a instanceof Uint8Array){let b=this.encode(a);return b instanceof Uint8Array?fJ(this.code,b):b.then(a=>fJ(this.code,a))}throw Error("Unknown type, must be binary type")}}let fN=a=>async b=>new Uint8Array(await crypto.subtle.digest(a,b));var fO=Object.freeze({__proto__:null,sha256:fL({name:"sha2-256",code:18,encode:fN("SHA-256")}),sha512:fL({name:"sha2-512",code:19,encode:fN("SHA-512")})}),fP=Object.freeze({__proto__:null,identity:{code:0,name:"identity",encode:fa,digest:a=>fJ(0,fa(a))}});new TextEncoder,new TextDecoder;let fQ={...fj,...fk,...fl,...fm,...fn,...fv,...fw,...fx,...fA,...fE};function fR(a,b,c,d){return{name:a,prefix:b,encoder:{name:a,prefix:b,encode:c},decoder:{decode:d}}}({...fO,...fP});let fS=fR("utf8","u",a=>"u"+new TextDecoder("utf8").decode(a),a=>new TextEncoder().encode(a.substring(1))),fT=fR("ascii","a",a=>{let b="a";for(let c=0;c<a.length;c++)b+=String.fromCharCode(a[c]);return b},a=>{let b=function(a=0){return null!=globalThis.Buffer&&null!=globalThis.Buffer.allocUnsafe?globalThis.Buffer.allocUnsafe(a):new Uint8Array(a)}((a=a.substring(1)).length);for(let c=0;c<a.length;c++)b[c]=a.charCodeAt(c);return b}),fU={utf8:fS,"utf-8":fS,hex:fQ.base16,latin1:fT,ascii:fT,binary:fT,...fQ};var fV=Object.defineProperty,fW=(a,b,c)=>((a,b,c)=>b in a?fV(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c)(a,"symbol"!=typeof b?b+"":b,c);class fX{constructor(a,b){this.core=a,this.logger=b,fW(this,"keychain",new Map),fW(this,"name","keychain"),fW(this,"version","0.3"),fW(this,"initialized",!1),fW(this,"storagePrefix",eK),fW(this,"init",async()=>{if(!this.initialized){let a=await this.getKeyChain();"u">typeof a&&(this.keychain=a),this.initialized=!0}}),fW(this,"has",a=>(this.isInitialized(),this.keychain.has(a))),fW(this,"set",async(a,b)=>{this.isInitialized(),this.keychain.set(a,b),await this.persist()}),fW(this,"get",a=>{this.isInitialized();let b=this.keychain.get(a);if(typeof b>"u"){let{message:b}=dZ("NO_MATCHING_KEY",`${this.name}: ${a}`);throw Error(b)}return b}),fW(this,"del",async a=>{this.isInitialized(),this.keychain.delete(a),await this.persist()}),this.core=a,this.logger=(0,ej.generateChildLogger)(b,this.name)}get context(){return(0,ej.getLoggerContext)(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}async setKeyChain(a){await this.core.storage.setItem(this.storageKey,ay(a))}async getKeyChain(){let a=await this.core.storage.getItem(this.storageKey);return"u">typeof a?az(a):void 0}async persist(){await this.setKeyChain(this.keychain)}isInitialized(){if(!this.initialized){let{message:a}=dZ("NOT_INITIALIZED",this.name);throw Error(a)}}}var fY=Object.defineProperty,fZ=(a,b,c)=>((a,b,c)=>b in a?fY(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c)(a,"symbol"!=typeof b?b+"":b,c);class f${constructor(a,b,c){this.core=a,this.logger=b,fZ(this,"name","crypto"),fZ(this,"keychain"),fZ(this,"randomSessionIdentifier",dt()),fZ(this,"initialized",!1),fZ(this,"init",async()=>{this.initialized||(await this.keychain.init(),this.initialized=!0)}),fZ(this,"hasKeys",a=>(this.isInitialized(),this.keychain.has(a))),fZ(this,"getClientId",async()=>{this.isInitialized();let a=await this.getClientSeed(),b=_.generateKeyPair(a);return _.encodeIss(b.publicKey)}),fZ(this,"generateKeyPair",()=>{this.isInitialized();let a=function(){let a=dd.utils.randomPrivateKey(),b=dd.getPublicKey(a);return{privateKey:(0,aa.toString)(a,dp),publicKey:(0,aa.toString)(b,dp)}}();return this.setPrivateKey(a.publicKey,a.privateKey)}),fZ(this,"signJWT",async a=>{this.isInitialized();let b=await this.getClientSeed(),c=_.generateKeyPair(b),d=this.randomSessionIdentifier;return await _.signJWT(d,a,eO,c)}),fZ(this,"generateSharedKey",(a,b,c)=>{this.isInitialized();let d=function(a,b){var c;let d,e=dd.getSharedSecret((0,ab.fromString)(a,dp),(0,ab.fromString)(b,dp)),f=(d=void 0,function(a,b,c,d=32){if(aQ(a),aO(d),d>255*a.outputLen)throw Error("Length should be <= 255*HashLen");let e=Math.ceil(d/a.outputLen);void 0===c&&(c=b7);let f=new Uint8Array(e*a.outputLen),g=b5.create(a,b),h=g._cloneInto(),i=new Uint8Array(g.outputLen);for(let b=0;b<e;b++)b6[0]=b+1,h.update(0===b?b7:i).update(c).update(b6).digestInto(i),f.set(i,a.outputLen*b),g._cloneInto(h);return g.destroy(),h.destroy(),i.fill(0),b6.fill(0),f.slice(0,d)}(cd,(c=void 0,aQ(cd),void 0===c&&(c=new Uint8Array(cd.outputLen)),b5(cd,a$(c),a$(e))),d,32));return(0,aa.toString)(f,dp)}(this.getPrivateKey(a),b);return this.setSymKey(d,c)}),fZ(this,"setSymKey",async(a,b)=>{this.isInitialized();let c=b||du(a);return await this.keychain.set(c,a),c}),fZ(this,"deleteKeyPair",async a=>{this.isInitialized(),await this.keychain.del(a)}),fZ(this,"deleteSymKey",async a=>{this.isInitialized(),await this.keychain.del(a)}),fZ(this,"encode",async(a,b,c)=>{this.isInitialized();let d=dC(c),e=(0,eE.safeJsonStringify)(b);if(2===d.type)return function(a,b){let c=dw(2),d=a1(12),e=dA({type:c,sealed:(0,ab.fromString)(a,ds),iv:d});return b===dr?dy(e):e}(e,c?.encoding);if(dD(d)){let b=d.senderPublicKey,c=d.receiverPublicKey;a=await this.generateSharedKey(b,c)}let f=this.getSymKey(a),{type:g,senderPublicKey:h}=d;return function(a){let b=dw("u">typeof a.type?a.type:0);if(1===dx(b)&&typeof a.senderPublicKey>"u")throw Error("Missing sender public key for type 1 envelope");let c="u">typeof a.senderPublicKey?(0,ab.fromString)(a.senderPublicKey,dp):void 0,d="u">typeof a.iv?(0,ab.fromString)(a.iv,dp):a1(12),e=dA({type:b,sealed:b3((0,ab.fromString)(a.symKey,dp),d).encrypt((0,ab.fromString)(a.message,ds)),iv:d,senderPublicKey:c});return a.encoding===dr?dy(e):e}({type:g,symKey:f,message:e,senderPublicKey:h,encoding:c?.encoding})}),fZ(this,"decode",async(a,b,c)=>{this.isInitialized();let d=function(a,b){let c=dB({encoded:a,encoding:b?.encoding});return dC({type:dx(c.type),senderPublicKey:"u">typeof c.senderPublicKey?(0,aa.toString)(c.senderPublicKey,dp):void 0,receiverPublicKey:b?.receiverPublicKey})}(b,c);if(2===d.type){let a=function(a,b){let{sealed:c}=dB({encoded:a,encoding:b});return(0,aa.toString)(c,ds)}(b,c?.encoding);return(0,eE.safeJsonParse)(a)}if(dD(d)){let b=d.receiverPublicKey,c=d.senderPublicKey;a=await this.generateSharedKey(b,c)}try{let d=this.getSymKey(a),e=function(a){let b=(0,ab.fromString)(a.symKey,dp),{sealed:c,iv:d}=dB({encoded:a.encoded,encoding:a.encoding}),e=b3(b,d).decrypt(c);if(null===e)throw Error("Failed to decrypt");return(0,aa.toString)(e,ds)}({symKey:d,encoded:b,encoding:c?.encoding});return(0,eE.safeJsonParse)(e)}catch(b){this.logger.error(`Failed to decode message from topic: '${a}', clientId: '${await this.getClientId()}'`),this.logger.error(b)}}),fZ(this,"getPayloadType",(a,b=dq)=>dx(dB({encoded:a,encoding:b}).type)),fZ(this,"getPayloadSenderPublicKey",(a,b=dq)=>{let c=dB({encoded:a,encoding:b});return c.senderPublicKey?(0,aa.toString)(c.senderPublicKey,dp):void 0}),this.core=a,this.logger=(0,ej.generateChildLogger)(b,this.name),this.keychain=c||new fX(this.core,this.logger)}get context(){return(0,ej.getLoggerContext)(this.logger)}async setPrivateKey(a,b){return await this.keychain.set(a,b),a}getPrivateKey(a){return this.keychain.get(a)}async getClientSeed(){let a="";try{a=this.keychain.get(eN)}catch{a=dt(),await this.keychain.set(eN,a)}return function(a,b="utf8"){let c=fU[b];if(!c)throw Error(`Unsupported encoding "${b}"`);return("utf8"===b||"utf-8"===b)&&null!=globalThis.Buffer&&null!=globalThis.Buffer.from?globalThis.Buffer.from(a,"utf8"):c.decoder.decode(`${c.prefix}${a}`)}(a,"base16")}getSymKey(a){return this.keychain.get(a)}isInitialized(){if(!this.initialized){let{message:a}=dZ("NOT_INITIALIZED",this.name);throw Error(a)}}}var f_=Object.defineProperty,f0=Object.defineProperties,f1=Object.getOwnPropertyDescriptors,f2=Object.getOwnPropertySymbols,f3=Object.prototype.hasOwnProperty,f4=Object.prototype.propertyIsEnumerable,f5=(a,b,c)=>b in a?f_(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c,f6=(a,b,c)=>f5(a,"symbol"!=typeof b?b+"":b,c);class f7 extends er{constructor(a,b){super(a,b),this.logger=a,this.core=b,f6(this,"messages",new Map),f6(this,"messagesWithoutClientAck",new Map),f6(this,"name","messages"),f6(this,"version","0.3"),f6(this,"initialized",!1),f6(this,"storagePrefix",eK),f6(this,"init",async()=>{if(!this.initialized){this.logger.trace("Initialized");try{let a=await this.getRelayerMessages();"u">typeof a&&(this.messages=a);let b=await this.getRelayerMessagesWithoutClientAck();"u">typeof b&&(this.messagesWithoutClientAck=b),this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",size:this.messages.size})}catch(a){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(a)}finally{this.initialized=!0}}}),f6(this,"set",async(a,b,c)=>{this.isInitialized();let d=dv(b),e=this.messages.get(a);if(typeof e>"u"&&(e={}),"u">typeof e[d])return d;if(e[d]=b,this.messages.set(a,e),c===eV.inbound){let c=this.messagesWithoutClientAck.get(a)||{};this.messagesWithoutClientAck.set(a,f0(((a,b)=>{for(var c in b||(b={}))f3.call(b,c)&&f5(a,c,b[c]);if(f2)for(var c of f2(b))f4.call(b,c)&&f5(a,c,b[c]);return a})({},c),f1({[d]:b})))}return await this.persist(),d}),f6(this,"get",a=>{this.isInitialized();let b=this.messages.get(a);return typeof b>"u"&&(b={}),b}),f6(this,"getWithoutAck",a=>{this.isInitialized();let b={};for(let c of a){let a=this.messagesWithoutClientAck.get(c)||{};b[c]=Object.values(a)}return b}),f6(this,"has",(a,b)=>(this.isInitialized(),"u">typeof this.get(a)[dv(b)])),f6(this,"ack",async(a,b)=>{this.isInitialized();let c=this.messagesWithoutClientAck.get(a);if(typeof c>"u")return;let d=dv(b);delete c[d],0===Object.keys(c).length?this.messagesWithoutClientAck.delete(a):this.messagesWithoutClientAck.set(a,c),await this.persist()}),f6(this,"del",async a=>{this.isInitialized(),this.messages.delete(a),this.messagesWithoutClientAck.delete(a),await this.persist()}),this.logger=(0,ej.generateChildLogger)(a,this.name),this.core=b}get context(){return(0,ej.getLoggerContext)(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get storageKeyWithoutClientAck(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name+"_withoutClientAck"}async setRelayerMessages(a){await this.core.storage.setItem(this.storageKey,ay(a))}async setRelayerMessagesWithoutClientAck(a){await this.core.storage.setItem(this.storageKeyWithoutClientAck,ay(a))}async getRelayerMessages(){let a=await this.core.storage.getItem(this.storageKey);return"u">typeof a?az(a):void 0}async getRelayerMessagesWithoutClientAck(){let a=await this.core.storage.getItem(this.storageKeyWithoutClientAck);return"u">typeof a?az(a):void 0}async persist(){await this.setRelayerMessages(this.messages),await this.setRelayerMessagesWithoutClientAck(this.messagesWithoutClientAck)}isInitialized(){if(!this.initialized){let{message:a}=dZ("NOT_INITIALIZED",this.name);throw Error(a)}}}var f8=Object.defineProperty,f9=Object.defineProperties,ga=Object.getOwnPropertyDescriptors,gb=Object.getOwnPropertySymbols,gc=Object.prototype.hasOwnProperty,gd=Object.prototype.propertyIsEnumerable,ge=(a,b,c)=>b in a?f8(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c,gf=(a,b)=>{for(var c in b||(b={}))gc.call(b,c)&&ge(a,c,b[c]);if(gb)for(var c of gb(b))gd.call(b,c)&&ge(a,c,b[c]);return a},gg=(a,b)=>f9(a,ga(b)),gh=(a,b,c)=>ge(a,"symbol"!=typeof b?b+"":b,c);class gi extends es{constructor(a,c){super(a,c),this.relayer=a,this.logger=c,gh(this,"events",new b.EventEmitter),gh(this,"name","publisher"),gh(this,"queue",new Map),gh(this,"publishTimeout",(0,d.toMiliseconds)(d.ONE_MINUTE)),gh(this,"initialPublishTimeout",(0,d.toMiliseconds)(15*d.ONE_SECOND)),gh(this,"needsTransportRestart",!1),gh(this,"publish",async(a,b,c)=>{var d;this.logger.debug("Publishing Payload"),this.logger.trace({type:"method",method:"publish",params:{topic:a,message:b,opts:c}});let e=c?.ttl||eP,f=dE(c),g=c?.prompt||!1,h=c?.tag||0,i=c?.id||(0,eG.getBigIntRpcId)().toString(),j={topic:a,message:b,opts:{ttl:e,relay:f,prompt:g,tag:h,id:i,attestation:c?.attestation,tvf:c?.tvf}},k=`Failed to publish payload, please try again. id:${i} tag:${h}`;try{let d=new Promise(async d=>{let f=({id:a})=>{j.opts.id===a&&(this.removeRequestFromQueue(a),this.relayer.events.removeListener(eR.publish,f),d(j))};this.relayer.events.on(eR.publish,f);let k=aB(new Promise((d,f)=>{this.rpcPublish({topic:a,message:b,ttl:e,prompt:g,tag:h,id:i,attestation:c?.attestation,tvf:c?.tvf}).then(d).catch(a=>{this.logger.warn(a,a?.message),f(a)})}),this.initialPublishTimeout,`Failed initial publish, retrying.... id:${i} tag:${h}`);try{await k,this.events.removeListener(eR.publish,f)}catch(a){this.queue.set(i,gg(gf({},j),{attempt:1})),this.logger.warn(a,a?.message)}});this.logger.trace({type:"method",method:"publish",params:{id:i,topic:a,message:b,opts:c}}),await aB(d,this.publishTimeout,k)}catch(a){if(this.logger.debug("Failed to Publish Payload"),this.logger.error(a),null!=(d=c?.internal)&&d.throwOnFailedPublish)throw a}finally{this.queue.delete(i)}}),gh(this,"on",(a,b)=>{this.events.on(a,b)}),gh(this,"once",(a,b)=>{this.events.once(a,b)}),gh(this,"off",(a,b)=>{this.events.off(a,b)}),gh(this,"removeListener",(a,b)=>{this.events.removeListener(a,b)}),this.relayer=a,this.logger=(0,ej.generateChildLogger)(c,this.name),this.registerEventListeners()}get context(){return(0,ej.getLoggerContext)(this.logger)}async rpcPublish(a){var b,c,d,e;let{topic:f,message:g,ttl:h=eP,prompt:i,tag:j,id:k,attestation:l,tvf:m}=a,n={method:dF(dE().protocol).publish,params:gf({topic:f,message:g,ttl:h,prompt:i,tag:j,attestation:l},m),id:k};d1(null==(b=n.params)?void 0:b.prompt)&&(null==(c=n.params)||delete c.prompt),d1(null==(d=n.params)?void 0:d.tag)&&(null==(e=n.params)||delete e.tag),this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"message",direction:"outgoing",request:n});let o=await this.relayer.request(n);return this.relayer.events.emit(eR.publish,a),this.logger.debug("Successfully Published Payload"),o}removeRequestFromQueue(a){this.queue.delete(a)}checkQueue(){this.queue.forEach(async(a,b)=>{let c=a.attempt+1;this.queue.set(b,gg(gf({},a),{attempt:c}));let{topic:d,message:e,opts:f,attestation:g}=a;this.logger.warn({},`Publisher: queue->publishing: ${a.opts.id}, tag: ${a.opts.tag}, attempt: ${c}`),await this.rpcPublish(gg(gf({},a),{topic:d,message:e,ttl:f.ttl,prompt:f.prompt,tag:f.tag,id:f.id,attestation:g,tvf:f.tvf})),this.logger.warn({},`Publisher: queue->published: ${a.opts.id}`)})}registerEventListeners(){this.relayer.core.heartbeat.on(eh.HEARTBEAT_EVENTS.pulse,()=>{if(this.needsTransportRestart){this.needsTransportRestart=!1,this.relayer.events.emit(eR.connection_stalled);return}this.checkQueue()}),this.relayer.on(eR.message_ack,a=>{this.removeRequestFromQueue(a.id.toString())})}}var gj=Object.defineProperty,gk=(a,b,c)=>((a,b,c)=>b in a?gj(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c)(a,"symbol"!=typeof b?b+"":b,c);class gl{constructor(){gk(this,"map",new Map),gk(this,"set",(a,b)=>{let c=this.get(a);this.exists(a,b)||this.map.set(a,[...c,b])}),gk(this,"get",a=>this.map.get(a)||[]),gk(this,"exists",(a,b)=>this.get(a).includes(b)),gk(this,"delete",(a,b)=>{if(typeof b>"u")return void this.map.delete(a);if(!this.map.has(a))return;let c=this.get(a);if(!this.exists(a,b))return;let d=c.filter(a=>a!==b);if(!d.length)return void this.map.delete(a);this.map.set(a,d)}),gk(this,"clear",()=>{this.map.clear()})}get topics(){return Array.from(this.map.keys())}}var gm=Object.defineProperty,gn=Object.defineProperties,go=Object.getOwnPropertyDescriptors,gp=Object.getOwnPropertySymbols,gq=Object.prototype.hasOwnProperty,gr=Object.prototype.propertyIsEnumerable,gs=(a,b,c)=>b in a?gm(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c,gt=(a,b)=>{for(var c in b||(b={}))gq.call(b,c)&&gs(a,c,b[c]);if(gp)for(var c of gp(b))gr.call(b,c)&&gs(a,c,b[c]);return a},gu=(a,b)=>gn(a,go(b)),gv=(a,b,c)=>gs(a,"symbol"!=typeof b?b+"":b,c);class gw extends ev{constructor(a,c){super(a,c),this.relayer=a,this.logger=c,gv(this,"subscriptions",new Map),gv(this,"topicMap",new gl),gv(this,"events",new b.EventEmitter),gv(this,"name","subscription"),gv(this,"version","0.3"),gv(this,"pending",new Map),gv(this,"cached",[]),gv(this,"initialized",!1),gv(this,"storagePrefix",eK),gv(this,"subscribeTimeout",(0,d.toMiliseconds)(d.ONE_MINUTE)),gv(this,"initialSubscribeTimeout",(0,d.toMiliseconds)(15*d.ONE_SECOND)),gv(this,"clientId"),gv(this,"batchSubscribeTopicsLimit",500),gv(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),this.registerEventListeners(),await this.restore()),this.initialized=!0}),gv(this,"subscribe",async(a,b)=>{this.isInitialized(),this.logger.debug("Subscribing Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:a,opts:b}});try{let c=dE(b),d={topic:a,relay:c,transportType:b?.transportType};this.pending.set(a,d);let e=await this.rpcSubscribe(a,c,b);return"string"==typeof e&&(this.onSubscribe(e,d),this.logger.debug("Successfully Subscribed Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:a,opts:b}})),e}catch(a){throw this.logger.debug("Failed to Subscribe Topic"),this.logger.error(a),a}}),gv(this,"unsubscribe",async(a,b)=>{this.isInitialized(),"u">typeof b?.id?await this.unsubscribeById(a,b.id,b):await this.unsubscribeByTopic(a,b)}),gv(this,"isSubscribed",a=>new Promise(b=>{b(this.topicMap.topics.includes(a))})),gv(this,"isKnownTopic",a=>new Promise(b=>{b(this.topicMap.topics.includes(a)||this.pending.has(a)||this.cached.some(b=>b.topic===a))})),gv(this,"on",(a,b)=>{this.events.on(a,b)}),gv(this,"once",(a,b)=>{this.events.once(a,b)}),gv(this,"off",(a,b)=>{this.events.off(a,b)}),gv(this,"removeListener",(a,b)=>{this.events.removeListener(a,b)}),gv(this,"start",async()=>{await this.onConnect()}),gv(this,"stop",async()=>{await this.onDisconnect()}),gv(this,"restart",async()=>{await this.restore(),await this.onRestart()}),gv(this,"checkPending",async()=>{if(0===this.pending.size&&(!this.initialized||!this.relayer.connected))return;let a=[];this.pending.forEach(b=>{a.push(b)}),await this.batchSubscribe(a)}),gv(this,"registerEventListeners",()=>{this.relayer.core.heartbeat.on(eh.HEARTBEAT_EVENTS.pulse,async()=>{await this.checkPending()}),this.events.on(eX.created,async a=>{let b=eX.created;this.logger.info(`Emitting ${b}`),this.logger.debug({type:"event",event:b,data:a}),await this.persist()}),this.events.on(eX.deleted,async a=>{let b=eX.deleted;this.logger.info(`Emitting ${b}`),this.logger.debug({type:"event",event:b,data:a}),await this.persist()})}),this.relayer=a,this.logger=(0,ej.generateChildLogger)(c,this.name),this.clientId=""}get context(){return(0,ej.getLoggerContext)(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.relayer.core.customStoragePrefix+"//"+this.name}get length(){return this.subscriptions.size}get ids(){return Array.from(this.subscriptions.keys())}get values(){return Array.from(this.subscriptions.values())}get topics(){return this.topicMap.topics}get hasAnyTopics(){return this.topicMap.topics.length>0||this.pending.size>0||this.cached.length>0||this.subscriptions.size>0}hasSubscription(a,b){let c=!1;try{c=this.getSubscription(a).topic===b}catch{}return c}reset(){this.cached=[],this.initialized=!0}onDisable(){this.values.length>0&&(this.cached=this.values),this.subscriptions.clear(),this.topicMap.clear()}async unsubscribeByTopic(a,b){let c=this.topicMap.get(a);await Promise.all(c.map(async c=>await this.unsubscribeById(a,c,b)))}async unsubscribeById(a,b,c){this.logger.debug("Unsubscribing Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:a,id:b,opts:c}});try{let d=dE(c);await this.restartToComplete({topic:a,id:b,relay:d}),await this.rpcUnsubscribe(a,b,d);let e=d$("USER_DISCONNECTED",`${this.name}, ${a}`);await this.onUnsubscribe(a,b,e),this.logger.debug("Successfully Unsubscribed Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:a,id:b,opts:c}})}catch(a){throw this.logger.debug("Failed to Unsubscribe Topic"),this.logger.error(a),a}}async rpcSubscribe(a,b,c){var e;c&&c?.transportType!==eU.relay||await this.restartToComplete({topic:a,id:a,relay:b});let f={method:dF(b.protocol).subscribe,params:{topic:a}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:f});let g=null==(e=c?.internal)?void 0:e.throwOnFailedPublish;try{let b=await this.getSubscriptionId(a);if(c?.transportType===eU.link_mode)return setTimeout(()=>{(this.relayer.connected||this.relayer.connecting)&&this.relayer.request(f).catch(a=>this.logger.warn(a))},(0,d.toMiliseconds)(d.ONE_SECOND)),b;let e=new Promise(async b=>{let c=d=>{d.topic===a&&(this.events.removeListener(eX.created,c),b(d.id))};this.events.on(eX.created,c);try{let d=await aB(new Promise((a,b)=>{this.relayer.request(f).catch(a=>{this.logger.warn(a,a?.message),b(a)}).then(a)}),this.initialSubscribeTimeout,`Subscribing to ${a} failed, please try again`);this.events.removeListener(eX.created,c),b(d)}catch{}}),h=await aB(e,this.subscribeTimeout,`Subscribing to ${a} failed, please try again`);if(!h&&g)throw Error(`Subscribing to ${a} failed, please try again`);return h?b:null}catch(a){if(this.logger.debug("Outgoing Relay Subscribe Payload stalled"),this.relayer.events.emit(eR.connection_stalled),g)throw a}return null}async rpcBatchSubscribe(a){if(!a.length)return;let b={method:dF(a[0].relay.protocol).batchSubscribe,params:{topics:a.map(a=>a.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:b});try{await await aB(new Promise(a=>{this.relayer.request(b).catch(a=>this.logger.warn(a)).then(a)}),this.subscribeTimeout,"rpcBatchSubscribe failed, please try again")}catch{this.relayer.events.emit(eR.connection_stalled)}}async rpcBatchFetchMessages(a){let b;if(!a.length)return;let c={method:dF(a[0].relay.protocol).batchFetchMessages,params:{topics:a.map(a=>a.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:c});try{b=await await aB(new Promise((a,b)=>{this.relayer.request(c).catch(a=>{this.logger.warn(a),b(a)}).then(a)}),this.subscribeTimeout,"rpcBatchFetchMessages failed, please try again")}catch{this.relayer.events.emit(eR.connection_stalled)}return b}rpcUnsubscribe(a,b,c){let d={method:dF(c.protocol).unsubscribe,params:{topic:a,id:b}};return this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:d}),this.relayer.request(d)}onSubscribe(a,b){this.setSubscription(a,gu(gt({},b),{id:a})),this.pending.delete(b.topic)}onBatchSubscribe(a){a.length&&a.forEach(a=>{this.setSubscription(a.id,gt({},a)),this.pending.delete(a.topic)})}async onUnsubscribe(a,b,c){this.events.removeAllListeners(b),this.hasSubscription(b,a)&&this.deleteSubscription(b,c),await this.relayer.messages.del(a)}async setRelayerSubscriptions(a){await this.relayer.core.storage.setItem(this.storageKey,a)}async getRelayerSubscriptions(){return await this.relayer.core.storage.getItem(this.storageKey)}setSubscription(a,b){this.logger.debug("Setting subscription"),this.logger.trace({type:"method",method:"setSubscription",id:a,subscription:b}),this.addSubscription(a,b)}addSubscription(a,b){this.subscriptions.set(a,gt({},b)),this.topicMap.set(b.topic,a),this.events.emit(eX.created,b)}getSubscription(a){this.logger.debug("Getting subscription"),this.logger.trace({type:"method",method:"getSubscription",id:a});let b=this.subscriptions.get(a);if(!b){let{message:b}=dZ("NO_MATCHING_KEY",`${this.name}: ${a}`);throw Error(b)}return b}deleteSubscription(a,b){this.logger.debug("Deleting subscription"),this.logger.trace({type:"method",method:"deleteSubscription",id:a,reason:b});let c=this.getSubscription(a);this.subscriptions.delete(a),this.topicMap.delete(c.topic,a),this.events.emit(eX.deleted,gu(gt({},c),{reason:b}))}async persist(){await this.setRelayerSubscriptions(this.values),this.events.emit(eX.sync)}async onRestart(){if(this.cached.length){let a=[...this.cached],b=Math.ceil(this.cached.length/this.batchSubscribeTopicsLimit);for(let c=0;c<b;c++){let b=a.splice(0,this.batchSubscribeTopicsLimit);await this.batchSubscribe(b)}}this.events.emit(eX.resubscribed)}async restore(){try{let a=await this.getRelayerSubscriptions();if(typeof a>"u"||!a.length)return;if(this.subscriptions.size){let{message:a}=dZ("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(a),this.logger.error(`${this.name}: ${JSON.stringify(this.values)}`),Error(a)}this.cached=a,this.logger.debug(`Successfully Restored subscriptions for ${this.name}`),this.logger.trace({type:"method",method:"restore",subscriptions:this.values})}catch(a){this.logger.debug(`Failed to Restore subscriptions for ${this.name}`),this.logger.error(a)}}async batchSubscribe(a){a.length&&(await this.rpcBatchSubscribe(a),this.onBatchSubscribe(await Promise.all(a.map(async a=>gu(gt({},a),{id:await this.getSubscriptionId(a.topic)})))))}async batchFetchMessages(a){var b;if(!a.length)return;this.logger.trace(`Fetching batch messages for ${a.length} subscriptions`);let c=await this.rpcBatchFetchMessages(a);c&&c.messages&&(await (b=(0,d.toMiliseconds)(d.ONE_SECOND),new Promise(a=>setTimeout(a,b))),await this.relayer.handleBatchMessageEvents(c.messages))}async onConnect(){await this.restart(),this.reset()}onDisconnect(){this.onDisable()}isInitialized(){if(!this.initialized){let{message:a}=dZ("NOT_INITIALIZED",this.name);throw Error(a)}}async restartToComplete(a){this.relayer.connected||this.relayer.connecting||(this.cached.push(a),await this.relayer.transportOpen())}async getClientId(){return this.clientId||(this.clientId=await this.relayer.core.crypto.getClientId()),this.clientId}async getSubscriptionId(a){return dv(a+await this.getClientId())}}var gx=Object.defineProperty,gy=Object.getOwnPropertySymbols,gz=Object.prototype.hasOwnProperty,gA=Object.prototype.propertyIsEnumerable,gB=(a,b,c)=>b in a?gx(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c,gC=(a,b)=>{for(var c in b||(b={}))gz.call(b,c)&&gB(a,c,b[c]);if(gy)for(var c of gy(b))gA.call(b,c)&&gB(a,c,b[c]);return a},gD=(a,b,c)=>gB(a,"symbol"!=typeof b?b+"":b,c);class gE extends et{constructor(c){super(c),gD(this,"protocol","wc"),gD(this,"version",2),gD(this,"core"),gD(this,"logger"),gD(this,"events",new b.EventEmitter),gD(this,"provider"),gD(this,"messages"),gD(this,"subscriber"),gD(this,"publisher"),gD(this,"name","relayer"),gD(this,"transportExplicitlyClosed",!1),gD(this,"initialized",!1),gD(this,"connectionAttemptInProgress",!1),gD(this,"relayUrl"),gD(this,"projectId"),gD(this,"packageName"),gD(this,"bundleId"),gD(this,"hasExperiencedNetworkDisruption",!1),gD(this,"pingTimeout"),gD(this,"heartBeatTimeout",(0,d.toMiliseconds)(d.THIRTY_SECONDS+d.FIVE_SECONDS)),gD(this,"reconnectTimeout"),gD(this,"connectPromise"),gD(this,"reconnectInProgress",!1),gD(this,"requestsInFlight",[]),gD(this,"connectTimeout",(0,d.toMiliseconds)(15*d.ONE_SECOND)),gD(this,"request",async a=>{var b,c;this.logger.debug("Publishing Request Payload");let d=a.id||(0,eG.getBigIntRpcId)().toString();await this.toEstablishConnection();try{this.logger.trace({id:d,method:a.method,topic:null==(b=a.params)?void 0:b.topic},"relayer.request - publishing...");let e=`${d}:${(null==(c=a.params)?void 0:c.tag)||""}`;this.requestsInFlight.push(e);let f=await this.provider.request(a);return this.requestsInFlight=this.requestsInFlight.filter(a=>a!==e),f}catch(a){throw this.logger.debug(`Failed to Publish Request: ${d}`),a}}),gD(this,"resetPingTimeout",()=>{aq()&&(clearTimeout(this.pingTimeout),this.pingTimeout=setTimeout(()=>{var a,b,c,d;try{this.logger.debug({},"pingTimeout: Connection stalled, terminating..."),null==(d=null==(c=null==(b=null==(a=this.provider)?void 0:a.connection)?void 0:b.socket)?void 0:c.terminate)||d.call(c)}catch(a){this.logger.warn(a,a?.message)}},this.heartBeatTimeout))}),gD(this,"onPayloadHandler",a=>{this.onProviderPayload(a),this.resetPingTimeout()}),gD(this,"onConnectHandler",()=>{this.logger.warn({},"Relayer connected 🛜"),this.startPingTimeout(),this.events.emit(eR.connect)}),gD(this,"onDisconnectHandler",()=>{this.logger.warn({},"Relayer disconnected 🛑"),this.requestsInFlight=[],this.onProviderDisconnect()}),gD(this,"onProviderErrorHandler",a=>{this.logger.fatal(`Fatal socket error: ${a.message}`),this.events.emit(eR.error,a),this.logger.fatal("Fatal socket error received, closing transport"),this.transportClose()}),gD(this,"registerProviderListeners",()=>{this.provider.on(eS.payload,this.onPayloadHandler),this.provider.on(eS.connect,this.onConnectHandler),this.provider.on(eS.disconnect,this.onDisconnectHandler),this.provider.on(eS.error,this.onProviderErrorHandler)}),this.core=c.core,this.logger="u">typeof c.logger&&"string"!=typeof c.logger?(0,ej.generateChildLogger)(c.logger,this.name):(0,ek.pino)((0,ej.getDefaultLoggerOptions)({level:c.logger||"error"})),this.messages=new f7(this.logger,c.core),this.subscriber=new gw(this,this.logger),this.publisher=new gi(this,this.logger),this.relayUrl=c?.relayUrl||eQ,this.projectId=c.projectId,ar()&&"u">typeof(null==a.g?void 0:a.g.Platform)&&(null==a.g?void 0:a.g.Platform.OS)==="android"?this.packageName=au():ar()&&"u">typeof(null==a.g?void 0:a.g.Platform)&&(null==a.g?void 0:a.g.Platform.OS)==="ios"&&(this.bundleId=au()),this.provider={}}async init(){if(this.logger.trace("Initialized"),this.registerEventListeners(),await Promise.all([this.messages.init(),this.subscriber.init()]),this.initialized=!0,this.subscriber.hasAnyTopics)try{await this.transportOpen()}catch(a){this.logger.warn(a,a?.message)}}get context(){return(0,ej.getLoggerContext)(this.logger)}get connected(){var a,b,c;return(null==(c=null==(b=null==(a=this.provider)?void 0:a.connection)?void 0:b.socket)?void 0:c.readyState)===1}get connecting(){var a,b,c;return(null==(c=null==(b=null==(a=this.provider)?void 0:a.connection)?void 0:b.socket)?void 0:c.readyState)===0||void 0!==this.connectPromise}async publish(a,b,c){this.isInitialized(),await this.publisher.publish(a,b,c),await this.recordMessageEvent({topic:a,message:b,publishedAt:Date.now(),transportType:eU.relay},eV.outbound)}async subscribe(a,b){var c,d,e;this.isInitialized(),null!=b&&b.transportType&&b?.transportType!=="relay"||await this.toEstablishConnection();let f=typeof(null==(c=b?.internal)?void 0:c.throwOnFailedPublish)>"u"||(null==(d=b?.internal)?void 0:d.throwOnFailedPublish),g=(null==(e=this.subscriber.topicMap.get(a))?void 0:e[0])||"",h,i=b=>{b.topic===a&&(this.subscriber.off(eX.created,i),h())};return await Promise.all([new Promise(a=>{h=a,this.subscriber.on(eX.created,i)}),new Promise(async(c,d)=>{g=await this.subscriber.subscribe(a,gC({internal:{throwOnFailedPublish:f}},b)).catch(a=>{f&&d(a)})||g,c()})]),g}async unsubscribe(a,b){this.isInitialized(),await this.subscriber.unsubscribe(a,b)}on(a,b){this.events.on(a,b)}once(a,b){this.events.once(a,b)}off(a,b){this.events.off(a,b)}removeListener(a,b){this.events.removeListener(a,b)}async transportDisconnect(){this.provider.disconnect&&(this.hasExperiencedNetworkDisruption||this.connected)?await aB(this.provider.disconnect(),2e3,"provider.disconnect()").catch(()=>this.onProviderDisconnect()):this.onProviderDisconnect()}async transportClose(){this.transportExplicitlyClosed=!0,await this.transportDisconnect()}async transportOpen(a){if(!this.subscriber.hasAnyTopics)return void this.logger.warn("Starting WS connection skipped because the client has no topics to work with.");if(this.connectPromise?(this.logger.debug({},"Waiting for existing connection attempt to resolve..."),await this.connectPromise,this.logger.debug({},"Existing connection attempt resolved")):(this.connectPromise=new Promise(async(b,c)=>{await this.connect(a).then(b).catch(c).finally(()=>{this.connectPromise=void 0})}),await this.connectPromise),!this.connected)throw Error(`Couldn't establish socket connection to the relay server: ${this.relayUrl}`)}async restartTransport(a){this.logger.debug({},"Restarting transport..."),this.connectionAttemptInProgress||(this.relayUrl=a||this.relayUrl,await this.confirmOnlineStateOrThrow(),await this.transportClose(),await this.transportOpen())}async confirmOnlineStateOrThrow(){if(!await ed())throw Error("No internet connection detected. Please restart your network and try again.")}async handleBatchMessageEvents(a){if(a?.length===0)return void this.logger.trace("Batch message events is empty. Ignoring...");let b=a.sort((a,b)=>a.publishedAt-b.publishedAt);for(let a of(this.logger.debug(`Batch of ${b.length} message events sorted`),b))try{await this.onMessageEvent(a)}catch(a){this.logger.warn(a,"Error while processing batch message event: "+a?.message)}this.logger.trace(`Batch of ${b.length} message events processed`)}async onLinkMessageEvent(a,b){let{topic:c}=a;if(!b.sessionExists){let a=aE(d.FIVE_MINUTES);await this.core.pairing.pairings.set(c,{topic:c,expiry:a,relay:{protocol:"irn"},active:!1})}this.events.emit(eR.message,a),await this.recordMessageEvent(a,eV.inbound)}async connect(a){await this.confirmOnlineStateOrThrow(),a&&a!==this.relayUrl&&(this.relayUrl=a,await this.transportDisconnect()),this.connectionAttemptInProgress=!0,this.transportExplicitlyClosed=!1;let b=1;for(;b<6;){try{if(this.transportExplicitlyClosed)break;this.logger.debug({},`Connecting to ${this.relayUrl}, attempt: ${b}...`),await this.createProvider(),await new Promise(async(a,b)=>{let c=()=>{b(Error("Connection interrupted while trying to subscribe"))};this.provider.once(eS.disconnect,c),await aB(new Promise((a,b)=>{this.provider.connect().then(a).catch(b)}),this.connectTimeout,`Socket stalled when trying to connect to ${this.relayUrl}`).catch(a=>{b(a)}).finally(()=>{this.provider.off(eS.disconnect,c),clearTimeout(this.reconnectTimeout)}),await new Promise(async(a,b)=>{let c=()=>{b(Error("Connection interrupted while trying to subscribe"))};this.provider.once(eS.disconnect,c),await this.subscriber.start().then(a).catch(b).finally(()=>{this.provider.off(eS.disconnect,c)})}),this.hasExperiencedNetworkDisruption=!1,a()})}catch(a){await this.subscriber.stop(),this.logger.warn({},a.message),this.hasExperiencedNetworkDisruption=!0}finally{this.connectionAttemptInProgress=!1}if(this.connected){this.logger.debug({},`Connected to ${this.relayUrl} successfully on attempt: ${b}`);break}await new Promise(a=>setTimeout(a,(0,d.toMiliseconds)(+b))),b++}}startPingTimeout(){var a,b,c,d,e;if(aq())try{null!=(b=null==(a=this.provider)?void 0:a.connection)&&b.socket&&(null==(e=null==(d=null==(c=this.provider)?void 0:c.connection)?void 0:d.socket)||e.on("ping",()=>{this.resetPingTimeout()})),this.resetPingTimeout()}catch(a){this.logger.warn(a,a?.message)}}async createProvider(){this.provider.connection&&this.unregisterProviderListeners();let a=await this.core.crypto.signJWT(this.relayUrl);this.provider=new eF.JsonRpcProvider(new eI.default(function({protocol:a,version:b,relayUrl:c,sdkVersion:d,auth:e,projectId:f,useOnCloseEvent:g,bundleId:h,packageName:i}){let j=c.split("?"),k=aw(a,b,d),l=function(a,b){let c=new URLSearchParams(a);for(let a of Object.keys(b).sort())if(b.hasOwnProperty(a)){let d=b[a];void 0!==d&&c.set(a,d)}return c.toString()}(j[1]||"",{auth:e,ua:k,projectId:f,useOnCloseEvent:g||void 0,packageName:i||void 0,bundleId:h||void 0});return j[0]+"?"+l}({sdkVersion:eT,protocol:this.protocol,version:this.version,relayUrl:this.relayUrl,projectId:this.projectId,auth:a,useOnCloseEvent:!0,bundleId:this.bundleId,packageName:this.packageName}))),this.registerProviderListeners()}async recordMessageEvent(a,b){let{topic:c,message:d}=a;await this.messages.set(c,d,b)}async shouldIgnoreMessageEvent(a){let{topic:b,message:c}=a;if(!c||0===c.length)return this.logger.warn(`Ignoring invalid/empty message: ${c}`),!0;if(!await this.subscriber.isKnownTopic(b))return this.logger.warn(`Ignoring message for unknown topic ${b}`),!0;let d=this.messages.has(b,c);return d&&this.logger.warn(`Ignoring duplicate message: ${c}`),d}async onProviderPayload(a){if(this.logger.debug("Incoming Relay Payload"),this.logger.trace({type:"payload",direction:"incoming",payload:a}),(0,eH.isJsonRpcRequest)(a)){if(!a.method.endsWith("_subscription"))return;let b=a.params,{topic:c,message:d,publishedAt:e,attestation:f}=b.data,g={topic:c,message:d,publishedAt:e,transportType:eU.relay,attestation:f};this.logger.debug("Emitting Relayer Payload"),this.logger.trace(gC({type:"event",event:b.id},g)),this.events.emit(b.id,g),await this.acknowledgePayload(a),await this.onMessageEvent(g)}else(0,eH.isJsonRpcResponse)(a)&&this.events.emit(eR.message_ack,a)}async onMessageEvent(a){await this.shouldIgnoreMessageEvent(a)||(await this.recordMessageEvent(a,eV.inbound),this.events.emit(eR.message,a))}async acknowledgePayload(a){let b=(0,eG.formatJsonRpcResult)(a.id,!0);await this.provider.connection.send(b)}unregisterProviderListeners(){this.provider.off(eS.payload,this.onPayloadHandler),this.provider.off(eS.connect,this.onConnectHandler),this.provider.off(eS.disconnect,this.onDisconnectHandler),this.provider.off(eS.error,this.onProviderErrorHandler),clearTimeout(this.pingTimeout)}async registerEventListeners(){let b=await ed();(function(b){var c,d;switch(at()){case ap.browser:c=b,!ar()&&as()&&(window.addEventListener("online",()=>c(!0)),window.addEventListener("offline",()=>c(!1)));break;case ap.reactNative:d=b,ar()&&null!=a.g&&a.g.NetInfo&&a.g?.NetInfo.addEventListener(a=>d(a?.isConnected));case ap.node:}})(async a=>{b!==a&&(b=a,a?await this.transportOpen().catch(a=>this.logger.error(a,a?.message)):(this.hasExperiencedNetworkDisruption=!0,await this.transportDisconnect(),this.transportExplicitlyClosed=!1))}),this.core.heartbeat.on(eh.HEARTBEAT_EVENTS.pulse,async()=>{var a;if(!this.transportExplicitlyClosed&&!this.connected&&(!(as()&&(0,e.getDocument)())||(null==(a=(0,e.getDocument)())?void 0:a.visibilityState)==="visible"))try{await this.confirmOnlineStateOrThrow(),await this.transportOpen()}catch(a){this.logger.warn(a,a?.message)}})}async onProviderDisconnect(){clearTimeout(this.pingTimeout),this.events.emit(eR.disconnect),this.connectionAttemptInProgress=!1,!this.reconnectInProgress&&(this.reconnectInProgress=!0,await this.subscriber.stop(),this.subscriber.hasAnyTopics&&(this.transportExplicitlyClosed||(this.reconnectTimeout=setTimeout(async()=>{await this.transportOpen().catch(a=>this.logger.error(a,a?.message)),this.reconnectTimeout=void 0,this.reconnectInProgress=!1},(0,d.toMiliseconds)(.1)))))}isInitialized(){if(!this.initialized){let{message:a}=dZ("NOT_INITIALIZED",this.name);throw Error(a)}}async toEstablishConnection(){if(await this.confirmOnlineStateOrThrow(),!this.connected){if(this.connectPromise)return void await this.connectPromise;await this.connect()}}}function gF(){}function gG(a){if(!a||"object"!=typeof a)return!1;let b=Object.getPrototypeOf(a);return(null===b||b===Object.prototype||null===Object.getPrototypeOf(b))&&"[object Object]"===Object.prototype.toString.call(a)}function gH(a){return Object.getOwnPropertySymbols(a).filter(b=>Object.prototype.propertyIsEnumerable.call(a,b))}function gI(a){return null==a?void 0===a?"[object Undefined]":"[object Null]":Object.prototype.toString.call(a)}let gJ="[object Arguments]",gK="[object Object]";var gL=Object.defineProperty,gM=Object.getOwnPropertySymbols,gN=Object.prototype.hasOwnProperty,gO=Object.prototype.propertyIsEnumerable,gP=(a,b,c)=>b in a?gL(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c,gQ=(a,b)=>{for(var c in b||(b={}))gN.call(b,c)&&gP(a,c,b[c]);if(gM)for(var c of gM(b))gO.call(b,c)&&gP(a,c,b[c]);return a},gR=(a,b,c)=>gP(a,"symbol"!=typeof b?b+"":b,c);class gS extends eu{constructor(a,b,c,d=eK,e){super(a,b,c,d),this.core=a,this.logger=b,this.name=c,gR(this,"map",new Map),gR(this,"version","0.3"),gR(this,"cached",[]),gR(this,"initialized",!1),gR(this,"getKey"),gR(this,"storagePrefix",eK),gR(this,"recentlyDeleted",[]),gR(this,"recentlyDeletedLimit",200),gR(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(a=>{this.getKey&&null!==a&&!d1(a)?this.map.set(this.getKey(a),a):function(a){var b;return null==(b=a?.proposer)?void 0:b.publicKey}(a)?this.map.set(a.id,a):a?.topic&&this.map.set(a.topic,a)}),this.cached=[],this.initialized=!0)}),gR(this,"set",async(a,b)=>{this.isInitialized(),this.map.has(a)?await this.update(a,b):(this.logger.debug("Setting value"),this.logger.trace({type:"method",method:"set",key:a,value:b}),this.map.set(a,b),await this.persist())}),gR(this,"get",a=>(this.isInitialized(),this.logger.debug("Getting value"),this.logger.trace({type:"method",method:"get",key:a}),this.getData(a))),gR(this,"getAll",a=>(this.isInitialized(),a?this.values.filter(b=>Object.keys(a).every(c=>{var d;return d=b[c],function a(b,c,d,e,f,g,h){let i=h(b,c,d,e,f,g);if(void 0!==i)return i;if(typeof b==typeof c)switch(typeof b){case"bigint":case"string":case"boolean":case"symbol":case"undefined":case"function":return b===c;case"number":return b===c||Object.is(b,c)}return function b(c,d,e,f){if(Object.is(c,d))return!0;let g=gI(c),h=gI(d);if(g===gJ&&(g=gK),h===gJ&&(h=gK),g!==h)return!1;switch(g){case"[object String]":return c.toString()===d.toString();case"[object Number]":{let a=c.valueOf(),b=d.valueOf();return a===b||Number.isNaN(a)&&Number.isNaN(b)}case"[object Boolean]":case"[object Date]":case"[object Symbol]":return Object.is(c.valueOf(),d.valueOf());case"[object RegExp]":return c.source===d.source&&c.flags===d.flags;case"[object Function]":return c===d}let i=(e=e??new Map).get(c),j=e.get(d);if(null!=i&&null!=j)return i===d;e.set(c,d),e.set(d,c);try{switch(g){case"[object Map]":if(c.size!==d.size)return!1;for(let[b,g]of c.entries())if(!d.has(b)||!a(g,d.get(b),b,c,d,e,f))return!1;return!0;case"[object Set]":{if(c.size!==d.size)return!1;let b=Array.from(c.values()),g=Array.from(d.values());for(let h=0;h<b.length;h++){let i=b[h],j=g.findIndex(b=>a(i,b,void 0,c,d,e,f));if(-1===j)return!1;g.splice(j,1)}return!0}case"[object Array]":case"[object Uint8Array]":case"[object Uint8ClampedArray]":case"[object Uint16Array]":case"[object Uint32Array]":case"[object BigUint64Array]":case"[object Int8Array]":case"[object Int16Array]":case"[object Int32Array]":case"[object BigInt64Array]":case"[object Float32Array]":case"[object Float64Array]":if("u">typeof Buffer&&Buffer.isBuffer(c)!==Buffer.isBuffer(d)||c.length!==d.length)return!1;for(let b=0;b<c.length;b++)if(!a(c[b],d[b],b,c,d,e,f))return!1;return!0;case"[object ArrayBuffer]":return c.byteLength===d.byteLength&&b(new Uint8Array(c),new Uint8Array(d),e,f);case"[object DataView]":return c.byteLength===d.byteLength&&c.byteOffset===d.byteOffset&&b(new Uint8Array(c),new Uint8Array(d),e,f);case"[object Error]":return c.name===d.name&&c.message===d.message;case gK:{if(!(b(c.constructor,d.constructor,e,f)||gG(c)&&gG(d)))return!1;let g=[...Object.keys(c),...gH(c)],h=[...Object.keys(d),...gH(d)];if(g.length!==h.length)return!1;for(let b=0;b<g.length;b++){let h=g[b],i=c[h];if(!Object.hasOwn(d,h))return!1;let j=d[h];if(!a(i,j,h,c,d,e,f))return!1}return!0}default:return!1}}finally{e.delete(c),e.delete(d)}}(b,c,g,h)}(d,a[c],void 0,void 0,void 0,void 0,gF)})):this.values)),gR(this,"update",async(a,b)=>{this.isInitialized(),this.logger.debug("Updating value"),this.logger.trace({type:"method",method:"update",key:a,update:b});let c=gQ(gQ({},this.getData(a)),b);this.map.set(a,c),await this.persist()}),gR(this,"delete",async(a,b)=>{this.isInitialized(),this.map.has(a)&&(this.logger.debug("Deleting value"),this.logger.trace({type:"method",method:"delete",key:a,reason:b}),this.map.delete(a),this.addToRecentlyDeleted(a),await this.persist())}),this.logger=(0,ej.generateChildLogger)(b,this.name),this.storagePrefix=d,this.getKey=e}get context(){return(0,ej.getLoggerContext)(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get length(){return this.map.size}get keys(){return Array.from(this.map.keys())}get values(){return Array.from(this.map.values())}addToRecentlyDeleted(a){this.recentlyDeleted.push(a),this.recentlyDeleted.length>=this.recentlyDeletedLimit&&this.recentlyDeleted.splice(0,this.recentlyDeletedLimit/2)}async setDataStore(a){await this.core.storage.setItem(this.storageKey,a)}async getDataStore(){return await this.core.storage.getItem(this.storageKey)}getData(a){let b=this.map.get(a);if(!b){if(this.recentlyDeleted.includes(a)){let{message:b}=dZ("MISSING_OR_INVALID",`Record was recently deleted - ${this.name}: ${a}`);throw this.logger.error(b),Error(b)}let{message:b}=dZ("NO_MATCHING_KEY",`${this.name}: ${a}`);throw this.logger.error(b),Error(b)}return b}async persist(){await this.setDataStore(this.values)}async restore(){try{let a=await this.getDataStore();if(typeof a>"u"||!a.length)return;if(this.map.size){let{message:a}=dZ("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(a),Error(a)}this.cached=a,this.logger.debug(`Successfully Restored value for ${this.name}`),this.logger.trace({type:"method",method:"restore",value:this.values})}catch(a){this.logger.debug(`Failed to Restore value for ${this.name}`),this.logger.error(a)}}isInitialized(){if(!this.initialized){let{message:a}=dZ("NOT_INITIALIZED",this.name);throw Error(a)}}}var gT=Object.defineProperty,gU=(a,b,c)=>((a,b,c)=>b in a?gT(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c)(a,"symbol"!=typeof b?b+"":b,c);class gV{constructor(a,c){this.core=a,this.logger=c,gU(this,"name","pairing"),gU(this,"version","0.3"),gU(this,"events",new b.default),gU(this,"pairings"),gU(this,"initialized",!1),gU(this,"storagePrefix",eK),gU(this,"ignoredPayloadTypes",[1]),gU(this,"registeredMethods",[]),gU(this,"init",async()=>{this.initialized||(await this.pairings.init(),await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.initialized=!0,this.logger.trace("Initialized"))}),gU(this,"register",({methods:a})=>{this.isInitialized(),this.registeredMethods=[...new Set([...this.registeredMethods,...a])]}),gU(this,"create",async a=>{this.isInitialized();let b=dt(),c=await this.core.crypto.setSymKey(b),e=aE(d.FIVE_MINUTES),f={protocol:"irn"},g={topic:c,expiry:e,relay:f,active:!1,methods:a?.methods},h=dH({protocol:this.core.protocol,version:this.core.version,topic:c,symKey:b,relay:f,expiryTimestamp:e,methods:a?.methods});return this.events.emit(eZ.create,g),this.core.expirer.set(c,e),await this.pairings.set(c,g),await this.core.relayer.subscribe(c,{transportType:a?.transportType}),{topic:c,uri:h}}),gU(this,"pair",async a=>{let b;this.isInitialized();let c=this.core.eventClient.createEvent({properties:{topic:a?.uri,trace:[e3.pairing_started]}});this.isValidPair(a,c);let{topic:e,symKey:f,relay:g,expiryTimestamp:h,methods:i}=dG(a.uri);if(c.props.properties.topic=e,c.addTrace(e3.pairing_uri_validation_success),c.addTrace(e3.pairing_uri_not_expired),this.pairings.keys.includes(e)){if(b=this.pairings.get(e),c.addTrace(e3.existing_pairing),b.active)throw c.setError(e4.active_pairing_already_exists),Error(`Pairing already exists: ${e}. Please try again with a new connection URI.`);c.addTrace(e3.pairing_not_expired)}let j=h||aE(d.FIVE_MINUTES),k={topic:e,relay:g,expiry:j,active:!1,methods:i};this.core.expirer.set(e,j),await this.pairings.set(e,k),c.addTrace(e3.store_new_pairing),a.activatePairing&&await this.activate({topic:e}),this.events.emit(eZ.create,k),c.addTrace(e3.emit_inactive_pairing),this.core.crypto.keychain.has(e)||await this.core.crypto.setSymKey(f,e),c.addTrace(e3.subscribing_pairing_topic);try{await this.core.relayer.confirmOnlineStateOrThrow()}catch{c.setError(e4.no_internet_connection)}try{await this.core.relayer.subscribe(e,{relay:g})}catch(a){throw c.setError(e4.subscribe_pairing_topic_failure),a}return c.addTrace(e3.subscribe_pairing_topic_success),k}),gU(this,"activate",async({topic:a})=>{this.isInitialized();let b=aE(d.FIVE_MINUTES);this.core.expirer.set(a,b),await this.pairings.update(a,{active:!0,expiry:b})}),gU(this,"ping",async a=>{this.isInitialized(),await this.isValidPing(a),this.logger.warn("ping() is deprecated and will be removed in the next major release.");let{topic:b}=a;if(this.pairings.keys.includes(b)){let a=await this.sendRequest(b,"wc_pairingPing",{}),{done:c,resolve:d,reject:e}=aA();this.events.once(aG("pairing_ping",a),({error:a})=>{a?e(a):d()}),await c()}}),gU(this,"updateExpiry",async({topic:a,expiry:b})=>{this.isInitialized(),await this.pairings.update(a,{expiry:b})}),gU(this,"updateMetadata",async({topic:a,metadata:b})=>{this.isInitialized(),await this.pairings.update(a,{peerMetadata:b})}),gU(this,"getPairings",()=>(this.isInitialized(),this.pairings.values)),gU(this,"disconnect",async a=>{this.isInitialized(),await this.isValidDisconnect(a);let{topic:b}=a;this.pairings.keys.includes(b)&&(await this.sendRequest(b,"wc_pairingDelete",d$("USER_DISCONNECTED")),await this.deletePairing(b))}),gU(this,"formatUriFromPairing",a=>{this.isInitialized();let{topic:b,relay:c,expiry:d,methods:e}=a,f=this.core.crypto.keychain.get(b);return dH({protocol:this.core.protocol,version:this.core.version,topic:b,symKey:f,relay:c,expiryTimestamp:d,methods:e})}),gU(this,"sendRequest",async(a,b,c)=>{let d=(0,eG.formatJsonRpcRequest)(b,c),e=await this.core.crypto.encode(a,d),f=eY[b].req;return this.core.history.set(a,d),this.core.relayer.publish(a,e,f),d.id}),gU(this,"sendResult",async(a,b,c)=>{let d=(0,eG.formatJsonRpcResult)(a,c),e=await this.core.crypto.encode(b,d),f=eY[(await this.core.history.get(b,a)).request.method].res;await this.core.relayer.publish(b,e,f),await this.core.history.resolve(d)}),gU(this,"sendError",async(a,b,c)=>{let d=(0,eG.formatJsonRpcError)(a,c),e=await this.core.crypto.encode(b,d),f=(await this.core.history.get(b,a)).request.method,g=eY[f]?eY[f].res:eY.unregistered_method.res;await this.core.relayer.publish(b,e,g),await this.core.history.resolve(d)}),gU(this,"deletePairing",async(a,b)=>{await this.core.relayer.unsubscribe(a),await Promise.all([this.pairings.delete(a,d$("USER_DISCONNECTED")),this.core.crypto.deleteSymKey(a),b?Promise.resolve():this.core.expirer.del(a)])}),gU(this,"cleanup",async()=>{let a=this.pairings.getAll().filter(a=>aF(a.expiry));await Promise.all(a.map(a=>this.deletePairing(a.topic)))}),gU(this,"onRelayEventRequest",async a=>{let{topic:b,payload:c}=a;switch(c.method){case"wc_pairingPing":return await this.onPairingPingRequest(b,c);case"wc_pairingDelete":return await this.onPairingDeleteRequest(b,c);default:return await this.onUnknownRpcMethodRequest(b,c)}}),gU(this,"onRelayEventResponse",async a=>{let{topic:b,payload:c}=a,d=(await this.core.history.get(b,c.id)).request.method;return"wc_pairingPing"===d?this.onPairingPingResponse(b,c):this.onUnknownRpcMethodResponse(d)}),gU(this,"onPairingPingRequest",async(a,b)=>{let{id:c}=b;try{this.isValidPing({topic:a}),await this.sendResult(c,a,!0),this.events.emit(eZ.ping,{id:c,topic:a})}catch(b){await this.sendError(c,a,b),this.logger.error(b)}}),gU(this,"onPairingPingResponse",(a,b)=>{let{id:c}=b;setTimeout(()=>{(0,eH.isJsonRpcResult)(b)?this.events.emit(aG("pairing_ping",c),{}):(0,eH.isJsonRpcError)(b)&&this.events.emit(aG("pairing_ping",c),{error:b.error})},500)}),gU(this,"onPairingDeleteRequest",async(a,b)=>{let{id:c}=b;try{this.isValidDisconnect({topic:a}),await this.deletePairing(a),this.events.emit(eZ.delete,{id:c,topic:a})}catch(b){await this.sendError(c,a,b),this.logger.error(b)}}),gU(this,"onUnknownRpcMethodRequest",async(a,b)=>{let{id:c,method:d}=b;try{if(this.registeredMethods.includes(d))return;let b=d$("WC_METHOD_UNSUPPORTED",d);await this.sendError(c,a,b),this.logger.error(b)}catch(b){await this.sendError(c,a,b),this.logger.error(b)}}),gU(this,"onUnknownRpcMethodResponse",a=>{this.registeredMethods.includes(a)||this.logger.error(d$("WC_METHOD_UNSUPPORTED",a))}),gU(this,"isValidPair",(a,b)=>{var c;if(!d9(a)){let{message:c}=dZ("MISSING_OR_INVALID",`pair() params: ${a}`);throw b.setError(e4.malformed_pairing_uri),Error(c)}if(!function(a){function b(a){try{return"u">typeof new URL(a)}catch{return!1}}try{if(d2(a,!1)){if(b(a))return!0;let c=aN(a);return b(c)}}catch{}return!1}(a.uri)){let{message:c}=dZ("MISSING_OR_INVALID",`pair() uri: ${a.uri}`);throw b.setError(e4.malformed_pairing_uri),Error(c)}let e=dG(a?.uri);if(!(null!=(c=e?.relay)&&c.protocol)){let{message:a}=dZ("MISSING_OR_INVALID","pair() uri#relay-protocol");throw b.setError(e4.malformed_pairing_uri),Error(a)}if(!(null!=e&&e.symKey)){let{message:a}=dZ("MISSING_OR_INVALID","pair() uri#symKey");throw b.setError(e4.malformed_pairing_uri),Error(a)}if(null!=e&&e.expiryTimestamp&&(0,d.toMiliseconds)(e?.expiryTimestamp)<Date.now()){b.setError(e4.pairing_expired);let{message:a}=dZ("EXPIRED","pair() URI has expired. Please try again with a new connection URI.");throw Error(a)}}),gU(this,"isValidPing",async a=>{if(!d9(a)){let{message:b}=dZ("MISSING_OR_INVALID",`ping() params: ${a}`);throw Error(b)}let{topic:b}=a;await this.isValidPairingTopic(b)}),gU(this,"isValidDisconnect",async a=>{if(!d9(a)){let{message:b}=dZ("MISSING_OR_INVALID",`disconnect() params: ${a}`);throw Error(b)}let{topic:b}=a;await this.isValidPairingTopic(b)}),gU(this,"isValidPairingTopic",async a=>{if(!d2(a,!1)){let{message:b}=dZ("MISSING_OR_INVALID",`pairing topic should be a string: ${a}`);throw Error(b)}if(!this.pairings.keys.includes(a)){let{message:b}=dZ("NO_MATCHING_KEY",`pairing topic doesn't exist: ${a}`);throw Error(b)}if(aF(this.pairings.get(a).expiry)){await this.deletePairing(a);let{message:b}=dZ("EXPIRED",`pairing topic: ${a}`);throw Error(b)}}),this.core=a,this.logger=(0,ej.generateChildLogger)(c,this.name),this.pairings=new gS(this.core,this.logger,this.name,this.storagePrefix)}get context(){return(0,ej.getLoggerContext)(this.logger)}isInitialized(){if(!this.initialized){let{message:a}=dZ("NOT_INITIALIZED",this.name);throw Error(a)}}registerRelayerEvents(){this.core.relayer.on(eR.message,async a=>{let{topic:b,message:c,transportType:d}=a;if(this.pairings.keys.includes(b)&&d!==eU.link_mode&&!this.ignoredPayloadTypes.includes(this.core.crypto.getPayloadType(c)))try{let a=await this.core.crypto.decode(b,c);(0,eH.isJsonRpcRequest)(a)?(this.core.history.set(b,a),await this.onRelayEventRequest({topic:b,payload:a})):(0,eH.isJsonRpcResponse)(a)&&(await this.core.history.resolve(a),await this.onRelayEventResponse({topic:b,payload:a}),this.core.history.delete(b,a.id)),await this.core.relayer.messages.ack(b,c)}catch(a){this.logger.error(a)}})}registerExpirerEvents(){this.core.expirer.on(e_.expired,async a=>{let{topic:b}=aD(a.target);b&&this.pairings.keys.includes(b)&&(await this.deletePairing(b,!0),this.events.emit(eZ.expire,{topic:b}))})}}var gW=Object.defineProperty,gX=(a,b,c)=>((a,b,c)=>b in a?gW(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c)(a,"symbol"!=typeof b?b+"":b,c);class gY extends eq{constructor(a,c){super(a,c),this.core=a,this.logger=c,gX(this,"records",new Map),gX(this,"events",new b.EventEmitter),gX(this,"name","history"),gX(this,"version","0.3"),gX(this,"cached",[]),gX(this,"initialized",!1),gX(this,"storagePrefix",eK),gX(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(a=>this.records.set(a.id,a)),this.cached=[],this.registerEventListeners(),this.initialized=!0)}),gX(this,"set",(a,b,c)=>{if(this.isInitialized(),this.logger.debug("Setting JSON-RPC request history record"),this.logger.trace({type:"method",method:"set",topic:a,request:b,chainId:c}),this.records.has(b.id))return;let e={id:b.id,topic:a,request:{method:b.method,params:b.params||null},chainId:c,expiry:aE(d.THIRTY_DAYS)};this.records.set(e.id,e),this.persist(),this.events.emit(e$.created,e)}),gX(this,"resolve",async a=>{if(this.isInitialized(),this.logger.debug("Updating JSON-RPC response history record"),this.logger.trace({type:"method",method:"update",response:a}),!this.records.has(a.id))return;let b=await this.getRecord(a.id);typeof b.response>"u"&&(b.response=(0,eH.isJsonRpcError)(a)?{error:a.error}:{result:a.result},this.records.set(b.id,b),this.persist(),this.events.emit(e$.updated,b))}),gX(this,"get",async(a,b)=>(this.isInitialized(),this.logger.debug("Getting record"),this.logger.trace({type:"method",method:"get",topic:a,id:b}),await this.getRecord(b))),gX(this,"delete",(a,b)=>{this.isInitialized(),this.logger.debug("Deleting record"),this.logger.trace({type:"method",method:"delete",id:b}),this.values.forEach(c=>{c.topic===a&&("u">typeof b&&c.id!==b||(this.records.delete(c.id),this.events.emit(e$.deleted,c)))}),this.persist()}),gX(this,"exists",async(a,b)=>(this.isInitialized(),!!this.records.has(b)&&(await this.getRecord(b)).topic===a)),gX(this,"on",(a,b)=>{this.events.on(a,b)}),gX(this,"once",(a,b)=>{this.events.once(a,b)}),gX(this,"off",(a,b)=>{this.events.off(a,b)}),gX(this,"removeListener",(a,b)=>{this.events.removeListener(a,b)}),this.logger=(0,ej.generateChildLogger)(c,this.name)}get context(){return(0,ej.getLoggerContext)(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get size(){return this.records.size}get keys(){return Array.from(this.records.keys())}get values(){return Array.from(this.records.values())}get pending(){let a=[];return this.values.forEach(b=>{if("u">typeof b.response)return;let c={topic:b.topic,request:(0,eG.formatJsonRpcRequest)(b.request.method,b.request.params,b.id),chainId:b.chainId};return a.push(c)}),a}async setJsonRpcRecords(a){await this.core.storage.setItem(this.storageKey,a)}async getJsonRpcRecords(){return await this.core.storage.getItem(this.storageKey)}getRecord(a){this.isInitialized();let b=this.records.get(a);if(!b){let{message:b}=dZ("NO_MATCHING_KEY",`${this.name}: ${a}`);throw Error(b)}return b}async persist(){await this.setJsonRpcRecords(this.values),this.events.emit(e$.sync)}async restore(){try{let a=await this.getJsonRpcRecords();if(typeof a>"u"||!a.length)return;if(this.records.size){let{message:a}=dZ("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(a),Error(a)}this.cached=a,this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",records:this.values})}catch(a){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(a)}}registerEventListeners(){this.events.on(e$.created,a=>{let b=e$.created;this.logger.info(`Emitting ${b}`),this.logger.debug({type:"event",event:b,record:a})}),this.events.on(e$.updated,a=>{let b=e$.updated;this.logger.info(`Emitting ${b}`),this.logger.debug({type:"event",event:b,record:a})}),this.events.on(e$.deleted,a=>{let b=e$.deleted;this.logger.info(`Emitting ${b}`),this.logger.debug({type:"event",event:b,record:a})}),this.core.heartbeat.on(eh.HEARTBEAT_EVENTS.pulse,()=>{this.cleanup()})}cleanup(){try{this.isInitialized();let a=!1;this.records.forEach(b=>{(0,d.toMiliseconds)(b.expiry||0)-Date.now()<=0&&(this.logger.info(`Deleting expired history log: ${b.id}`),this.records.delete(b.id),this.events.emit(e$.deleted,b,!1),a=!0)}),a&&this.persist()}catch(a){this.logger.warn(a)}}isInitialized(){if(!this.initialized){let{message:a}=dZ("NOT_INITIALIZED",this.name);throw Error(a)}}}var gZ=Object.defineProperty,g$=(a,b,c)=>((a,b,c)=>b in a?gZ(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c)(a,"symbol"!=typeof b?b+"":b,c);class g_ extends ew{constructor(a,c){super(a,c),this.core=a,this.logger=c,g$(this,"expirations",new Map),g$(this,"events",new b.EventEmitter),g$(this,"name","expirer"),g$(this,"version","0.3"),g$(this,"cached",[]),g$(this,"initialized",!1),g$(this,"storagePrefix",eK),g$(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(a=>this.expirations.set(a.target,a)),this.cached=[],this.registerEventListeners(),this.initialized=!0)}),g$(this,"has",a=>{try{let b=this.formatTarget(a);return"u">typeof this.getExpiration(b)}catch{return!1}}),g$(this,"set",(a,b)=>{this.isInitialized();let c=this.formatTarget(a),d={target:c,expiry:b};this.expirations.set(c,d),this.checkExpiry(c,d),this.events.emit(e_.created,{target:c,expiration:d})}),g$(this,"get",a=>{this.isInitialized();let b=this.formatTarget(a);return this.getExpiration(b)}),g$(this,"del",a=>{if(this.isInitialized(),this.has(a)){let b=this.formatTarget(a),c=this.getExpiration(b);this.expirations.delete(b),this.events.emit(e_.deleted,{target:b,expiration:c})}}),g$(this,"on",(a,b)=>{this.events.on(a,b)}),g$(this,"once",(a,b)=>{this.events.once(a,b)}),g$(this,"off",(a,b)=>{this.events.off(a,b)}),g$(this,"removeListener",(a,b)=>{this.events.removeListener(a,b)}),this.logger=(0,ej.generateChildLogger)(c,this.name)}get context(){return(0,ej.getLoggerContext)(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get length(){return this.expirations.size}get keys(){return Array.from(this.expirations.keys())}get values(){return Array.from(this.expirations.values())}formatTarget(a){if("string"==typeof a)return aC("topic",a);if("number"==typeof a)return aC("id",a);let{message:b}=dZ("UNKNOWN_TYPE",`Target type: ${typeof a}`);throw Error(b)}async setExpirations(a){await this.core.storage.setItem(this.storageKey,a)}async getExpirations(){return await this.core.storage.getItem(this.storageKey)}async persist(){await this.setExpirations(this.values),this.events.emit(e_.sync)}async restore(){try{let a=await this.getExpirations();if(typeof a>"u"||!a.length)return;if(this.expirations.size){let{message:a}=dZ("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(a),Error(a)}this.cached=a,this.logger.debug(`Successfully Restored expirations for ${this.name}`),this.logger.trace({type:"method",method:"restore",expirations:this.values})}catch(a){this.logger.debug(`Failed to Restore expirations for ${this.name}`),this.logger.error(a)}}getExpiration(a){let b=this.expirations.get(a);if(!b){let{message:b}=dZ("NO_MATCHING_KEY",`${this.name}: ${a}`);throw this.logger.warn(b),Error(b)}return b}checkExpiry(a,b){let{expiry:c}=b;(0,d.toMiliseconds)(c)-Date.now()<=0&&this.expire(a,b)}expire(a,b){this.expirations.delete(a),this.events.emit(e_.expired,{target:a,expiration:b})}checkExpirations(){this.core.relayer.connected&&this.expirations.forEach((a,b)=>this.checkExpiry(b,a))}registerEventListeners(){this.core.heartbeat.on(eh.HEARTBEAT_EVENTS.pulse,()=>this.checkExpirations()),this.events.on(e_.created,a=>{let b=e_.created;this.logger.info(`Emitting ${b}`),this.logger.debug({type:"event",event:b,data:a}),this.persist()}),this.events.on(e_.expired,a=>{let b=e_.expired;this.logger.info(`Emitting ${b}`),this.logger.debug({type:"event",event:b,data:a}),this.persist()}),this.events.on(e_.deleted,a=>{let b=e_.deleted;this.logger.info(`Emitting ${b}`),this.logger.debug({type:"event",event:b,data:a}),this.persist()})}isInitialized(){if(!this.initialized){let{message:a}=dZ("NOT_INITIALIZED",this.name);throw Error(a)}}}var g0=Object.defineProperty,g1=(a,b,c)=>((a,b,c)=>b in a?g0(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c)(a,"symbol"!=typeof b?b+"":b,c);class g2 extends ex{constructor(a,b,c){super(a,b,c),this.core=a,this.logger=b,this.store=c,g1(this,"name","verify-api"),g1(this,"abortController"),g1(this,"isDevEnv"),g1(this,"verifyUrlV3",e1),g1(this,"storagePrefix",eK),g1(this,"version",2),g1(this,"publicKey"),g1(this,"fetchPromise"),g1(this,"init",async()=>{var a;this.isDevEnv||(this.publicKey=await this.store.getItem(this.storeKey),this.publicKey&&(0,d.toMiliseconds)(null==(a=this.publicKey)?void 0:a.expiresAt)<Date.now()&&(this.logger.debug("verify v2 public key expired"),await this.removePublicKey()))}),g1(this,"register",async a=>{if(!as()||this.isDevEnv)return;let b=window.location.origin,{id:c,decryptedId:f}=a,g=`${this.verifyUrlV3}/attestation?projectId=${this.core.projectId}&origin=${b}&id=${c}&decryptedId=${f}`;try{let a=(0,e.getDocument)(),b=this.startAbortTimer(5*d.ONE_SECOND),f=await new Promise((d,e)=>{let f=()=>{window.removeEventListener("message",i),a.body.removeChild(h),e("attestation aborted")};this.abortController.signal.addEventListener("abort",f);let h=a.createElement("iframe");h.src=g,h.style.display="none",h.addEventListener("error",f,{signal:this.abortController.signal});let i=e=>{if(e.data&&"string"==typeof e.data)try{let g=JSON.parse(e.data);if("verify_attestation"===g.type){if((0,_.decodeJWT)(g.attestation).payload.id!==c)return;clearInterval(b),a.body.removeChild(h),this.abortController.signal.removeEventListener("abort",f),window.removeEventListener("message",i),d(null===g.attestation?"":g.attestation)}}catch(a){this.logger.warn(a)}};a.body.appendChild(h),window.addEventListener("message",i,{signal:this.abortController.signal})});return this.logger.debug("jwt attestation",f),f}catch(a){this.logger.warn(a)}return""}),g1(this,"resolve",async a=>{if(this.isDevEnv)return"";let{attestationId:b,hash:c,encryptedId:d}=a;if(""===b)return void this.logger.debug("resolve: attestationId is empty, skipping");if(b){if((0,_.decodeJWT)(b).payload.id!==d)return;let a=await this.isValidJwtAttestation(b);if(a)return a.isVerified?a:void this.logger.warn("resolve: jwt attestation: origin url not verified")}if(!c)return;let e=this.getVerifyUrl(a?.verifyUrl);return this.fetchAttestation(c,e)}),g1(this,"fetchAttestation",async(a,b)=>{this.logger.debug(`resolving attestation: ${a} from url: ${b}`);let c=this.startAbortTimer(5*d.ONE_SECOND),e=await fetch(`${b}/attestation/${a}?v2Supported=true`,{signal:this.abortController.signal});return clearTimeout(c),200===e.status?await e.json():void 0}),g1(this,"getVerifyUrl",a=>{let b=a||e0;return e2.includes(b)||(this.logger.info(`verify url: ${b}, not included in trusted list, assigning default: ${e0}`),b=e0),b}),g1(this,"fetchPublicKey",async()=>{try{this.logger.debug(`fetching public key from: ${this.verifyUrlV3}`);let a=this.startAbortTimer(d.FIVE_SECONDS),b=await fetch(`${this.verifyUrlV3}/public-key`,{signal:this.abortController.signal});return clearTimeout(a),await b.json()}catch(a){this.logger.warn(a)}}),g1(this,"persistPublicKey",async a=>{this.logger.debug("persisting public key to local storage",a),await this.store.setItem(this.storeKey,a),this.publicKey=a}),g1(this,"removePublicKey",async()=>{this.logger.debug("removing verify v2 public key from storage"),await this.store.removeItem(this.storeKey),this.publicKey=void 0}),g1(this,"isValidJwtAttestation",async a=>{let b=await this.getPublicKey();try{if(b)return this.validateAttestation(a,b)}catch(a){this.logger.error(a),this.logger.warn("error validating attestation")}let c=await this.fetchAndPersistPublicKey();try{if(c)return this.validateAttestation(a,c)}catch(a){this.logger.error(a),this.logger.warn("error validating attestation")}}),g1(this,"getPublicKey",async()=>this.publicKey?this.publicKey:await this.fetchAndPersistPublicKey()),g1(this,"fetchAndPersistPublicKey",async()=>{if(this.fetchPromise)return await this.fetchPromise,this.publicKey;this.fetchPromise=new Promise(async a=>{let b=await this.fetchPublicKey();b&&(await this.persistPublicKey(b),a(b))});let a=await this.fetchPromise;return this.fetchPromise=void 0,a}),g1(this,"validateAttestation",(a,b)=>{let c=function(a,b){let[c,d,e]=a.split("."),f=Buffer.from(dz(e),"base64");if(64!==f.length)throw Error("Invalid signature length");let g=f.slice(0,32),h=f.slice(32,64),i=cd(`${c}.${d}`),j=function(a){let b=Buffer.from(a.x,"base64"),c=Buffer.from(a.y,"base64");return(0,ac.concat)([new Uint8Array([4]),b,c])}(b);if(!dm.verify((0,ac.concat)([g,h]),i,j))throw Error("Invalid signature");return(0,_.decodeJWT)(a).payload}(a,b.publicKey),e={hasExpired:(0,d.toMiliseconds)(c.exp)<Date.now(),payload:c};if(e.hasExpired)throw this.logger.warn("resolve: jwt attestation expired"),Error("JWT attestation expired");return{origin:e.payload.origin,isScam:e.payload.isScam,isVerified:e.payload.isVerified}}),this.logger=(0,ej.generateChildLogger)(b,this.name),this.abortController=new AbortController,this.isDevEnv=aM(),this.init()}get storeKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//verify:public:key"}get context(){return(0,ej.getLoggerContext)(this.logger)}startAbortTimer(a){return this.abortController=new AbortController,setTimeout(()=>this.abortController.abort(),(0,d.toMiliseconds)(a))}}var g3=Object.defineProperty,g4=(a,b,c)=>((a,b,c)=>b in a?g3(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c)(a,"symbol"!=typeof b?b+"":b,c);class g5 extends ey{constructor(a,b){super(a,b),this.projectId=a,this.logger=b,g4(this,"context","echo"),g4(this,"registerDeviceToken",async a=>{let{clientId:b,token:c,notificationType:d,enableEncrypted:e=!1}=a,f=`https://echo.walletconnect.com/${this.projectId}/clients`;await fetch(f,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:b,type:d,token:c,always_raw:e})})}),this.logger=(0,ej.generateChildLogger)(b,this.context)}}var g6=Object.defineProperty,g7=Object.getOwnPropertySymbols,g8=Object.prototype.hasOwnProperty,g9=Object.prototype.propertyIsEnumerable,ha=(a,b,c)=>b in a?g6(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c,hb=(a,b)=>{for(var c in b||(b={}))g8.call(b,c)&&ha(a,c,b[c]);if(g7)for(var c of g7(b))g9.call(b,c)&&ha(a,c,b[c]);return a},hc=(a,b,c)=>ha(a,"symbol"!=typeof b?b+"":b,c);class hd extends ez{constructor(a,b,c=!0){super(a,b,c),this.core=a,this.logger=b,hc(this,"context","event-client"),hc(this,"storagePrefix",eK),hc(this,"storageVersion",.1),hc(this,"events",new Map),hc(this,"shouldPersist",!1),hc(this,"init",async()=>{if(!aM())try{let a={eventId:aL(),timestamp:Date.now(),domain:this.getAppDomain(),props:{event:"INIT",type:"",properties:{client_id:await this.core.crypto.getClientId(),user_agent:aw(this.core.relayer.protocol,this.core.relayer.version,eT)}}};await this.sendEvent([a])}catch(a){this.logger.warn(a)}}),hc(this,"createEvent",a=>{let{event:b="ERROR",type:c="",properties:{topic:d,trace:e}}=a,f=aL(),g=this.core.projectId||"",h=hb({eventId:f,timestamp:Date.now(),props:{event:b,type:c,properties:{topic:d,trace:e}},bundleId:g,domain:this.getAppDomain()},this.setMethods(f));return this.telemetryEnabled&&(this.events.set(f,h),this.shouldPersist=!0),h}),hc(this,"getEvent",a=>{let{eventId:b,topic:c}=a;if(b)return this.events.get(b);let d=Array.from(this.events.values()).find(a=>a.props.properties.topic===c);if(d)return hb(hb({},d),this.setMethods(d.eventId))}),hc(this,"deleteEvent",a=>{let{eventId:b}=a;this.events.delete(b),this.shouldPersist=!0}),hc(this,"setEventListeners",()=>{this.core.heartbeat.on(eh.HEARTBEAT_EVENTS.pulse,async()=>{this.shouldPersist&&await this.persist(),this.events.forEach(a=>{(0,d.fromMiliseconds)(Date.now())-(0,d.fromMiliseconds)(a.timestamp)>86400&&(this.events.delete(a.eventId),this.shouldPersist=!0)})})}),hc(this,"setMethods",a=>({addTrace:b=>this.addTrace(a,b),setError:b=>this.setError(a,b)})),hc(this,"addTrace",(a,b)=>{let c=this.events.get(a);c&&(c.props.properties.trace.push(b),this.events.set(a,c),this.shouldPersist=!0)}),hc(this,"setError",(a,b)=>{let c=this.events.get(a);c&&(c.props.type=b,c.timestamp=Date.now(),this.events.set(a,c),this.shouldPersist=!0)}),hc(this,"persist",async()=>{await this.core.storage.setItem(this.storageKey,Array.from(this.events.values())),this.shouldPersist=!1}),hc(this,"restore",async()=>{try{let a=await this.core.storage.getItem(this.storageKey)||[];if(!a.length)return;a.forEach(a=>{this.events.set(a.eventId,hb(hb({},a),this.setMethods(a.eventId)))})}catch(a){this.logger.warn(a)}}),hc(this,"submit",async()=>{if(!this.telemetryEnabled||0===this.events.size)return;let a=[];for(let[b,c]of this.events)c.props.type&&a.push(c);if(0!==a.length)try{if((await this.sendEvent(a)).ok)for(let b of a)this.events.delete(b.eventId),this.shouldPersist=!0}catch(a){this.logger.warn(a)}}),hc(this,"sendEvent",async a=>{let b=this.getAppDomain()?"":"&sp=desktop";return await fetch(`https://pulse.walletconnect.org/batch?projectId=${this.core.projectId}&st=events_sdk&sv=js-${eT}${b}`,{method:"POST",body:JSON.stringify(a)})}),hc(this,"getAppDomain",()=>av().url),this.logger=(0,ej.generateChildLogger)(b,this.context),this.telemetryEnabled=c,c?this.restore().then(async()=>{await this.submit(),this.setEventListeners()}):this.persist()}get storageKey(){return this.storagePrefix+this.storageVersion+this.core.customStoragePrefix+"//"+this.context}}var he=Object.defineProperty,hf=Object.getOwnPropertySymbols,hg=Object.prototype.hasOwnProperty,hh=Object.prototype.propertyIsEnumerable,hi=(a,b,c)=>b in a?he(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c,hj=(a,b)=>{for(var c in b||(b={}))hg.call(b,c)&&hi(a,c,b[c]);if(hf)for(var c of hf(b))hh.call(b,c)&&hi(a,c,b[c]);return a},hk=(a,b,c)=>hi(a,"symbol"!=typeof b?b+"":b,c);class hl extends eo{constructor(a){var c;super(a),hk(this,"protocol","wc"),hk(this,"version",2),hk(this,"name",eJ),hk(this,"relayUrl"),hk(this,"projectId"),hk(this,"customStoragePrefix"),hk(this,"events",new b.EventEmitter),hk(this,"logger"),hk(this,"heartbeat"),hk(this,"relayer"),hk(this,"crypto"),hk(this,"storage"),hk(this,"history"),hk(this,"expirer"),hk(this,"pairing"),hk(this,"verify"),hk(this,"echoClient"),hk(this,"linkModeSupportedApps"),hk(this,"eventClient"),hk(this,"initialized",!1),hk(this,"logChunkController"),hk(this,"on",(a,b)=>this.events.on(a,b)),hk(this,"once",(a,b)=>this.events.once(a,b)),hk(this,"off",(a,b)=>this.events.off(a,b)),hk(this,"removeListener",(a,b)=>this.events.removeListener(a,b)),hk(this,"dispatchEnvelope",({topic:a,message:b,sessionExists:c})=>{if(!a||!b)return;let d={topic:a,message:b,publishedAt:Date.now(),transportType:eU.link_mode};this.relayer.onLinkMessageEvent(d,{sessionExists:c})});let d=this.getGlobalCore(a?.customStoragePrefix);if(d)try{return this.customStoragePrefix=d.customStoragePrefix,this.logger=d.logger,this.heartbeat=d.heartbeat,this.crypto=d.crypto,this.history=d.history,this.expirer=d.expirer,this.storage=d.storage,this.relayer=d.relayer,this.pairing=d.pairing,this.verify=d.verify,this.echoClient=d.echoClient,this.linkModeSupportedApps=d.linkModeSupportedApps,this.eventClient=d.eventClient,this.initialized=d.initialized,this.logChunkController=d.logChunkController,d}catch(a){console.warn("Failed to copy global core",a)}this.projectId=a?.projectId,this.relayUrl=a?.relayUrl||eQ,this.customStoragePrefix=null!=a&&a.customStoragePrefix?`:${a.customStoragePrefix}`:"";let e=(0,ej.getDefaultLoggerOptions)({level:"string"==typeof a?.logger&&a.logger?a.logger:eL.logger,name:eJ}),{logger:f,chunkLoggerController:g}=(0,ej.generatePlatformLogger)({opts:e,maxSizeInBytes:a?.maxLogBlobSizeInBytes,loggerOverride:a?.logger});this.logChunkController=g,null!=(c=this.logChunkController)&&c.downloadLogsBlobInBrowser&&(window.downloadLogsBlobInBrowser=async()=>{var a,b;null!=(a=this.logChunkController)&&a.downloadLogsBlobInBrowser&&(null==(b=this.logChunkController)||b.downloadLogsBlobInBrowser({clientId:await this.crypto.getClientId()}))}),this.logger=(0,ej.generateChildLogger)(f,this.name),this.heartbeat=new eh.HeartBeat,this.crypto=new f$(this,this.logger,a?.keychain),this.history=new gY(this,this.logger),this.expirer=new g_(this,this.logger),this.storage=null!=a&&a.storage?a.storage:new ei.default(hj(hj({},eM),a?.storageOptions)),this.relayer=new gE({core:this,logger:this.logger,relayUrl:this.relayUrl,projectId:this.projectId}),this.pairing=new gV(this,this.logger),this.verify=new g2(this,this.logger,this.storage),this.echoClient=new g5(this.projectId||"",this.logger),this.linkModeSupportedApps=[],this.eventClient=new hd(this,this.logger,a?.telemetryEnabled),this.setGlobalCore(this)}static async init(a){let b=new hl(a);await b.initialize();let c=await b.crypto.getClientId();return await b.storage.setItem("WALLETCONNECT_CLIENT_ID",c),b}get context(){return(0,ej.getLoggerContext)(this.logger)}async start(){this.initialized||await this.initialize()}async getLogsBlob(){var a;return null==(a=this.logChunkController)?void 0:a.logsToBlob({clientId:await this.crypto.getClientId()})}async addLinkModeSupportedApp(a){this.linkModeSupportedApps.includes(a)||(this.linkModeSupportedApps.push(a),await this.storage.setItem(eW,this.linkModeSupportedApps))}async initialize(){this.logger.trace("Initialized");try{await this.crypto.init(),await this.history.init(),await this.expirer.init(),await this.relayer.init(),await this.heartbeat.init(),await this.pairing.init(),this.linkModeSupportedApps=await this.storage.getItem(eW)||[],this.initialized=!0,this.logger.info("Core Initialization Success")}catch(a){throw this.logger.warn(`Core Initialization Failure at epoch ${Date.now()}`,a),this.logger.error(a.message),a}}getGlobalCore(a=""){try{if(this.isGlobalCoreDisabled())return;let b=`_walletConnectCore_${a}`,c=`${b}_count`;return globalThis[c]=(globalThis[c]||0)+1,globalThis[c]>1&&console.warn(`WalletConnect Core is already initialized. This is probably a mistake and can lead to unexpected behavior. Init() was called ${globalThis[c]} times.`),globalThis[b]}catch(a){console.warn("Failed to get global WalletConnect core",a);return}}setGlobalCore(a){var b;try{if(this.isGlobalCoreDisabled())return;let c=`_walletConnectCore_${(null==(b=a.opts)?void 0:b.customStoragePrefix)||""}`;globalThis[c]=a}catch(a){console.warn("Failed to set global WalletConnect core",a)}}isGlobalCoreDisabled(){try{return"u">typeof process&&"true"===process.env.DISABLE_GLOBAL_CORE}catch{return!0}}}let hm="client",hn=`wc@2:${hm}:`,ho={name:hm,logger:"error"},hp="WALLETCONNECT_DEEPLINK_CHOICE",hq=(d.THIRTY_DAYS,"Proposal expired"),hr=d.SEVEN_DAYS,hs={wc_sessionPropose:{req:{ttl:d.FIVE_MINUTES,prompt:!0,tag:1100},res:{ttl:d.FIVE_MINUTES,prompt:!1,tag:1101},reject:{ttl:d.FIVE_MINUTES,prompt:!1,tag:1120},autoReject:{ttl:d.FIVE_MINUTES,prompt:!1,tag:1121}},wc_sessionSettle:{req:{ttl:d.FIVE_MINUTES,prompt:!1,tag:1102},res:{ttl:d.FIVE_MINUTES,prompt:!1,tag:1103}},wc_sessionUpdate:{req:{ttl:d.ONE_DAY,prompt:!1,tag:1104},res:{ttl:d.ONE_DAY,prompt:!1,tag:1105}},wc_sessionExtend:{req:{ttl:d.ONE_DAY,prompt:!1,tag:1106},res:{ttl:d.ONE_DAY,prompt:!1,tag:1107}},wc_sessionRequest:{req:{ttl:d.FIVE_MINUTES,prompt:!0,tag:1108},res:{ttl:d.FIVE_MINUTES,prompt:!1,tag:1109}},wc_sessionEvent:{req:{ttl:d.FIVE_MINUTES,prompt:!0,tag:1110},res:{ttl:d.FIVE_MINUTES,prompt:!1,tag:1111}},wc_sessionDelete:{req:{ttl:d.ONE_DAY,prompt:!1,tag:1112},res:{ttl:d.ONE_DAY,prompt:!1,tag:1113}},wc_sessionPing:{req:{ttl:d.ONE_DAY,prompt:!1,tag:1114},res:{ttl:d.ONE_DAY,prompt:!1,tag:1115}},wc_sessionAuthenticate:{req:{ttl:d.ONE_HOUR,prompt:!0,tag:1116},res:{ttl:d.ONE_HOUR,prompt:!1,tag:1117},reject:{ttl:d.FIVE_MINUTES,prompt:!1,tag:1118},autoReject:{ttl:d.FIVE_MINUTES,prompt:!1,tag:1119}}},ht={min:d.FIVE_MINUTES,max:d.SEVEN_DAYS},hu={idle:"IDLE",active:"ACTIVE"},hv={eth_sendTransaction:{key:""},eth_sendRawTransaction:{key:""},wallet_sendCalls:{key:""},solana_signTransaction:{key:"signature"},solana_signAllTransactions:{key:"transactions"},solana_signAndSendTransaction:{key:"signature"}},hw=["wc_sessionPropose","wc_sessionRequest","wc_authRequest","wc_sessionAuthenticate"],hx="wc@1.5:auth:",hy=`${hx}:PUB_KEY`;var hz=Object.defineProperty,hA=Object.defineProperties,hB=Object.getOwnPropertyDescriptors,hC=Object.getOwnPropertySymbols,hD=Object.prototype.hasOwnProperty,hE=Object.prototype.propertyIsEnumerable,hF=(a,b,c)=>b in a?hz(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c,hG=(a,b)=>{for(var c in b||(b={}))hD.call(b,c)&&hF(a,c,b[c]);if(hC)for(var c of hC(b))hE.call(b,c)&&hF(a,c,b[c]);return a},hH=(a,b)=>hA(a,hB(b)),hI=(a,b,c)=>hF(a,"symbol"!=typeof b?b+"":b,c);class hJ extends eD{constructor(c){super(c),hI(this,"name","engine"),hI(this,"events",new b.default),hI(this,"initialized",!1),hI(this,"requestQueue",{state:hu.idle,queue:[]}),hI(this,"sessionRequestQueue",{state:hu.idle,queue:[]}),hI(this,"requestQueueDelay",d.ONE_SECOND),hI(this,"expectedPairingMethodMap",new Map),hI(this,"recentlyDeletedMap",new Map),hI(this,"recentlyDeletedLimit",200),hI(this,"relayMessageCache",[]),hI(this,"pendingSessions",new Map),hI(this,"init",async()=>{this.initialized||(await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.registerPairingEvents(),await this.registerLinkModeListeners(),this.client.core.pairing.register({methods:Object.keys(hs)}),this.initialized=!0,setTimeout(async()=>{await this.processPendingMessageEvents(),this.sessionRequestQueue.queue=this.getPendingSessionRequests(),this.processSessionRequestQueue()},(0,d.toMiliseconds)(this.requestQueueDelay)))}),hI(this,"connect",async a=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();let b=hH(hG({},a),{requiredNamespaces:a.requiredNamespaces||{},optionalNamespaces:a.optionalNamespaces||{}});await this.isValidConnect(b),b.optionalNamespaces=function(a,b){var c,d,e,f,g,h;let i=dV(a),j=dV(b),k={};for(let a of Object.keys(i).concat(Object.keys(j)))k[a]={chains:aH(null==(c=i[a])?void 0:c.chains,null==(d=j[a])?void 0:d.chains),methods:aH(null==(e=i[a])?void 0:e.methods,null==(f=j[a])?void 0:f.methods),events:aH(null==(g=i[a])?void 0:g.events,null==(h=j[a])?void 0:h.events)};return k}(b.requiredNamespaces,b.optionalNamespaces),b.requiredNamespaces={};let{pairingTopic:c,requiredNamespaces:e,optionalNamespaces:f,sessionProperties:g,scopedProperties:h,relays:i}=b,j=c,k,l=!1;try{if(j){let a=this.client.core.pairing.pairings.get(j);this.client.logger.warn("connect() with existing pairing topic is deprecated and will be removed in the next major release."),l=a.active}}catch(a){throw this.client.logger.error(`connect() -> pairing.get(${j}) failed`),a}if(!j||!l){let{topic:a,uri:b}=await this.client.core.pairing.create();j=a,k=b}if(!j){let{message:a}=dZ("NO_MATCHING_KEY",`connect() pairing topic: ${j}`);throw Error(a)}let m=await this.client.core.crypto.generateKeyPair(),n=hs.wc_sessionPropose.req.ttl||d.FIVE_MINUTES,o=aE(n),p=hH(hG(hG({requiredNamespaces:e,optionalNamespaces:f,relays:i??[{protocol:"irn"}],proposer:{publicKey:m,metadata:this.client.metadata},expiryTimestamp:o,pairingTopic:j},g&&{sessionProperties:g}),h&&{scopedProperties:h}),{id:(0,eG.payloadId)()}),q=aG("session_connect",p.id),{reject:r,resolve:s,done:t}=aA(n,hq),u=({id:a})=>{a===p.id&&(this.client.events.off("proposal_expire",u),this.pendingSessions.delete(p.id),this.events.emit(q,{error:{message:hq,code:0}}))};return this.client.events.on("proposal_expire",u),this.events.once(q,({error:a,session:b})=>{this.client.events.off("proposal_expire",u),a?r(a):b&&s(b)}),await this.sendRequest({topic:j,method:"wc_sessionPropose",params:p,throwOnFailedPublish:!0,clientRpcId:p.id}),await this.setProposal(p.id,p),{uri:k,approval:t}}),hI(this,"pair",async a=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{return await this.client.core.pairing.pair(a)}catch(a){throw this.client.logger.error("pair() failed"),a}}),hI(this,"approve",async a=>{var b,c,d;let e=this.client.core.eventClient.createEvent({properties:{topic:null==(b=a?.id)?void 0:b.toString(),trace:[e5.session_approve_started]}});try{this.isInitialized(),await this.confirmOnlineStateOrThrow()}catch(a){throw e.setError(e6.no_internet_connection),a}try{await this.isValidProposalId(a?.id)}catch(b){throw this.client.logger.error(`approve() -> proposal.get(${a?.id}) failed`),e.setError(e6.proposal_not_found),b}try{await this.isValidApprove(a)}catch(a){throw this.client.logger.error("approve() -> isValidApprove() failed"),e.setError(e6.session_approve_namespace_validation_failure),a}let{id:f,relayProtocol:g,namespaces:h,sessionProperties:i,scopedProperties:j,sessionConfig:k}=a,l=this.client.proposal.get(f);this.client.core.eventClient.deleteEvent({eventId:e.eventId});let{pairingTopic:m,proposer:n,requiredNamespaces:o,optionalNamespaces:p}=l,q=null==(c=this.client.core.eventClient)?void 0:c.getEvent({topic:m});q||(q=null==(d=this.client.core.eventClient)?void 0:d.createEvent({type:e5.session_approve_started,properties:{topic:m,trace:[e5.session_approve_started,e5.session_namespaces_validation_success]}}));let r=await this.client.core.crypto.generateKeyPair(),s=n.publicKey,t=await this.client.core.crypto.generateSharedKey(r,s),u=hG(hG(hG({relay:{protocol:g??"irn"},namespaces:h,controller:{publicKey:r,metadata:this.client.metadata},expiry:aE(hr)},i&&{sessionProperties:i}),j&&{scopedProperties:j}),k&&{sessionConfig:k}),v=eU.relay;q.addTrace(e5.subscribing_session_topic);try{await this.client.core.relayer.subscribe(t,{transportType:v})}catch(a){throw q.setError(e6.subscribe_session_topic_failure),a}q.addTrace(e5.subscribe_session_topic_success);let w=hH(hG({},u),{topic:t,requiredNamespaces:o,optionalNamespaces:p,pairingTopic:m,acknowledged:!1,self:u.controller,peer:{publicKey:n.publicKey,metadata:n.metadata},controller:r,transportType:eU.relay});await this.client.session.set(t,w),q.addTrace(e5.store_session);try{q.addTrace(e5.publishing_session_settle),await this.sendRequest({topic:t,method:"wc_sessionSettle",params:u,throwOnFailedPublish:!0}).catch(a=>{throw q?.setError(e6.session_settle_publish_failure),a}),q.addTrace(e5.session_settle_publish_success),q.addTrace(e5.publishing_session_approve),await this.sendResult({id:f,topic:m,result:{relay:{protocol:g??"irn"},responderPublicKey:r},throwOnFailedPublish:!0}).catch(a=>{throw q?.setError(e6.session_approve_publish_failure),a}),q.addTrace(e5.session_approve_publish_success)}catch(a){throw this.client.logger.error(a),this.client.session.delete(t,d$("USER_DISCONNECTED")),await this.client.core.relayer.unsubscribe(t),a}return this.client.core.eventClient.deleteEvent({eventId:q.eventId}),await this.client.core.pairing.updateMetadata({topic:m,metadata:n.metadata}),await this.client.proposal.delete(f,d$("USER_DISCONNECTED")),await this.client.core.pairing.activate({topic:m}),await this.setExpiry(t,aE(hr)),{topic:t,acknowledged:()=>Promise.resolve(this.client.session.get(t))}}),hI(this,"reject",async a=>{let b;this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidReject(a)}catch(a){throw this.client.logger.error("reject() -> isValidReject() failed"),a}let{id:c,reason:d}=a;try{b=this.client.proposal.get(c).pairingTopic}catch(a){throw this.client.logger.error(`reject() -> proposal.get(${c}) failed`),a}b&&(await this.sendError({id:c,topic:b,error:d,rpcOpts:hs.wc_sessionPropose.reject}),await this.client.proposal.delete(c,d$("USER_DISCONNECTED")))}),hI(this,"update",async a=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidUpdate(a)}catch(a){throw this.client.logger.error("update() -> isValidUpdate() failed"),a}let{topic:b,namespaces:c}=a,{done:d,resolve:e,reject:f}=aA(),g=(0,eG.payloadId)(),h=(0,eG.getBigIntRpcId)().toString(),i=this.client.session.get(b).namespaces;return this.events.once(aG("session_update",g),({error:a})=>{a?f(a):e()}),await this.client.session.update(b,{namespaces:c}),await this.sendRequest({topic:b,method:"wc_sessionUpdate",params:{namespaces:c},throwOnFailedPublish:!0,clientRpcId:g,relayRpcId:h}).catch(a=>{this.client.logger.error(a),this.client.session.update(b,{namespaces:i}),f(a)}),{acknowledged:d}}),hI(this,"extend",async a=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidExtend(a)}catch(a){throw this.client.logger.error("extend() -> isValidExtend() failed"),a}let{topic:b}=a,c=(0,eG.payloadId)(),{done:d,resolve:e,reject:f}=aA();return this.events.once(aG("session_extend",c),({error:a})=>{a?f(a):e()}),await this.setExpiry(b,aE(hr)),this.sendRequest({topic:b,method:"wc_sessionExtend",params:{},clientRpcId:c,throwOnFailedPublish:!0}).catch(a=>{f(a)}),{acknowledged:d}}),hI(this,"request",async a=>{this.isInitialized();try{await this.isValidRequest(a)}catch(a){throw this.client.logger.error("request() -> isValidRequest() failed"),a}let{chainId:b,request:c,topic:d,expiry:e=hs.wc_sessionRequest.req.ttl}=a,f=this.client.session.get(d);f?.transportType===eU.relay&&await this.confirmOnlineStateOrThrow();let g=(0,eG.payloadId)(),h=(0,eG.getBigIntRpcId)().toString(),{done:i,resolve:j,reject:k}=aA(e,"Request expired. Please try again.");this.events.once(aG("session_request",g),({error:a,result:b})=>{a?k(a):j(b)});let l="wc_sessionRequest",m=this.getAppLinkIfEnabled(f.peer.metadata,f.transportType);if(m)return await this.sendRequest({clientRpcId:g,relayRpcId:h,topic:d,method:l,params:{request:hH(hG({},c),{expiryTimestamp:aE(e)}),chainId:b},expiry:e,throwOnFailedPublish:!0,appLink:m}).catch(a=>k(a)),this.client.events.emit("session_request_sent",{topic:d,request:c,chainId:b,id:g}),await i();let n={request:hH(hG({},c),{expiryTimestamp:aE(e)}),chainId:b},o=this.shouldSetTVF(l,n);return await Promise.all([new Promise(async a=>{await this.sendRequest(hG({clientRpcId:g,relayRpcId:h,topic:d,method:l,params:n,expiry:e,throwOnFailedPublish:!0},o&&{tvf:this.getTVFParams(g,n)})).catch(a=>k(a)),this.client.events.emit("session_request_sent",{topic:d,request:c,chainId:b,id:g}),a()}),new Promise(async a=>{var b;if(!(null!=(b=f.sessionConfig)&&b.disableDeepLink)){let a=await aJ(this.client.core.storage,hp);await aI({id:g,topic:d,wcDeepLink:a})}a()}),i()]).then(a=>a[2])}),hI(this,"respond",async a=>{this.isInitialized(),await this.isValidRespond(a);let{topic:b,response:c}=a,{id:d}=c,e=this.client.session.get(b);e.transportType===eU.relay&&await this.confirmOnlineStateOrThrow();let f=this.getAppLinkIfEnabled(e.peer.metadata,e.transportType);(0,eH.isJsonRpcResult)(c)?await this.sendResult({id:d,topic:b,result:c.result,throwOnFailedPublish:!0,appLink:f}):(0,eH.isJsonRpcError)(c)&&await this.sendError({id:d,topic:b,error:c.error,appLink:f}),this.cleanupAfterResponse(a)}),hI(this,"ping",async a=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidPing(a)}catch(a){throw this.client.logger.error("ping() -> isValidPing() failed"),a}let{topic:b}=a;if(this.client.session.keys.includes(b)){let a=(0,eG.payloadId)(),c=(0,eG.getBigIntRpcId)().toString(),{done:d,resolve:e,reject:f}=aA();this.events.once(aG("session_ping",a),({error:a})=>{a?f(a):e()}),await Promise.all([this.sendRequest({topic:b,method:"wc_sessionPing",params:{},throwOnFailedPublish:!0,clientRpcId:a,relayRpcId:c}),d()])}else this.client.core.pairing.pairings.keys.includes(b)&&(this.client.logger.warn("ping() on pairing topic is deprecated and will be removed in the next major release."),await this.client.core.pairing.ping({topic:b}))}),hI(this,"emit",async a=>{this.isInitialized(),await this.confirmOnlineStateOrThrow(),await this.isValidEmit(a);let{topic:b,event:c,chainId:d}=a,e=(0,eG.getBigIntRpcId)().toString(),f=(0,eG.payloadId)();await this.sendRequest({topic:b,method:"wc_sessionEvent",params:{event:c,chainId:d},throwOnFailedPublish:!0,relayRpcId:e,clientRpcId:f})}),hI(this,"disconnect",async a=>{this.isInitialized(),await this.confirmOnlineStateOrThrow(),await this.isValidDisconnect(a);let{topic:b}=a;if(this.client.session.keys.includes(b))await this.sendRequest({topic:b,method:"wc_sessionDelete",params:d$("USER_DISCONNECTED"),throwOnFailedPublish:!0}),await this.deleteSession({topic:b,emitEvent:!1});else if(this.client.core.pairing.pairings.keys.includes(b))await this.client.core.pairing.disconnect({topic:b});else{let{message:a}=dZ("MISMATCHED_TOPIC",`Session or pairing topic not found: ${b}`);throw Error(a)}}),hI(this,"find",a=>(this.isInitialized(),this.client.session.getAll().filter(b=>(function(a,b){let{requiredNamespaces:c}=b,d=Object.keys(a.namespaces),e=Object.keys(c),f=!0;return!!ax(e,d)&&(d.forEach(b=>{let{accounts:d,methods:e,events:g}=a.namespaces[b],h=dS(d),i=c[b];ax(ag(b,i),h)&&ax(i.methods,e)&&ax(i.events,g)||(f=!1)}),f)})(b,a)))),hI(this,"getPendingSessionRequests",()=>this.client.pendingRequest.getAll()),hI(this,"authenticate",async(a,b)=>{var c,d,e;let f;this.isInitialized(),this.isValidAuthenticate(a);let g=b&&this.client.core.linkModeSupportedApps.includes(b)&&(null==(c=this.client.metadata.redirect)?void 0:c.linkMode),h=g?eU.link_mode:eU.relay;h===eU.relay&&await this.confirmOnlineStateOrThrow();let{chains:i,statement:j="",uri:k,domain:l,nonce:m,type:n,exp:o,nbf:p,methods:q=[],expiry:r}=a,s=[...a.resources||[]],{topic:t,uri:u}=await this.client.core.pairing.create({methods:["wc_sessionAuthenticate"],transportType:h});this.client.logger.info({message:"Generated new pairing",pairing:{topic:t,uri:u}});let v=await this.client.core.crypto.generateKeyPair(),w=du(v);if(await Promise.all([this.client.auth.authKeys.set(hy,{responseTopic:w,publicKey:v}),this.client.auth.pairingTopics.set(w,{topic:w,pairingTopic:t})]),await this.client.core.relayer.subscribe(w,{transportType:h}),this.client.logger.info(`sending request to new pairing topic: ${t}`),q.length>0){let{namespace:a}=ae(i[0]),b=by(function(a,b,c,d={}){return c?.sort((a,b)=>a.localeCompare(b)),{att:{[a]:function(a,b,c={}){return Object.assign({},...(b=b?.sort((a,b)=>a.localeCompare(b))).map(b=>({[`${a}/${b}`]:[c]})))}(b,c,d)}}}(a,"request",q));bC(s)&&(d=b,e=s.pop(),b=by(function(a,b){bx(a),bx(b);let c=Object.keys(a.att).concat(Object.keys(b.att)).sort((a,b)=>a.localeCompare(b)),d={att:{}};return c.forEach(c=>{var e,f;Object.keys((null==(e=a.att)?void 0:e[c])||{}).concat(Object.keys((null==(f=b.att)?void 0:f[c])||{})).sort((a,b)=>a.localeCompare(b)).forEach(e=>{var f,g;d.att[c]=bm(((a,b)=>{for(var c in b||(b={}))bp.call(b,c)&&br(a,c,b[c]);if(bo)for(var c of bo(b))bq.call(b,c)&&br(a,c,b[c]);return a})({},d.att[c]),bn({[e]:(null==(f=a.att[c])?void 0:f[e])||(null==(g=b.att[c])?void 0:g[e])}))})}),d}(bz(d),bz(e)))),s.push(b)}let x=r&&r>hs.wc_sessionAuthenticate.req.ttl?r:hs.wc_sessionAuthenticate.req.ttl,y={authPayload:{type:n??"caip122",chains:i,statement:j,aud:k,domain:l,version:"1",nonce:m,iat:new Date().toISOString(),exp:o,nbf:p,resources:s},requester:{publicKey:v,metadata:this.client.metadata},expiryTimestamp:aE(x)},z={requiredNamespaces:{},optionalNamespaces:{eip155:{chains:i,methods:[...new Set(["personal_sign",...q])],events:["chainChanged","accountsChanged"]}},relays:[{protocol:"irn"}],pairingTopic:t,proposer:{publicKey:v,metadata:this.client.metadata},expiryTimestamp:aE(hs.wc_sessionPropose.req.ttl),id:(0,eG.payloadId)()},{done:A,resolve:B,reject:C}=aA(x,"Request expired"),D=(0,eG.payloadId)(),E=aG("session_connect",z.id),F=aG("session_request",D),G=async({error:a,session:b})=>{this.events.off(F,H),a?C(a):b&&B({session:b})},H=async a=>{var c,d,e;let f;if(await this.deletePendingAuthRequest(D,{message:"fulfilled",code:0}),a.error){let b=d$("WC_METHOD_UNSUPPORTED","wc_sessionAuthenticate");return a.error.code===b.code?void 0:(this.events.off(E,G),C(a.error.message))}await this.deleteProposal(z.id),this.events.off(E,G);let{cacaos:g,responder:i}=a.result,j=[],k=[];for(let a of g){await bv({cacao:a,projectId:this.client.core.projectId})||(this.client.logger.error(a,"Signature verification failed"),C(d$("SESSION_SETTLEMENT_FAILED","Signature verification failed")));let{p:b}=a,c=bC(b.resources),d=[bt(b.iss)],e=bu(b.iss);if(c){let a=bA(c),b=bB(c);j.push(...a),d.push(...b)}for(let a of d)k.push(`${a}:${e}`)}let l=await this.client.core.crypto.generateSharedKey(v,i.publicKey);j.length>0&&(f={topic:l,acknowledged:!0,self:{publicKey:v,metadata:this.client.metadata},peer:i,controller:i.publicKey,expiry:aE(hr),requiredNamespaces:{},optionalNamespaces:{},relay:{protocol:"irn"},pairingTopic:t,namespaces:dW([...new Set(j)],[...new Set(k)]),transportType:h},await this.client.core.relayer.subscribe(l,{transportType:h}),await this.client.session.set(l,f),t&&await this.client.core.pairing.updateMetadata({topic:t,metadata:i.metadata}),f=this.client.session.get(l)),null!=(c=this.client.metadata.redirect)&&c.linkMode&&null!=(d=i.metadata.redirect)&&d.linkMode&&null!=(e=i.metadata.redirect)&&e.universal&&b&&(this.client.core.addLinkModeSupportedApp(i.metadata.redirect.universal),this.client.session.update(l,{transportType:eU.link_mode})),B({auths:g,session:f})};this.events.once(E,G),this.events.once(F,H);try{if(g){let a=(0,eG.formatJsonRpcRequest)("wc_sessionAuthenticate",y,D);this.client.core.history.set(t,a);let c=await this.client.core.crypto.encode("",a,{type:2,encoding:dr});f=dI(b,t,c)}else await Promise.all([this.sendRequest({topic:t,method:"wc_sessionAuthenticate",params:y,expiry:a.expiry,throwOnFailedPublish:!0,clientRpcId:D}),this.sendRequest({topic:t,method:"wc_sessionPropose",params:z,expiry:hs.wc_sessionPropose.req.ttl,throwOnFailedPublish:!0,clientRpcId:z.id})])}catch(a){throw this.events.off(E,G),this.events.off(F,H),a}return await this.setProposal(z.id,z),await this.setAuthRequest(D,{request:hH(hG({},y),{verifyContext:{}}),pairingTopic:t,transportType:h}),{uri:f??u,response:A}}),hI(this,"approveSessionAuthenticate",async a=>{let b,{id:c,auths:d}=a,e=this.client.core.eventClient.createEvent({properties:{topic:c.toString(),trace:[e7.authenticated_session_approve_started]}});try{this.isInitialized()}catch(a){throw e.setError(e8.no_internet_connection),a}let f=this.getPendingAuthRequest(c);if(!f)throw e.setError(e8.authenticated_session_pending_request_not_found),Error(`Could not find pending auth request with id ${c}`);let g=f.transportType||eU.relay;g===eU.relay&&await this.confirmOnlineStateOrThrow();let h=f.requester.publicKey,i=await this.client.core.crypto.generateKeyPair(),j=du(h),k={type:1,receiverPublicKey:h,senderPublicKey:i},l=[],m=[];for(let a of d){if(!await bv({cacao:a,projectId:this.client.core.projectId})){e.setError(e8.invalid_cacao);let a=d$("SESSION_SETTLEMENT_FAILED","Signature verification failed");throw await this.sendError({id:c,topic:j,error:a,encodeOpts:k}),Error(a.message)}e.addTrace(e7.cacaos_verified);let{p:b}=a,d=bC(b.resources),f=[bt(b.iss)],g=bu(b.iss);if(d){let a=bA(d),b=bB(d);l.push(...a),f.push(...b)}for(let a of f)m.push(`${a}:${g}`)}let n=await this.client.core.crypto.generateSharedKey(i,h);if(e.addTrace(e7.create_authenticated_session_topic),l?.length>0){b={topic:n,acknowledged:!0,self:{publicKey:i,metadata:this.client.metadata},peer:{publicKey:h,metadata:f.requester.metadata},controller:h,expiry:aE(hr),authentication:d,requiredNamespaces:{},optionalNamespaces:{},relay:{protocol:"irn"},pairingTopic:f.pairingTopic,namespaces:dW([...new Set(l)],[...new Set(m)]),transportType:g},e.addTrace(e7.subscribing_authenticated_session_topic);try{await this.client.core.relayer.subscribe(n,{transportType:g})}catch(a){throw e.setError(e8.subscribe_authenticated_session_topic_failure),a}e.addTrace(e7.subscribe_authenticated_session_topic_success),await this.client.session.set(n,b),e.addTrace(e7.store_authenticated_session),await this.client.core.pairing.updateMetadata({topic:f.pairingTopic,metadata:f.requester.metadata})}e.addTrace(e7.publishing_authenticated_session_approve);try{await this.sendResult({topic:j,id:c,result:{cacaos:d,responder:{publicKey:i,metadata:this.client.metadata}},encodeOpts:k,throwOnFailedPublish:!0,appLink:this.getAppLinkIfEnabled(f.requester.metadata,g)})}catch(a){throw e.setError(e8.authenticated_session_approve_publish_failure),a}return await this.client.auth.requests.delete(c,{message:"fulfilled",code:0}),await this.client.core.pairing.activate({topic:f.pairingTopic}),this.client.core.eventClient.deleteEvent({eventId:e.eventId}),{session:b}}),hI(this,"rejectSessionAuthenticate",async a=>{this.isInitialized();let{id:b,reason:c}=a,d=this.getPendingAuthRequest(b);if(!d)throw Error(`Could not find pending auth request with id ${b}`);d.transportType===eU.relay&&await this.confirmOnlineStateOrThrow();let e=d.requester.publicKey,f=await this.client.core.crypto.generateKeyPair(),g=du(e);await this.sendError({id:b,topic:g,error:c,encodeOpts:{type:1,receiverPublicKey:e,senderPublicKey:f},rpcOpts:hs.wc_sessionAuthenticate.reject,appLink:this.getAppLinkIfEnabled(d.requester.metadata,d.transportType)}),await this.client.auth.requests.delete(b,{message:"rejected",code:0}),await this.client.proposal.delete(b,d$("USER_DISCONNECTED"))}),hI(this,"formatAuthMessage",a=>{this.isInitialized();let{request:b,iss:c}=a;return bw(b,c)}),hI(this,"processRelayMessageCache",()=>{setTimeout(async()=>{if(0!==this.relayMessageCache.length)for(;this.relayMessageCache.length>0;)try{let a=this.relayMessageCache.shift();a&&await this.onRelayMessage(a)}catch(a){this.client.logger.error(a)}},50)}),hI(this,"cleanupDuplicatePairings",async a=>{if(a.pairingTopic)try{let b=this.client.core.pairing.pairings.get(a.pairingTopic),c=this.client.core.pairing.pairings.getAll().filter(c=>{var d,e;return(null==(d=c.peerMetadata)?void 0:d.url)&&(null==(e=c.peerMetadata)?void 0:e.url)===a.peer.metadata.url&&c.topic&&c.topic!==b.topic});if(0===c.length)return;this.client.logger.info(`Cleaning up ${c.length} duplicate pairing(s)`),await Promise.all(c.map(a=>this.client.core.pairing.disconnect({topic:a.topic}))),this.client.logger.info("Duplicate pairings clean up finished")}catch(a){this.client.logger.error(a)}}),hI(this,"deleteSession",async a=>{var b;let{topic:c,expirerHasDeleted:d=!1,emitEvent:e=!0,id:f=0}=a,{self:g}=this.client.session.get(c);await this.client.core.relayer.unsubscribe(c),await this.client.session.delete(c,d$("USER_DISCONNECTED")),this.addToRecentlyDeleted(c,"session"),this.client.core.crypto.keychain.has(g.publicKey)&&await this.client.core.crypto.deleteKeyPair(g.publicKey),this.client.core.crypto.keychain.has(c)&&await this.client.core.crypto.deleteSymKey(c),d||this.client.core.expirer.del(c),this.client.core.storage.removeItem(hp).catch(a=>this.client.logger.warn(a)),this.getPendingSessionRequests().forEach(a=>{a.topic===c&&this.deletePendingSessionRequest(a.id,d$("USER_DISCONNECTED"))}),c===(null==(b=this.sessionRequestQueue.queue[0])?void 0:b.topic)&&(this.sessionRequestQueue.state=hu.idle),e&&this.client.events.emit("session_delete",{id:f,topic:c})}),hI(this,"deleteProposal",async(a,b)=>{if(b)try{let b=this.client.proposal.get(a),c=this.client.core.eventClient.getEvent({topic:b.pairingTopic});c?.setError(e6.proposal_expired)}catch{}await Promise.all([this.client.proposal.delete(a,d$("USER_DISCONNECTED")),b?Promise.resolve():this.client.core.expirer.del(a)]),this.addToRecentlyDeleted(a,"proposal")}),hI(this,"deletePendingSessionRequest",async(a,b,c=!1)=>{await Promise.all([this.client.pendingRequest.delete(a,b),c?Promise.resolve():this.client.core.expirer.del(a)]),this.addToRecentlyDeleted(a,"request"),this.sessionRequestQueue.queue=this.sessionRequestQueue.queue.filter(b=>b.id!==a),c&&(this.sessionRequestQueue.state=hu.idle,this.client.events.emit("session_request_expire",{id:a}))}),hI(this,"deletePendingAuthRequest",async(a,b,c=!1)=>{await Promise.all([this.client.auth.requests.delete(a,b),c?Promise.resolve():this.client.core.expirer.del(a)])}),hI(this,"setExpiry",async(a,b)=>{this.client.session.keys.includes(a)&&(this.client.core.expirer.set(a,b),await this.client.session.update(a,{expiry:b}))}),hI(this,"setProposal",async(a,b)=>{this.client.core.expirer.set(a,aE(hs.wc_sessionPropose.req.ttl)),await this.client.proposal.set(a,b)}),hI(this,"setAuthRequest",async(a,b)=>{let{request:c,pairingTopic:d,transportType:e=eU.relay}=b;this.client.core.expirer.set(a,c.expiryTimestamp),await this.client.auth.requests.set(a,{authPayload:c.authPayload,requester:c.requester,expiryTimestamp:c.expiryTimestamp,id:a,pairingTopic:d,verifyContext:c.verifyContext,transportType:e})}),hI(this,"setPendingSessionRequest",async a=>{let{id:b,topic:c,params:d,verifyContext:e}=a,f=d.request.expiryTimestamp||aE(hs.wc_sessionRequest.req.ttl);this.client.core.expirer.set(b,f),await this.client.pendingRequest.set(b,{id:b,topic:c,params:d,verifyContext:e})}),hI(this,"sendRequest",async b=>{let c,d,{topic:e,method:f,params:g,expiry:h,relayRpcId:i,clientRpcId:j,throwOnFailedPublish:k,appLink:l,tvf:m}=b,n=(0,eG.formatJsonRpcRequest)(f,g,j),o=!!l;try{let a=o?dr:dq;c=await this.client.core.crypto.encode(e,n,{encoding:a})}catch(a){throw await this.cleanup(),this.client.logger.error(`sendRequest() -> core.crypto.encode() for topic ${e} failed`),a}if(hw.includes(f)){let a=dv(JSON.stringify(n)),b=dv(c);d=await this.client.core.verify.register({id:b,decryptedId:a})}let p=hs[f].req;if(p.attestation=d,h&&(p.ttl=h),i&&(p.id=i),this.client.core.history.set(e,n),o){let b=dI(l,e,c);await a.g.Linking.openURL(b,this.client.name)}else{let a=hs[f].req;h&&(a.ttl=h),i&&(a.id=i),a.tvf=hH(hG({},m),{correlationId:n.id}),k?(a.internal=hH(hG({},a.internal),{throwOnFailedPublish:!0}),await this.client.core.relayer.publish(e,c,a)):this.client.core.relayer.publish(e,c,a).catch(a=>this.client.logger.error(a))}return n.id}),hI(this,"sendResult",async b=>{let c,d,e,{id:f,topic:g,result:h,throwOnFailedPublish:i,encodeOpts:j,appLink:k}=b,l=(0,eG.formatJsonRpcResult)(f,h),m=k&&"u">typeof(null==a.g?void 0:a.g.Linking);try{let a=m?dr:dq;c=await this.client.core.crypto.encode(g,l,hH(hG({},j||{}),{encoding:a}))}catch(a){throw await this.cleanup(),this.client.logger.error(`sendResult() -> core.crypto.encode() for topic ${g} failed`),a}try{let a=(d=await this.client.core.history.get(g,f)).request;try{this.shouldSetTVF(a.method,a.params)&&(e=this.getTVFParams(f,a.params,h))}catch(a){this.client.logger.warn("sendResult() -> getTVFParams() failed",a)}}catch(a){throw this.client.logger.error(`sendResult() -> history.get(${g}, ${f}) failed`),a}if(m){let b=dI(k,g,c);await a.g.Linking.openURL(b,this.client.name)}else{let a=hs[d.request.method].res;a.tvf=hH(hG({},e),{correlationId:f}),i?(a.internal=hH(hG({},a.internal),{throwOnFailedPublish:!0}),await this.client.core.relayer.publish(g,c,a)):this.client.core.relayer.publish(g,c,a).catch(a=>this.client.logger.error(a))}await this.client.core.history.resolve(l)}),hI(this,"sendError",async b=>{let c,d,{id:e,topic:f,error:g,encodeOpts:h,rpcOpts:i,appLink:j}=b,k=(0,eG.formatJsonRpcError)(e,g),l=j&&"u">typeof(null==a.g?void 0:a.g.Linking);try{let a=l?dr:dq;c=await this.client.core.crypto.encode(f,k,hH(hG({},h||{}),{encoding:a}))}catch(a){throw await this.cleanup(),this.client.logger.error(`sendError() -> core.crypto.encode() for topic ${f} failed`),a}try{d=await this.client.core.history.get(f,e)}catch(a){throw this.client.logger.error(`sendError() -> history.get(${f}, ${e}) failed`),a}if(l){let b=dI(j,f,c);await a.g.Linking.openURL(b,this.client.name)}else{let a=d.request.method,b=i||hs[a].res;this.client.core.relayer.publish(f,c,b)}await this.client.core.history.resolve(k)}),hI(this,"cleanup",async()=>{let a=[],b=[];this.client.session.getAll().forEach(b=>{let c=!1;aF(b.expiry)&&(c=!0),this.client.core.crypto.keychain.has(b.topic)||(c=!0),c&&a.push(b.topic)}),this.client.proposal.getAll().forEach(a=>{aF(a.expiryTimestamp)&&b.push(a.id)}),await Promise.all([...a.map(a=>this.deleteSession({topic:a})),...b.map(a=>this.deleteProposal(a))])}),hI(this,"onProviderMessageEvent",async a=>{!this.initialized||this.relayMessageCache.length>0?this.relayMessageCache.push(a):await this.onRelayMessage(a)}),hI(this,"onRelayEventRequest",async a=>{this.requestQueue.queue.push(a),await this.processRequestsQueue()}),hI(this,"processRequestsQueue",async()=>{if(this.requestQueue.state===hu.active)return void this.client.logger.info("Request queue already active, skipping...");for(this.client.logger.info(`Request queue starting with ${this.requestQueue.queue.length} requests`);this.requestQueue.queue.length>0;){this.requestQueue.state=hu.active;let a=this.requestQueue.queue.shift();if(a)try{await this.processRequest(a)}catch(a){this.client.logger.warn(a)}}this.requestQueue.state=hu.idle}),hI(this,"processRequest",async a=>{let{topic:b,payload:c,attestation:d,transportType:e,encryptedId:f}=a,g=c.method;if(!this.shouldIgnorePairingRequest({topic:b,requestMethod:g}))switch(g){case"wc_sessionPropose":return await this.onSessionProposeRequest({topic:b,payload:c,attestation:d,encryptedId:f});case"wc_sessionSettle":return await this.onSessionSettleRequest(b,c);case"wc_sessionUpdate":return await this.onSessionUpdateRequest(b,c);case"wc_sessionExtend":return await this.onSessionExtendRequest(b,c);case"wc_sessionPing":return await this.onSessionPingRequest(b,c);case"wc_sessionDelete":return await this.onSessionDeleteRequest(b,c);case"wc_sessionRequest":return await this.onSessionRequest({topic:b,payload:c,attestation:d,encryptedId:f,transportType:e});case"wc_sessionEvent":return await this.onSessionEventRequest(b,c);case"wc_sessionAuthenticate":return await this.onSessionAuthenticateRequest({topic:b,payload:c,attestation:d,encryptedId:f,transportType:e});default:return this.client.logger.info(`Unsupported request method ${g}`)}}),hI(this,"onRelayEventResponse",async a=>{let{topic:b,payload:c,transportType:d}=a,e=(await this.client.core.history.get(b,c.id)).request.method;switch(e){case"wc_sessionPropose":return this.onSessionProposeResponse(b,c,d);case"wc_sessionSettle":return this.onSessionSettleResponse(b,c);case"wc_sessionUpdate":return this.onSessionUpdateResponse(b,c);case"wc_sessionExtend":return this.onSessionExtendResponse(b,c);case"wc_sessionPing":return this.onSessionPingResponse(b,c);case"wc_sessionRequest":return this.onSessionRequestResponse(b,c);case"wc_sessionAuthenticate":return this.onSessionAuthenticateResponse(b,c);default:return this.client.logger.info(`Unsupported response method ${e}`)}}),hI(this,"onRelayEventUnknownPayload",a=>{let{topic:b}=a,{message:c}=dZ("MISSING_OR_INVALID",`Decoded payload on topic ${b} is not identifiable as a JSON-RPC request or a response.`);throw Error(c)}),hI(this,"shouldIgnorePairingRequest",a=>{let{topic:b,requestMethod:c}=a,d=this.expectedPairingMethodMap.get(b);return!(!d||d.includes(c))&&!!(d.includes("wc_sessionAuthenticate")&&this.client.events.listenerCount("session_authenticate")>0)}),hI(this,"onSessionProposeRequest",async a=>{let{topic:b,payload:c,attestation:d,encryptedId:e}=a,{params:f,id:g}=c;try{let a=this.client.core.eventClient.getEvent({topic:b});0===this.client.events.listenerCount("session_proposal")&&(console.warn("No listener for session_proposal event"),a?.setError(e4.proposal_listener_not_found)),this.isValidConnect(hG({},c.params));let h=f.expiryTimestamp||aE(hs.wc_sessionPropose.req.ttl),i=hG({id:g,pairingTopic:b,expiryTimestamp:h},f);await this.setProposal(g,i);let j=await this.getVerifyContext({attestationId:d,hash:dv(JSON.stringify(c)),encryptedId:e,metadata:i.proposer.metadata});a?.addTrace(e3.emit_session_proposal),this.client.events.emit("session_proposal",{id:g,params:i,verifyContext:j})}catch(a){await this.sendError({id:g,topic:b,error:a,rpcOpts:hs.wc_sessionPropose.autoReject}),this.client.logger.error(a)}}),hI(this,"onSessionProposeResponse",async(a,b,c)=>{let{id:d}=b;if((0,eH.isJsonRpcResult)(b)){let{result:e}=b;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",result:e});let f=this.client.proposal.get(d);this.client.logger.trace({type:"method",method:"onSessionProposeResponse",proposal:f});let g=f.proposer.publicKey;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",selfPublicKey:g});let h=e.responderPublicKey;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",peerPublicKey:h});let i=await this.client.core.crypto.generateSharedKey(g,h);this.pendingSessions.set(d,{sessionTopic:i,pairingTopic:a,proposalId:d,publicKey:g});let j=await this.client.core.relayer.subscribe(i,{transportType:c});this.client.logger.trace({type:"method",method:"onSessionProposeResponse",subscriptionId:j}),await this.client.core.pairing.activate({topic:a})}else if((0,eH.isJsonRpcError)(b)){await this.client.proposal.delete(d,d$("USER_DISCONNECTED"));let a=aG("session_connect",d);if(0===this.events.listenerCount(a))throw Error(`emitting ${a} without any listeners, 954`);this.events.emit(a,{error:b.error})}}),hI(this,"onSessionSettleRequest",async(a,b)=>{let{id:c,params:d}=b;try{this.isValidSessionSettleRequest(d);let{relay:c,controller:e,expiry:f,namespaces:g,sessionProperties:h,scopedProperties:i,sessionConfig:j}=b.params,k=[...this.pendingSessions.values()].find(b=>b.sessionTopic===a);if(!k)return this.client.logger.error(`Pending session not found for topic ${a}`);let l=this.client.proposal.get(k.proposalId),m=hH(hG(hG(hG({topic:a,relay:c,expiry:f,namespaces:g,acknowledged:!0,pairingTopic:k.pairingTopic,requiredNamespaces:l.requiredNamespaces,optionalNamespaces:l.optionalNamespaces,controller:e.publicKey,self:{publicKey:k.publicKey,metadata:this.client.metadata},peer:{publicKey:e.publicKey,metadata:e.metadata}},h&&{sessionProperties:h}),i&&{scopedProperties:i}),j&&{sessionConfig:j}),{transportType:eU.relay});await this.client.session.set(m.topic,m),await this.setExpiry(m.topic,m.expiry),await this.client.core.pairing.updateMetadata({topic:k.pairingTopic,metadata:m.peer.metadata}),this.client.events.emit("session_connect",{session:m}),this.events.emit(aG("session_connect",k.proposalId),{session:m}),this.pendingSessions.delete(k.proposalId),this.deleteProposal(k.proposalId,!1),this.cleanupDuplicatePairings(m),await this.sendResult({id:b.id,topic:a,result:!0,throwOnFailedPublish:!0})}catch(b){await this.sendError({id:c,topic:a,error:b}),this.client.logger.error(b)}}),hI(this,"onSessionSettleResponse",async(a,b)=>{let{id:c}=b;(0,eH.isJsonRpcResult)(b)?(await this.client.session.update(a,{acknowledged:!0}),this.events.emit(aG("session_approve",c),{})):(0,eH.isJsonRpcError)(b)&&(await this.client.session.delete(a,d$("USER_DISCONNECTED")),this.events.emit(aG("session_approve",c),{error:b.error}))}),hI(this,"onSessionUpdateRequest",async(a,b)=>{let{params:c,id:d}=b;try{let b=`${a}_session_update`,e=eg.get(b);if(e&&this.isRequestOutOfSync(e,d)){this.client.logger.warn(`Discarding out of sync request - ${d}`),this.sendError({id:d,topic:a,error:d$("INVALID_UPDATE_REQUEST")});return}this.isValidUpdate(hG({topic:a},c));try{eg.set(b,d),await this.client.session.update(a,{namespaces:c.namespaces}),await this.sendResult({id:d,topic:a,result:!0,throwOnFailedPublish:!0})}catch(a){throw eg.delete(b),a}this.client.events.emit("session_update",{id:d,topic:a,params:c})}catch(b){await this.sendError({id:d,topic:a,error:b}),this.client.logger.error(b)}}),hI(this,"isRequestOutOfSync",(a,b)=>b.toString().slice(0,-3)<a.toString().slice(0,-3)),hI(this,"onSessionUpdateResponse",(a,b)=>{let{id:c}=b,d=aG("session_update",c);if(0===this.events.listenerCount(d))throw Error(`emitting ${d} without any listeners`);(0,eH.isJsonRpcResult)(b)?this.events.emit(aG("session_update",c),{}):(0,eH.isJsonRpcError)(b)&&this.events.emit(aG("session_update",c),{error:b.error})}),hI(this,"onSessionExtendRequest",async(a,b)=>{let{id:c}=b;try{this.isValidExtend({topic:a}),await this.setExpiry(a,aE(hr)),await this.sendResult({id:c,topic:a,result:!0,throwOnFailedPublish:!0}),this.client.events.emit("session_extend",{id:c,topic:a})}catch(b){await this.sendError({id:c,topic:a,error:b}),this.client.logger.error(b)}}),hI(this,"onSessionExtendResponse",(a,b)=>{let{id:c}=b,d=aG("session_extend",c);if(0===this.events.listenerCount(d))throw Error(`emitting ${d} without any listeners`);(0,eH.isJsonRpcResult)(b)?this.events.emit(aG("session_extend",c),{}):(0,eH.isJsonRpcError)(b)&&this.events.emit(aG("session_extend",c),{error:b.error})}),hI(this,"onSessionPingRequest",async(a,b)=>{let{id:c}=b;try{this.isValidPing({topic:a}),await this.sendResult({id:c,topic:a,result:!0,throwOnFailedPublish:!0}),this.client.events.emit("session_ping",{id:c,topic:a})}catch(b){await this.sendError({id:c,topic:a,error:b}),this.client.logger.error(b)}}),hI(this,"onSessionPingResponse",(a,b)=>{let{id:c}=b,d=aG("session_ping",c);setTimeout(()=>{if(0===this.events.listenerCount(d))throw Error(`emitting ${d} without any listeners 2176`);(0,eH.isJsonRpcResult)(b)?this.events.emit(aG("session_ping",c),{}):(0,eH.isJsonRpcError)(b)&&this.events.emit(aG("session_ping",c),{error:b.error})},500)}),hI(this,"onSessionDeleteRequest",async(a,b)=>{let{id:c}=b;try{this.isValidDisconnect({topic:a,reason:b.params}),Promise.all([new Promise(b=>{this.client.core.relayer.once(eR.publish,async()=>{b(await this.deleteSession({topic:a,id:c}))})}),this.sendResult({id:c,topic:a,result:!0,throwOnFailedPublish:!0}),this.cleanupPendingSentRequestsForTopic({topic:a,error:d$("USER_DISCONNECTED")})]).catch(a=>this.client.logger.error(a))}catch(a){this.client.logger.error(a)}}),hI(this,"onSessionRequest",async a=>{var b,c,d;let{topic:e,payload:f,attestation:g,encryptedId:h,transportType:i}=a,{id:j,params:k}=f;try{await this.isValidRequest(hG({topic:e},k));let a=this.client.session.get(e),f=await this.getVerifyContext({attestationId:g,hash:dv(JSON.stringify((0,eG.formatJsonRpcRequest)("wc_sessionRequest",k,j))),encryptedId:h,metadata:a.peer.metadata,transportType:i}),l={id:j,topic:e,params:k,verifyContext:f};await this.setPendingSessionRequest(l),i===eU.link_mode&&null!=(b=a.peer.metadata.redirect)&&b.universal&&this.client.core.addLinkModeSupportedApp(null==(c=a.peer.metadata.redirect)?void 0:c.universal),null!=(d=this.client.signConfig)&&d.disableRequestQueue?this.emitSessionRequest(l):(this.addSessionRequestToSessionRequestQueue(l),this.processSessionRequestQueue())}catch(a){await this.sendError({id:j,topic:e,error:a}),this.client.logger.error(a)}}),hI(this,"onSessionRequestResponse",(a,b)=>{let{id:c}=b,d=aG("session_request",c);if(0===this.events.listenerCount(d))throw Error(`emitting ${d} without any listeners`);(0,eH.isJsonRpcResult)(b)?this.events.emit(aG("session_request",c),{result:b.result}):(0,eH.isJsonRpcError)(b)&&this.events.emit(aG("session_request",c),{error:b.error})}),hI(this,"onSessionEventRequest",async(a,b)=>{let{id:c,params:d}=b;try{let b=`${a}_session_event_${d.event.name}`,e=eg.get(b);if(e&&this.isRequestOutOfSync(e,c))return void this.client.logger.info(`Discarding out of sync request - ${c}`);this.isValidEmit(hG({topic:a},d)),this.client.events.emit("session_event",{id:c,topic:a,params:d}),eg.set(b,c)}catch(b){await this.sendError({id:c,topic:a,error:b}),this.client.logger.error(b)}}),hI(this,"onSessionAuthenticateResponse",(a,b)=>{let{id:c}=b;this.client.logger.trace({type:"method",method:"onSessionAuthenticateResponse",topic:a,payload:b}),(0,eH.isJsonRpcResult)(b)?this.events.emit(aG("session_request",c),{result:b.result}):(0,eH.isJsonRpcError)(b)&&this.events.emit(aG("session_request",c),{error:b.error})}),hI(this,"onSessionAuthenticateRequest",async a=>{var b;let{topic:c,payload:d,attestation:e,encryptedId:f,transportType:g}=a;try{let{requester:a,authPayload:h,expiryTimestamp:i}=d.params,j=await this.getVerifyContext({attestationId:e,hash:dv(JSON.stringify(d)),encryptedId:f,metadata:a.metadata,transportType:g}),k={requester:a,pairingTopic:c,id:d.id,authPayload:h,verifyContext:j,expiryTimestamp:i};await this.setAuthRequest(d.id,{request:k,pairingTopic:c,transportType:g}),g===eU.link_mode&&null!=(b=a.metadata.redirect)&&b.universal&&this.client.core.addLinkModeSupportedApp(a.metadata.redirect.universal),this.client.events.emit("session_authenticate",{topic:c,params:d.params,id:d.id,verifyContext:j})}catch(f){this.client.logger.error(f);let a=d.params.requester.publicKey,b=await this.client.core.crypto.generateKeyPair(),e=this.getAppLinkIfEnabled(d.params.requester.metadata,g);await this.sendError({id:d.id,topic:c,error:f,encodeOpts:{type:1,receiverPublicKey:a,senderPublicKey:b},rpcOpts:hs.wc_sessionAuthenticate.autoReject,appLink:e})}}),hI(this,"addSessionRequestToSessionRequestQueue",a=>{this.sessionRequestQueue.queue.push(a)}),hI(this,"cleanupAfterResponse",a=>{this.deletePendingSessionRequest(a.response.id,{message:"fulfilled",code:0}),setTimeout(()=>{this.sessionRequestQueue.state=hu.idle,this.processSessionRequestQueue()},(0,d.toMiliseconds)(this.requestQueueDelay))}),hI(this,"cleanupPendingSentRequestsForTopic",({topic:a,error:b})=>{let c=this.client.core.history.pending;c.length>0&&c.filter(b=>b.topic===a&&"wc_sessionRequest"===b.request.method).forEach(a=>{let c=aG("session_request",a.request.id);if(0===this.events.listenerCount(c))throw Error(`emitting ${c} without any listeners`);this.events.emit(aG("session_request",a.request.id),{error:b})})}),hI(this,"processSessionRequestQueue",()=>{if(this.sessionRequestQueue.state===hu.active)return void this.client.logger.info("session request queue is already active.");let a=this.sessionRequestQueue.queue[0];if(!a)return void this.client.logger.info("session request queue is empty.");try{this.sessionRequestQueue.state=hu.active,this.emitSessionRequest(a)}catch(a){this.client.logger.error(a)}}),hI(this,"emitSessionRequest",a=>{this.client.events.emit("session_request",a)}),hI(this,"onPairingCreated",a=>{if(a.methods&&this.expectedPairingMethodMap.set(a.topic,a.methods),a.active)return;let b=this.client.proposal.getAll().find(b=>b.pairingTopic===a.topic);b&&this.onSessionProposeRequest({topic:a.topic,payload:(0,eG.formatJsonRpcRequest)("wc_sessionPropose",hH(hG({},b),{requiredNamespaces:b.requiredNamespaces,optionalNamespaces:b.optionalNamespaces,relays:b.relays,proposer:b.proposer,sessionProperties:b.sessionProperties,scopedProperties:b.scopedProperties}),b.id)})}),hI(this,"isValidConnect",async a=>{if(!d9(a)){let{message:b}=dZ("MISSING_OR_INVALID",`connect() params: ${JSON.stringify(a)}`);throw Error(b)}let{pairingTopic:b,requiredNamespaces:c,optionalNamespaces:d,sessionProperties:e,scopedProperties:f,relays:g}=a;if(d1(b)||await this.isValidPairingTopic(b),!function(a,b){let c=!1;return b&&!a?c=!0:a&&d_(a)&&a.length&&a.forEach(a=>{c=d8(a)}),c}(g,!0)){let{message:a}=dZ("MISSING_OR_INVALID",`connect() relays: ${g}`);throw Error(a)}if(!d1(c)&&0!==d0(c)){let a="requiredNamespaces are deprecated and are automatically assigned to optionalNamespaces";["fatal","error","silent"].includes(this.client.logger.level)?console.warn(a):this.client.logger.warn(a),this.validateNamespaces(c,"requiredNamespaces")}if(d1(d)||0===d0(d)||this.validateNamespaces(d,"optionalNamespaces"),d1(e)||this.validateSessionProps(e,"sessionProperties"),!d1(f)){this.validateSessionProps(f,"scopedProperties");let a=Object.keys(c||{}).concat(Object.keys(d||{}));if(!Object.keys(f).every(b=>a.includes(b)))throw Error(`Scoped properties must be a subset of required/optional namespaces, received: ${JSON.stringify(f)}, required/optional namespaces: ${JSON.stringify(a)}`)}}),hI(this,"validateNamespaces",(a,b)=>{let c=function(a,b,c){let d=null;if(a&&d0(a)){let e,f=d6(a,b);f&&(d=f);let g=(e=null,Object.entries(a).forEach(([a,d])=>{var f,g;let h;if(e)return;let i=(f=ag(a,d),g=`${b} ${c}`,h=null,d_(f)&&f.length?f.forEach(a=>{h||d4(a)||(h=d$("UNSUPPORTED_CHAINS",`${g}, chain ${a} should be a string and conform to "namespace:chainId" format`))}):d4(a)||(h=d$("UNSUPPORTED_CHAINS",`${g}, chains must be defined as "namespace:chainId" e.g. "eip155:1": {...} in the namespace key OR as an array of CAIP-2 chainIds e.g. eip155: { chains: ["eip155:1", "eip155:5"] }`)),h);i&&(e=i)}),e);g&&(d=g)}else d=dZ("MISSING_OR_INVALID",`${b}, ${c} should be an object with data`);return d}(a,"connect()",b);if(c)throw Error(c.message)}),hI(this,"isValidApprove",async a=>{if(!d9(a))throw Error(dZ("MISSING_OR_INVALID",`approve() params: ${a}`).message);let{id:b,namespaces:c,relayProtocol:d,sessionProperties:e,scopedProperties:f}=a;this.checkRecentlyDeleted(b),await this.isValidProposalId(b);let g=this.client.proposal.get(b),h=d7(c,"approve()");if(h)throw Error(h.message);let i=eb(g.requiredNamespaces,c,"approve()");if(i)throw Error(i.message);if(!d2(d,!0)){let{message:a}=dZ("MISSING_OR_INVALID",`approve() relayProtocol: ${d}`);throw Error(a)}if(d1(e)||this.validateSessionProps(e,"sessionProperties"),!d1(f)){this.validateSessionProps(f,"scopedProperties");let a=new Set(Object.keys(c));if(!Object.keys(f).every(b=>a.has(b)))throw Error(`Scoped properties must be a subset of approved namespaces, received: ${JSON.stringify(f)}, approved namespaces: ${Array.from(a).join(", ")}`)}}),hI(this,"isValidReject",async a=>{if(!d9(a)){let{message:b}=dZ("MISSING_OR_INVALID",`reject() params: ${a}`);throw Error(b)}let{id:b,reason:c}=a;if(this.checkRecentlyDeleted(b),await this.isValidProposalId(b),!function(a){return!(!a||"object"!=typeof a||!a.code||!d3(a.code,!1)||!a.message||!d2(a.message,!1))}(c)){let{message:a}=dZ("MISSING_OR_INVALID",`reject() reason: ${JSON.stringify(c)}`);throw Error(a)}}),hI(this,"isValidSessionSettleRequest",a=>{if(!d9(a)){let{message:b}=dZ("MISSING_OR_INVALID",`onSessionSettleRequest() params: ${a}`);throw Error(b)}let{relay:b,controller:c,namespaces:d,expiry:e}=a;if(!d8(b)){let{message:a}=dZ("MISSING_OR_INVALID","onSessionSettleRequest() relay protocol should be a string");throw Error(a)}let f=function(a,b){let c=null;return d2(a?.publicKey,!1)||(c=dZ("MISSING_OR_INVALID",`${b} controller public key should be a string`)),c}(c,"onSessionSettleRequest()");if(f)throw Error(f.message);let g=d7(d,"onSessionSettleRequest()");if(g)throw Error(g.message);if(aF(e)){let{message:a}=dZ("EXPIRED","onSessionSettleRequest()");throw Error(a)}}),hI(this,"isValidUpdate",async a=>{if(!d9(a)){let{message:b}=dZ("MISSING_OR_INVALID",`update() params: ${a}`);throw Error(b)}let{topic:b,namespaces:c}=a;this.checkRecentlyDeleted(b),await this.isValidSessionTopic(b);let d=this.client.session.get(b),e=d7(c,"update()");if(e)throw Error(e.message);let f=eb(d.requiredNamespaces,c,"update()");if(f)throw Error(f.message)}),hI(this,"isValidExtend",async a=>{if(!d9(a)){let{message:b}=dZ("MISSING_OR_INVALID",`extend() params: ${a}`);throw Error(b)}let{topic:b}=a;this.checkRecentlyDeleted(b),await this.isValidSessionTopic(b)}),hI(this,"isValidRequest",async a=>{if(!d9(a)){let{message:b}=dZ("MISSING_OR_INVALID",`request() params: ${a}`);throw Error(b)}let{topic:b,request:c,chainId:d,expiry:e}=a;this.checkRecentlyDeleted(b),await this.isValidSessionTopic(b);let{namespaces:f}=this.client.session.get(b);if(!ea(f,d)){let{message:a}=dZ("MISSING_OR_INVALID",`request() chainId: ${d}`);throw Error(a)}if(!function(a){return!(d1(a)||!d2(a.method,!1))}(c)){let{message:a}=dZ("MISSING_OR_INVALID",`request() ${JSON.stringify(c)}`);throw Error(a)}if(!function(a,b,c){return!!d2(c,!1)&&(function(a,b){let c=[];return Object.values(a).forEach(a=>{dS(a.accounts).includes(b)&&c.push(...a.methods)}),c})(a,b).includes(c)}(f,d,c.method)){let{message:a}=dZ("MISSING_OR_INVALID",`request() method: ${c.method}`);throw Error(a)}if(e&&!function(a,b){return d3(a,!1)&&a<=b.max&&a>=b.min}(e,ht)){let{message:a}=dZ("MISSING_OR_INVALID",`request() expiry: ${e}. Expiry must be a number (in seconds) between ${ht.min} and ${ht.max}`);throw Error(a)}}),hI(this,"isValidRespond",async a=>{var b;if(!d9(a)){let{message:b}=dZ("MISSING_OR_INVALID",`respond() params: ${a}`);throw Error(b)}let{topic:c,response:d}=a;try{await this.isValidSessionTopic(c)}catch(c){throw null!=(b=a?.response)&&b.id&&this.cleanupAfterResponse(a),c}if(!function(a){return!(d1(a)||d1(a.result)&&d1(a.error)||!d3(a.id,!1)||!d2(a.jsonrpc,!1))}(d)){let{message:a}=dZ("MISSING_OR_INVALID",`respond() response: ${JSON.stringify(d)}`);throw Error(a)}}),hI(this,"isValidPing",async a=>{if(!d9(a)){let{message:b}=dZ("MISSING_OR_INVALID",`ping() params: ${a}`);throw Error(b)}let{topic:b}=a;await this.isValidSessionOrPairingTopic(b)}),hI(this,"isValidEmit",async a=>{if(!d9(a)){let{message:b}=dZ("MISSING_OR_INVALID",`emit() params: ${a}`);throw Error(b)}let{topic:b,event:c,chainId:d}=a;await this.isValidSessionTopic(b);let{namespaces:e}=this.client.session.get(b);if(!ea(e,d)){let{message:a}=dZ("MISSING_OR_INVALID",`emit() chainId: ${d}`);throw Error(a)}if(!function(a){return!(d1(a)||!d2(a.name,!1))}(c)||!function(a,b,c){return!!d2(c,!1)&&(function(a,b){let c=[];return Object.values(a).forEach(a=>{dS(a.accounts).includes(b)&&c.push(...a.events)}),c})(a,b).includes(c)}(e,d,c.name)){let{message:a}=dZ("MISSING_OR_INVALID",`emit() event: ${JSON.stringify(c)}`);throw Error(a)}}),hI(this,"isValidDisconnect",async a=>{if(!d9(a)){let{message:b}=dZ("MISSING_OR_INVALID",`disconnect() params: ${a}`);throw Error(b)}let{topic:b}=a;await this.isValidSessionOrPairingTopic(b)}),hI(this,"isValidAuthenticate",a=>{let{chains:b,uri:c,domain:d,nonce:e}=a;if(!Array.isArray(b)||0===b.length)throw Error("chains is required and must be a non-empty array");if(!d2(c,!1))throw Error("uri is required parameter");if(!d2(d,!1))throw Error("domain is required parameter");if(!d2(e,!1))throw Error("nonce is required parameter");if([...new Set(b.map(a=>ae(a).namespace))].length>1)throw Error("Multi-namespace requests are not supported. Please request single namespace only.");let{namespace:f}=ae(b[0]);if("eip155"!==f)throw Error("Only eip155 namespace is supported for authenticated sessions. Please use .connect() for non-eip155 chains.")}),hI(this,"getVerifyContext",async a=>{let{attestationId:b,hash:c,encryptedId:d,metadata:e,transportType:f}=a,g={verified:{verifyUrl:e.verifyUrl||e0,validation:"UNKNOWN",origin:e.url||""}};try{if(f===eU.link_mode){let a=this.getAppLinkIfEnabled(e,f);return g.verified.validation=a&&new URL(a).origin===new URL(e.url).origin?"VALID":"INVALID",g}let a=await this.client.core.verify.resolve({attestationId:b,hash:c,encryptedId:d,verifyUrl:e.verifyUrl});a&&(g.verified.origin=a.origin,g.verified.isScam=a.isScam,g.verified.validation=a.origin===new URL(e.url).origin?"VALID":"INVALID")}catch(a){this.client.logger.warn(a)}return this.client.logger.debug(`Verify context: ${JSON.stringify(g)}`),g}),hI(this,"validateSessionProps",(a,b)=>{Object.values(a).forEach((c,d)=>{if(null==c){let{message:e}=dZ("MISSING_OR_INVALID",`${b} must contain an existing value for each key. Received: ${c} for key ${Object.keys(a)[d]}`);throw Error(e)}})}),hI(this,"getPendingAuthRequest",a=>{let b=this.client.auth.requests.get(a);return"object"==typeof b?b:void 0}),hI(this,"addToRecentlyDeleted",(a,b)=>{if(this.recentlyDeletedMap.set(a,b),this.recentlyDeletedMap.size>=this.recentlyDeletedLimit){let a=0,b=this.recentlyDeletedLimit/2;for(let c of this.recentlyDeletedMap.keys()){if(a++>=b)break;this.recentlyDeletedMap.delete(c)}}}),hI(this,"checkRecentlyDeleted",a=>{let b=this.recentlyDeletedMap.get(a);if(b){let{message:c}=dZ("MISSING_OR_INVALID",`Record was recently deleted - ${b}: ${a}`);throw Error(c)}}),hI(this,"isLinkModeEnabled",(b,c)=>{var d,e,f,g,h,i,j,k,l;return!!b&&c===eU.link_mode&&(null==(e=null==(d=this.client.metadata)?void 0:d.redirect)?void 0:e.linkMode)===!0&&(null==(g=null==(f=this.client.metadata)?void 0:f.redirect)?void 0:g.universal)!==void 0&&(null==(i=null==(h=this.client.metadata)?void 0:h.redirect)?void 0:i.universal)!==""&&(null==(j=b?.redirect)?void 0:j.universal)!==void 0&&(null==(k=b?.redirect)?void 0:k.universal)!==""&&(null==(l=b?.redirect)?void 0:l.linkMode)===!0&&this.client.core.linkModeSupportedApps.includes(b.redirect.universal)&&"u">typeof(null==a.g?void 0:a.g.Linking)}),hI(this,"getAppLinkIfEnabled",(a,b)=>{var c;return this.isLinkModeEnabled(a,b)?null==(c=a?.redirect)?void 0:c.universal:void 0}),hI(this,"handleLinkModeMessage",({url:a})=>{if(!a||!a.includes("wc_ev")||!a.includes("topic"))return;let b=aK(a,"topic")||"",c=decodeURIComponent(aK(a,"wc_ev")||""),d=this.client.session.keys.includes(b);d&&this.client.session.update(b,{transportType:eU.link_mode}),this.client.core.dispatchEnvelope({topic:b,message:c,sessionExists:d})}),hI(this,"registerLinkModeListeners",async()=>{var b;if(aM()||ar()&&null!=(b=this.client.metadata.redirect)&&b.linkMode){let b=null==a.g?void 0:a.g.Linking;if("u">typeof b){b.addEventListener("url",this.handleLinkModeMessage,this.client.name);let a=await b.getInitialURL();a&&setTimeout(()=>{this.handleLinkModeMessage({url:a})},50)}}}),hI(this,"shouldSetTVF",(a,b)=>{if(!b||"wc_sessionRequest"!==a)return!1;let{request:c}=b;return Object.keys(hv).includes(c.method)}),hI(this,"getTVFParams",(a,b,c)=>{var d,e;try{let f=b.request.method,g=this.extractTxHashesFromResult(f,c);return hH(hG({correlationId:a,rpcMethods:[f],chainId:b.chainId},this.isValidContractData(b.request.params)&&{contractAddresses:[null==(e=null==(d=b.request.params)?void 0:d[0])?void 0:e.to]}),{txHashes:g})}catch(a){this.client.logger.warn("Error getting TVF params",a)}return{}}),hI(this,"isValidContractData",a=>{var b;if(!a)return!1;try{let c=a?.data||(null==(b=a?.[0])?void 0:b.data);if(!c.startsWith("0x"))return!1;let d=c.slice(2);return!!/^[0-9a-fA-F]*$/.test(d)&&d.length%2==0}catch{}return!1}),hI(this,"extractTxHashesFromResult",(a,b)=>{try{let c=hv[a];if("string"==typeof b)return[b];let d=b[c.key];if(d_(d))return"solana_signAllTransactions"===a?d.map(a=>(function(a){let b=atob(a),c=new Uint8Array(b.length);for(let a=0;a<b.length;a++)c[a]=b.charCodeAt(a);let d=c[0];if(0===d)throw Error("No signatures found");if(c.length<1+64*d)throw Error("Transaction data too short for claimed signature count");if(c.length<100)throw Error("Transaction too short");let e=Buffer.from(a,"base64").slice(1,65);return $.default.encode(e)})(a)):d;if("string"==typeof d)return[d]}catch(a){this.client.logger.warn("Error extracting tx hashes from result",a)}return[]})}async processPendingMessageEvents(){try{let a=this.client.session.keys,b=this.client.core.relayer.messages.getWithoutAck(a);for(let[a,c]of Object.entries(b))for(let b of c)try{await this.onProviderMessageEvent({topic:a,message:b,publishedAt:Date.now()})}catch{this.client.logger.warn(`Error processing pending message event for topic: ${a}, message: ${b}`)}}catch(a){this.client.logger.warn("processPendingMessageEvents failed",a)}}isInitialized(){if(!this.initialized){let{message:a}=dZ("NOT_INITIALIZED",this.name);throw Error(a)}}async confirmOnlineStateOrThrow(){await this.client.core.relayer.confirmOnlineStateOrThrow()}registerRelayerEvents(){this.client.core.relayer.on(eR.message,a=>{this.onProviderMessageEvent(a)})}async onRelayMessage(a){let{topic:b,message:c,attestation:d,transportType:e}=a,{publicKey:f}=this.client.auth.authKeys.keys.includes(hy)?this.client.auth.authKeys.get(hy):{responseTopic:void 0,publicKey:void 0};try{let a=await this.client.core.crypto.decode(b,c,{receiverPublicKey:f,encoding:e===eU.link_mode?dr:dq});(0,eH.isJsonRpcRequest)(a)?(this.client.core.history.set(b,a),await this.onRelayEventRequest({topic:b,payload:a,attestation:d,transportType:e,encryptedId:dv(c)})):(0,eH.isJsonRpcResponse)(a)?(await this.client.core.history.resolve(a),await this.onRelayEventResponse({topic:b,payload:a,transportType:e}),this.client.core.history.delete(b,a.id)):await this.onRelayEventUnknownPayload({topic:b,payload:a,transportType:e}),await this.client.core.relayer.messages.ack(b,c)}catch(a){this.client.logger.error(a)}}registerExpirerEvents(){this.client.core.expirer.on(e_.expired,async a=>{let{topic:b,id:c}=aD(a.target);return c&&this.client.pendingRequest.keys.includes(c)?await this.deletePendingSessionRequest(c,dZ("EXPIRED"),!0):c&&this.client.auth.requests.keys.includes(c)?await this.deletePendingAuthRequest(c,dZ("EXPIRED"),!0):void(b?this.client.session.keys.includes(b)&&(await this.deleteSession({topic:b,expirerHasDeleted:!0}),this.client.events.emit("session_expire",{topic:b})):c&&(await this.deleteProposal(c,!0),this.client.events.emit("proposal_expire",{id:c})))})}registerPairingEvents(){this.client.core.pairing.events.on(eZ.create,a=>this.onPairingCreated(a)),this.client.core.pairing.events.on(eZ.delete,a=>{this.addToRecentlyDeleted(a.topic,"pairing")})}isValidPairingTopic(a){if(!d2(a,!1)){let{message:b}=dZ("MISSING_OR_INVALID",`pairing topic should be a string: ${a}`);throw Error(b)}if(!this.client.core.pairing.pairings.keys.includes(a)){let{message:b}=dZ("NO_MATCHING_KEY",`pairing topic doesn't exist: ${a}`);throw Error(b)}if(aF(this.client.core.pairing.pairings.get(a).expiry)){let{message:b}=dZ("EXPIRED",`pairing topic: ${a}`);throw Error(b)}}async isValidSessionTopic(a){if(!d2(a,!1)){let{message:b}=dZ("MISSING_OR_INVALID",`session topic should be a string: ${a}`);throw Error(b)}if(this.checkRecentlyDeleted(a),!this.client.session.keys.includes(a)){let{message:b}=dZ("NO_MATCHING_KEY",`session topic doesn't exist: ${a}`);throw Error(b)}if(aF(this.client.session.get(a).expiry)){await this.deleteSession({topic:a});let{message:b}=dZ("EXPIRED",`session topic: ${a}`);throw Error(b)}if(!this.client.core.crypto.keychain.has(a)){let{message:b}=dZ("MISSING_OR_INVALID",`session topic does not exist in keychain: ${a}`);throw await this.deleteSession({topic:a}),Error(b)}}async isValidSessionOrPairingTopic(a){if(this.checkRecentlyDeleted(a),this.client.session.keys.includes(a))await this.isValidSessionTopic(a);else if(this.client.core.pairing.pairings.keys.includes(a))this.isValidPairingTopic(a);else if(d2(a,!1)){let{message:b}=dZ("NO_MATCHING_KEY",`session or pairing topic doesn't exist: ${a}`);throw Error(b)}else{let{message:b}=dZ("MISSING_OR_INVALID",`session or pairing topic should be a string: ${a}`);throw Error(b)}}async isValidProposalId(a){if("number"!=typeof a){let{message:b}=dZ("MISSING_OR_INVALID",`proposal id should be a number: ${a}`);throw Error(b)}if(!this.client.proposal.keys.includes(a)){let{message:b}=dZ("NO_MATCHING_KEY",`proposal id doesn't exist: ${a}`);throw Error(b)}if(aF(this.client.proposal.get(a).expiryTimestamp)){await this.deleteProposal(a);let{message:b}=dZ("EXPIRED",`proposal id: ${a}`);throw Error(b)}}}class hK extends gS{constructor(a,b){super(a,b,"proposal",hn),this.core=a,this.logger=b}}class hL extends gS{constructor(a,b){super(a,b,"session",hn),this.core=a,this.logger=b}}class hM extends gS{constructor(a,b){super(a,b,"request",hn,a=>a.id),this.core=a,this.logger=b}}class hN extends gS{constructor(a,b){super(a,b,"authKeys",hx,()=>hy),this.core=a,this.logger=b}}class hO extends gS{constructor(a,b){super(a,b,"pairingTopics",hx),this.core=a,this.logger=b}}class hP extends gS{constructor(a,b){super(a,b,"requests",hx,a=>a.id),this.core=a,this.logger=b}}var hQ=Object.defineProperty,hR=(a,b,c)=>((a,b,c)=>b in a?hQ(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c)(a,"symbol"!=typeof b?b+"":b,c);class hS{constructor(a,b){this.core=a,this.logger=b,hR(this,"authKeys"),hR(this,"pairingTopics"),hR(this,"requests"),this.authKeys=new hN(this.core,this.logger),this.pairingTopics=new hO(this.core,this.logger),this.requests=new hP(this.core,this.logger)}async init(){await this.authKeys.init(),await this.pairingTopics.init(),await this.requests.init()}}var hT=Object.defineProperty,hU=(a,b,c)=>((a,b,c)=>b in a?hT(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c)(a,"symbol"!=typeof b?b+"":b,c);class hV extends eC{constructor(a){super(a),hU(this,"protocol","wc"),hU(this,"version",2),hU(this,"name",ho.name),hU(this,"metadata"),hU(this,"core"),hU(this,"logger"),hU(this,"events",new b.EventEmitter),hU(this,"engine"),hU(this,"session"),hU(this,"proposal"),hU(this,"pendingRequest"),hU(this,"auth"),hU(this,"signConfig"),hU(this,"on",(a,b)=>this.events.on(a,b)),hU(this,"once",(a,b)=>this.events.once(a,b)),hU(this,"off",(a,b)=>this.events.off(a,b)),hU(this,"removeListener",(a,b)=>this.events.removeListener(a,b)),hU(this,"removeAllListeners",a=>this.events.removeAllListeners(a)),hU(this,"connect",async a=>{try{return await this.engine.connect(a)}catch(a){throw this.logger.error(a.message),a}}),hU(this,"pair",async a=>{try{return await this.engine.pair(a)}catch(a){throw this.logger.error(a.message),a}}),hU(this,"approve",async a=>{try{return await this.engine.approve(a)}catch(a){throw this.logger.error(a.message),a}}),hU(this,"reject",async a=>{try{return await this.engine.reject(a)}catch(a){throw this.logger.error(a.message),a}}),hU(this,"update",async a=>{try{return await this.engine.update(a)}catch(a){throw this.logger.error(a.message),a}}),hU(this,"extend",async a=>{try{return await this.engine.extend(a)}catch(a){throw this.logger.error(a.message),a}}),hU(this,"request",async a=>{try{return await this.engine.request(a)}catch(a){throw this.logger.error(a.message),a}}),hU(this,"respond",async a=>{try{return await this.engine.respond(a)}catch(a){throw this.logger.error(a.message),a}}),hU(this,"ping",async a=>{try{return await this.engine.ping(a)}catch(a){throw this.logger.error(a.message),a}}),hU(this,"emit",async a=>{try{return await this.engine.emit(a)}catch(a){throw this.logger.error(a.message),a}}),hU(this,"disconnect",async a=>{try{return await this.engine.disconnect(a)}catch(a){throw this.logger.error(a.message),a}}),hU(this,"find",a=>{try{return this.engine.find(a)}catch(a){throw this.logger.error(a.message),a}}),hU(this,"getPendingSessionRequests",()=>{try{return this.engine.getPendingSessionRequests()}catch(a){throw this.logger.error(a.message),a}}),hU(this,"authenticate",async(a,b)=>{try{return await this.engine.authenticate(a,b)}catch(a){throw this.logger.error(a.message),a}}),hU(this,"formatAuthMessage",a=>{try{return this.engine.formatAuthMessage(a)}catch(a){throw this.logger.error(a.message),a}}),hU(this,"approveSessionAuthenticate",async a=>{try{return await this.engine.approveSessionAuthenticate(a)}catch(a){throw this.logger.error(a.message),a}}),hU(this,"rejectSessionAuthenticate",async a=>{try{return await this.engine.rejectSessionAuthenticate(a)}catch(a){throw this.logger.error(a.message),a}}),this.name=a?.name||ho.name,this.metadata=function(a){var b,c;let d=av();try{let e,f;return null!=a&&a.url&&d.url&&new URL(a.url).host!==new URL(d.url).host&&(console.warn(`The configured WalletConnect 'metadata.url':${a.url} differs from the actual page url:${d.url}. This is probably unintended and can lead to issues.`),a.url=d.url),null!=(b=a?.icons)&&b.length&&a.icons.length>0&&(a.icons=a.icons.filter(a=>""!==a)),e=ao(ao({},d),a),f={url:a?.url||d.url,name:a?.name||d.name,description:a?.description||d.description,icons:null!=(c=a?.icons)&&c.length&&a.icons.length>0?a.icons:d.icons},ai(e,aj(f))}catch(b){return console.warn("Error populating app metadata",b),a||d}}(a?.metadata),this.signConfig=a?.signConfig;let c="u">typeof a?.logger&&"string"!=typeof a?.logger?a.logger:(0,ek.pino)((0,ej.getDefaultLoggerOptions)({level:a?.logger||ho.logger}));this.core=a?.core||new hl(a),this.logger=(0,ej.generateChildLogger)(c,this.name),this.session=new hL(this.core,this.logger),this.proposal=new hK(this.core,this.logger),this.pendingRequest=new hM(this.core,this.logger),this.engine=new hJ(this),this.auth=new hS(this.core,this.logger)}static async init(a){let b=new hV(a);return await b.initialize(),b}get context(){return(0,ej.getLoggerContext)(this.logger)}get pairing(){return this.core.pairing.pairings}async initialize(){this.logger.trace("Initialized");try{await this.core.start(),await this.session.init(),await this.proposal.init(),await this.pendingRequest.init(),await this.auth.init(),await this.engine.init(),this.logger.info("SignClient Initialization Success"),setTimeout(()=>{this.engine.processRelayMessageCache()},(0,d.toMiliseconds)(d.ONE_SECOND))}catch(a){throw this.logger.info("SignClient Initialization Failure"),this.logger.error(a.message),a}}}var hW=a.i(419997);let hX="error",hY="wc@2:universal_provider:",hZ="https://rpc.walletconnect.org/v1/",h$="generic",h_=`${hZ}bundler`,h0={DEFAULT_CHAIN_CHANGED:"default_chain_changed"};function h1(){}function h2(a){return null==a||"object"!=typeof a&&"function"!=typeof a}function h3(a){return ArrayBuffer.isView(a)&&!(a instanceof DataView)}function h4(a){return"object"==typeof a&&null!==a}function h5(a){return Object.getOwnPropertySymbols(a).filter(b=>Object.prototype.propertyIsEnumerable.call(a,b))}function h6(a){return null==a?void 0===a?"[object Undefined]":"[object Null]":Object.prototype.toString.call(a)}let h7="[object String]",h8="[object Number]",h9="[object Boolean]",ia="[object Arguments]";function ib(a,b,c,d=new Map,e){let f=e?.(a,b,c,d);if(null!=f)return f;if(h2(a))return a;if(d.has(a))return d.get(a);if(Array.isArray(a)){let b=Array(a.length);d.set(a,b);for(let f=0;f<a.length;f++)b[f]=ib(a[f],f,c,d,e);return Object.hasOwn(a,"index")&&(b.index=a.index),Object.hasOwn(a,"input")&&(b.input=a.input),b}if(a instanceof Date)return new Date(a.getTime());if(a instanceof RegExp){let b=new RegExp(a.source,a.flags);return b.lastIndex=a.lastIndex,b}if(a instanceof Map){let b=new Map;for(let[f,g]of(d.set(a,b),a))b.set(f,ib(g,f,c,d,e));return b}if(a instanceof Set){let b=new Set;for(let f of(d.set(a,b),a))b.add(ib(f,void 0,c,d,e));return b}if("u">typeof Buffer&&Buffer.isBuffer(a))return a.subarray();if(h3(a)){let b=new(Object.getPrototypeOf(a)).constructor(a.length);d.set(a,b);for(let f=0;f<a.length;f++)b[f]=ib(a[f],f,c,d,e);return b}if(a instanceof ArrayBuffer||"u">typeof SharedArrayBuffer&&a instanceof SharedArrayBuffer)return a.slice(0);if(a instanceof DataView){let b=new DataView(a.buffer.slice(0),a.byteOffset,a.byteLength);return d.set(a,b),ic(b,a,c,d,e),b}if("u">typeof File&&a instanceof File){let b=new File([a],a.name,{type:a.type});return d.set(a,b),ic(b,a,c,d,e),b}if(a instanceof Blob){let b=new Blob([a],{type:a.type});return d.set(a,b),ic(b,a,c,d,e),b}if(a instanceof Error){let b=new a.constructor;return d.set(a,b),b.message=a.message,b.name=a.name,b.stack=a.stack,b.cause=a.cause,ic(b,a,c,d,e),b}if("object"==typeof a&&function(a){switch(h6(a)){case ia:case"[object Array]":case"[object ArrayBuffer]":case"[object DataView]":case h9:case"[object Date]":case"[object Float32Array]":case"[object Float64Array]":case"[object Int8Array]":case"[object Int16Array]":case"[object Int32Array]":case"[object Map]":case h8:case"[object Object]":case"[object RegExp]":case"[object Set]":case h7:case"[object Symbol]":case"[object Uint8Array]":case"[object Uint8ClampedArray]":case"[object Uint16Array]":case"[object Uint32Array]":return!0;default:return!1}}(a)){let b=Object.create(Object.getPrototypeOf(a));return d.set(a,b),ic(b,a,c,d,e),b}return a}function ic(a,b,c=a,d,e){let f=[...Object.keys(b),...h5(b)];for(let g=0;g<f.length;g++){let h=f[g],i=Object.getOwnPropertyDescriptor(a,h);(null==i||i.writable)&&(a[h]=ib(b[h],h,c,d,e))}}function id(a){var b;return b=(b,c,d,e)=>{let f=void 0;if(null!=f)return f;if("object"==typeof a)switch(Object.prototype.toString.call(a)){case h8:case h7:case h9:{let b=new a.constructor(a?.valueOf());return ic(b,a),b}case ia:{let b={};return ic(b,a),b.length=a.length,b[Symbol.iterator]=a[Symbol.iterator],b}default:return}},ib(a,void 0,a,new Map,b)}function ie(a){return null!==a&&"object"==typeof a&&"[object Arguments]"===h6(a)}var ig=Object.defineProperty,ih=Object.defineProperties,ii=Object.getOwnPropertyDescriptors,ij=Object.getOwnPropertySymbols,ik=Object.prototype.hasOwnProperty,il=Object.prototype.propertyIsEnumerable,im=(a,b,c)=>b in a?ig(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c,io=(a,b)=>{for(var c in b||(b={}))ik.call(b,c)&&im(a,c,b[c]);if(ij)for(var c of ij(b))il.call(b,c)&&im(a,c,b[c]);return a},ip=(a,b)=>ih(a,ii(b));function iq(a,b,c){var d;let e=ae(a);return(null==(d=b.rpcMap)?void 0:d[e.reference])||`${hZ}?chainId=${e.namespace}:${e.reference}&projectId=${c}`}function ir(a){return a.includes(":")?a.split(":")[1]:a}function is(a){return a.map(a=>`${a.split(":")[0]}:${a.split(":")[1]}`)}function it(a={},b={}){return function(a,...b){return function(a,...b){let c=b.slice(0,-1),d=b[b.length-1],e=a;for(let a=0;a<c.length;a++)e=function a(b,c,d,e){if(h2(b)&&(b=Object(b)),null==c||"object"!=typeof c)return b;if(e.has(c))return function(a){if(h2(a))return a;if(Array.isArray(a)||h3(a)||a instanceof ArrayBuffer||"u">typeof SharedArrayBuffer&&a instanceof SharedArrayBuffer)return a.slice(0);let b=Object.getPrototypeOf(a),c=b.constructor;if(a instanceof Date||a instanceof Map||a instanceof Set)return new c(a);if(a instanceof RegExp){let b=new c(a);return b.lastIndex=a.lastIndex,b}if(a instanceof DataView)return new c(a.buffer.slice(0));if(a instanceof Error){let b=new c(a.message);return b.stack=a.stack,b.name=a.name,b.cause=a.cause,b}return"u">typeof File&&a instanceof File?new c([a],a.name,{type:a.type,lastModified:a.lastModified}):"object"==typeof a?Object.assign(Object.create(b),a):a}(e.get(c));if(e.set(c,b),Array.isArray(c)){c=c.slice();for(let a=0;a<c.length;a++)c[a]=c[a]??void 0}let f=[...Object.keys(c),...h5(c)];for(let g=0;g<f.length;g++){let h=f[g],i=c[h],j=b[h];if(ie(i)&&(i={...i}),ie(j)&&(j={...j}),"u">typeof Buffer&&Buffer.isBuffer(i)&&(i=id(i)),Array.isArray(i))if("object"==typeof j&&null!=j){let a=[],b=Reflect.ownKeys(j);for(let c=0;c<b.length;c++){let d=b[c];a[d]=j[d]}j=a}else j=[];let k=d(j,i,h,b,c,e);null!=k?b[h]=k:Array.isArray(i)||h4(j)&&h4(i)?b[h]=a(j,i,d,e):null==j&&function(a){if("object"!=typeof a||null==a)return!1;if(null===Object.getPrototypeOf(a))return!0;if("[object Object]"!==Object.prototype.toString.call(a)){let b=a[Symbol.toStringTag];return null!=b&&!!Object.getOwnPropertyDescriptor(a,Symbol.toStringTag)?.writable&&a.toString()===`[object ${b}]`}let b=a;for(;null!==Object.getPrototypeOf(b);)b=Object.getPrototypeOf(b);return Object.getPrototypeOf(a)===b}(i)?b[h]=a({},i,d,e):null==j&&h3(i)?b[h]=id(i):(void 0===j||void 0!==i)&&(b[h]=i)}return b}(e,c[a],d,new Map);return e}(a,...b,h1)}(iu(a),iu(b))}function iu(a){var b,c,d,e,f;let g={};if(!d0(a))return g;for(let[h,i]of Object.entries(a)){let a=dT(h)?[h]:i.chains,j=i.methods||[],k=i.events||[],l=i.rpcMap||{},m=dU(h);g[m]=ip(io(io({},g[m]),i),{chains:aH(a,null==(b=g[m])?void 0:b.chains),methods:aH(j,null==(c=g[m])?void 0:c.methods),events:aH(k,null==(d=g[m])?void 0:d.events)}),(d0(l)||d0((null==(e=g[m])?void 0:e.rpcMap)||{}))&&(g[m].rpcMap=io(io({},l),null==(f=g[m])?void 0:f.rpcMap))}return g}function iv(a){return a.includes(":")?a.split(":")[2]:a}function iw(a){let b={};for(let[c,d]of Object.entries(a)){let a=d.methods||[],e=d.events||[],f=d.accounts||[],g=dT(c)?[c]:d.chains?d.chains:is(d.accounts);b[c]={chains:g,methods:a,events:e,accounts:f}}return b}function ix(a){return"number"==typeof a?a:a.includes("0x")?parseInt(a,16):isNaN(Number(a=a.includes(":")?a.split(":")[1]:a))?a:Number(a)}let iy={},iz=a=>iy[a],iA=(a,b)=>{iy[a]=b};var iB=Object.defineProperty,iC=(a,b,c)=>((a,b,c)=>b in a?iB(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c)(a,"symbol"!=typeof b?b+"":b,c);class iD{constructor(a){iC(this,"name","polkadot"),iC(this,"client"),iC(this,"httpProviders"),iC(this,"events"),iC(this,"namespace"),iC(this,"chainId"),this.namespace=a.namespace,this.events=iz("events"),this.client=iz("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(a){this.namespace=Object.assign(this.namespace,a)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let a=this.namespace.chains[0];if(!a)throw Error("ChainId not found");return a.split(":")[1]}request(a){return this.namespace.methods.includes(a.request.method)?this.client.request(a):this.getHttpProvider().request(a.request)}setDefaultChain(a,b){this.httpProviders[a]||this.setHttpProvider(a,b),this.chainId=a,this.events.emit(h0.DEFAULT_CHAIN_CHANGED,`${this.name}:${a}`)}getAccounts(){let a=this.namespace.accounts;return a&&a.filter(a=>a.split(":")[1]===this.chainId.toString()).map(a=>a.split(":")[2])||[]}createHttpProviders(){let a={};return this.namespace.chains.forEach(b=>{var c;let d=ir(b);a[d]=this.createHttpProvider(d,null==(c=this.namespace.rpcMap)?void 0:c[b])}),a}getHttpProvider(){let a=`${this.name}:${this.chainId}`,b=this.httpProviders[a];if(typeof b>"u")throw Error(`JSON-RPC provider for ${a} not found`);return b}setHttpProvider(a,b){let c=this.createHttpProvider(a,b);c&&(this.httpProviders[a]=c)}createHttpProvider(a,b){let c=b||iq(a,this.namespace,this.client.core.projectId);return new eF.JsonRpcProvider(new hW.default(c,iz("disableProviderPing")))}}var iE=Object.defineProperty,iF=Object.defineProperties,iG=Object.getOwnPropertyDescriptors,iH=Object.getOwnPropertySymbols,iI=Object.prototype.hasOwnProperty,iJ=Object.prototype.propertyIsEnumerable,iK=(a,b,c)=>b in a?iE(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c,iL=(a,b)=>{for(var c in b||(b={}))iI.call(b,c)&&iK(a,c,b[c]);if(iH)for(var c of iH(b))iJ.call(b,c)&&iK(a,c,b[c]);return a},iM=(a,b)=>iF(a,iG(b)),iN=(a,b,c)=>iK(a,"symbol"!=typeof b?b+"":b,c);class iO{constructor(a){iN(this,"name","eip155"),iN(this,"client"),iN(this,"chainId"),iN(this,"namespace"),iN(this,"httpProviders"),iN(this,"events"),this.namespace=a.namespace,this.events=iz("events"),this.client=iz("client"),this.httpProviders=this.createHttpProviders(),this.chainId=parseInt(this.getDefaultChain())}async request(a){switch(a.request.method){case"eth_requestAccounts":case"eth_accounts":return this.getAccounts();case"wallet_switchEthereumChain":return await this.handleSwitchChain(a);case"eth_chainId":return parseInt(this.getDefaultChain());case"wallet_getCapabilities":return await this.getCapabilities(a);case"wallet_getCallsStatus":return await this.getCallStatus(a)}return this.namespace.methods.includes(a.request.method)?await this.client.request(a):this.getHttpProvider().request(a.request)}updateNamespace(a){this.namespace=Object.assign(this.namespace,a)}setDefaultChain(a,b){this.httpProviders[a]||this.setHttpProvider(parseInt(a),b),this.chainId=parseInt(a),this.events.emit(h0.DEFAULT_CHAIN_CHANGED,`${this.name}:${a}`)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId.toString();if(this.namespace.defaultChain)return this.namespace.defaultChain;let a=this.namespace.chains[0];if(!a)throw Error("ChainId not found");return a.split(":")[1]}createHttpProvider(a,b){let c=b||iq(`${this.name}:${a}`,this.namespace,this.client.core.projectId);return new eF.JsonRpcProvider(new hW.HttpConnection(c,iz("disableProviderPing")))}setHttpProvider(a,b){let c=this.createHttpProvider(a,b);c&&(this.httpProviders[a]=c)}createHttpProviders(){let a={};return this.namespace.chains.forEach(b=>{var c;let d=parseInt(ir(b));a[d]=this.createHttpProvider(d,null==(c=this.namespace.rpcMap)?void 0:c[b])}),a}getAccounts(){let a=this.namespace.accounts;return a?[...new Set(a.filter(a=>a.split(":")[1]===this.chainId.toString()).map(a=>a.split(":")[2]))]:[]}getHttpProvider(){let a=this.chainId,b=this.httpProviders[a];if(typeof b>"u")throw Error(`JSON-RPC provider for ${a} not found`);return b}async handleSwitchChain(a){var b,c;let d=a.request.params?null==(b=a.request.params[0])?void 0:b.chainId:"0x0",e=parseInt(d=d.startsWith("0x")?d:`0x${d}`,16);if(this.isChainApproved(e))this.setDefaultChain(`${e}`);else if(this.namespace.methods.includes("wallet_switchEthereumChain"))await this.client.request({topic:a.topic,request:{method:a.request.method,params:[{chainId:d}]},chainId:null==(c=this.namespace.chains)?void 0:c[0]}),this.setDefaultChain(`${e}`);else throw Error(`Failed to switch to chain 'eip155:${e}'. The chain is not approved or the wallet does not support 'wallet_switchEthereumChain' method.`);return null}isChainApproved(a){return this.namespace.chains.includes(`${this.name}:${a}`)}async getCapabilities(a){var b,c,d,e,f;let g=null==(c=null==(b=a.request)?void 0:b.params)?void 0:c[0],h=(null==(e=null==(d=a.request)?void 0:d.params)?void 0:e[1])||[],i=`${g}${h.join(",")}`;if(!g)throw Error("Missing address parameter in `wallet_getCapabilities` request");let j=this.client.session.get(a.topic),k=(null==(f=j?.sessionProperties)?void 0:f.capabilities)||{};if(null!=k&&k[i])return k?.[i];let l=await this.client.request(a);try{await this.client.session.update(a.topic,{sessionProperties:iM(iL({},j.sessionProperties||{}),{capabilities:iM(iL({},k||{}),{[i]:l})})})}catch(a){console.warn("Failed to update session with capabilities",a)}return l}async getCallStatus(a){var b,c;let d=this.client.session.get(a.topic),e=null==(b=d.sessionProperties)?void 0:b.bundler_name;if(e){let b=this.getBundlerUrl(a.chainId,e);try{return await this.getUserOperationReceipt(b,a)}catch(a){console.warn("Failed to fetch call status from bundler",a,b)}}let f=null==(c=d.sessionProperties)?void 0:c.bundler_url;if(f)try{return await this.getUserOperationReceipt(f,a)}catch(a){console.warn("Failed to fetch call status from custom bundler",a,f)}if(this.namespace.methods.includes(a.request.method))return await this.client.request(a);throw Error("Fetching call status not approved by the wallet.")}async getUserOperationReceipt(a,b){var c;let d=new URL(a),e=await fetch(d,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify((0,eG.formatJsonRpcRequest)("eth_getUserOperationReceipt",[null==(c=b.request.params)?void 0:c[0]]))});if(!e.ok)throw Error(`Failed to fetch user operation receipt - ${e.status}`);return await e.json()}getBundlerUrl(a,b){return`${h_}?projectId=${this.client.core.projectId}&chainId=${a}&bundler=${b}`}}var iP=Object.defineProperty,iQ=(a,b,c)=>((a,b,c)=>b in a?iP(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c)(a,"symbol"!=typeof b?b+"":b,c);class iR{constructor(a){iQ(this,"name","solana"),iQ(this,"client"),iQ(this,"httpProviders"),iQ(this,"events"),iQ(this,"namespace"),iQ(this,"chainId"),this.namespace=a.namespace,this.events=iz("events"),this.client=iz("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(a){this.namespace=Object.assign(this.namespace,a)}requestAccounts(){return this.getAccounts()}request(a){return this.namespace.methods.includes(a.request.method)?this.client.request(a):this.getHttpProvider().request(a.request)}setDefaultChain(a,b){this.httpProviders[a]||this.setHttpProvider(a,b),this.chainId=a,this.events.emit(h0.DEFAULT_CHAIN_CHANGED,`${this.name}:${a}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let a=this.namespace.chains[0];if(!a)throw Error("ChainId not found");return a.split(":")[1]}getAccounts(){let a=this.namespace.accounts;return a?[...new Set(a.filter(a=>a.split(":")[1]===this.chainId.toString()).map(a=>a.split(":")[2]))]:[]}createHttpProviders(){let a={};return this.namespace.chains.forEach(b=>{var c;let d=ir(b);a[d]=this.createHttpProvider(d,null==(c=this.namespace.rpcMap)?void 0:c[b])}),a}getHttpProvider(){let a=`${this.name}:${this.chainId}`,b=this.httpProviders[a];if(typeof b>"u")throw Error(`JSON-RPC provider for ${a} not found`);return b}setHttpProvider(a,b){let c=this.createHttpProvider(a,b);c&&(this.httpProviders[a]=c)}createHttpProvider(a,b){let c=b||iq(a,this.namespace,this.client.core.projectId);return new eF.JsonRpcProvider(new hW.default(c,iz("disableProviderPing")))}}var iS=Object.defineProperty,iT=(a,b,c)=>((a,b,c)=>b in a?iS(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c)(a,"symbol"!=typeof b?b+"":b,c);class iU{constructor(a){iT(this,"name","cosmos"),iT(this,"client"),iT(this,"httpProviders"),iT(this,"events"),iT(this,"namespace"),iT(this,"chainId"),this.namespace=a.namespace,this.events=iz("events"),this.client=iz("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(a){this.namespace=Object.assign(this.namespace,a)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let a=this.namespace.chains[0];if(!a)throw Error("ChainId not found");return a.split(":")[1]}request(a){return this.namespace.methods.includes(a.request.method)?this.client.request(a):this.getHttpProvider().request(a.request)}setDefaultChain(a,b){this.httpProviders[a]||this.setHttpProvider(a,b),this.chainId=a,this.events.emit(h0.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getAccounts(){let a=this.namespace.accounts;return a?[...new Set(a.filter(a=>a.split(":")[1]===this.chainId.toString()).map(a=>a.split(":")[2]))]:[]}createHttpProviders(){let a={};return this.namespace.chains.forEach(b=>{var c;let d=ir(b);a[d]=this.createHttpProvider(d,null==(c=this.namespace.rpcMap)?void 0:c[b])}),a}getHttpProvider(){let a=`${this.name}:${this.chainId}`,b=this.httpProviders[a];if(typeof b>"u")throw Error(`JSON-RPC provider for ${a} not found`);return b}setHttpProvider(a,b){let c=this.createHttpProvider(a,b);c&&(this.httpProviders[a]=c)}createHttpProvider(a,b){let c=b||iq(a,this.namespace,this.client.core.projectId);return new eF.JsonRpcProvider(new hW.default(c,iz("disableProviderPing")))}}var iV=Object.defineProperty,iW=(a,b,c)=>((a,b,c)=>b in a?iV(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c)(a,"symbol"!=typeof b?b+"":b,c);class iX{constructor(a){iW(this,"name","algorand"),iW(this,"client"),iW(this,"httpProviders"),iW(this,"events"),iW(this,"namespace"),iW(this,"chainId"),this.namespace=a.namespace,this.events=iz("events"),this.client=iz("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(a){this.namespace=Object.assign(this.namespace,a)}requestAccounts(){return this.getAccounts()}request(a){return this.namespace.methods.includes(a.request.method)?this.client.request(a):this.getHttpProvider().request(a.request)}setDefaultChain(a,b){if(!this.httpProviders[a]){let c=b||iq(`${this.name}:${a}`,this.namespace,this.client.core.projectId);this.setHttpProvider(a,c)}this.chainId=a,this.events.emit(h0.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let a=this.namespace.chains[0];if(!a)throw Error("ChainId not found");return a.split(":")[1]}getAccounts(){let a=this.namespace.accounts;return a?[...new Set(a.filter(a=>a.split(":")[1]===this.chainId.toString()).map(a=>a.split(":")[2]))]:[]}createHttpProviders(){let a={};return this.namespace.chains.forEach(b=>{var c;a[b]=this.createHttpProvider(b,null==(c=this.namespace.rpcMap)?void 0:c[b])}),a}getHttpProvider(){let a=`${this.name}:${this.chainId}`,b=this.httpProviders[a];if(typeof b>"u")throw Error(`JSON-RPC provider for ${a} not found`);return b}setHttpProvider(a,b){let c=this.createHttpProvider(a,b);c&&(this.httpProviders[a]=c)}createHttpProvider(a,b){let c=b||iq(a,this.namespace,this.client.core.projectId);return typeof c>"u"?void 0:new eF.JsonRpcProvider(new hW.default(c,iz("disableProviderPing")))}}var iY=Object.defineProperty,iZ=(a,b,c)=>((a,b,c)=>b in a?iY(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c)(a,"symbol"!=typeof b?b+"":b,c);class i${constructor(a){iZ(this,"name","cip34"),iZ(this,"client"),iZ(this,"httpProviders"),iZ(this,"events"),iZ(this,"namespace"),iZ(this,"chainId"),this.namespace=a.namespace,this.events=iz("events"),this.client=iz("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(a){this.namespace=Object.assign(this.namespace,a)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let a=this.namespace.chains[0];if(!a)throw Error("ChainId not found");return a.split(":")[1]}request(a){return this.namespace.methods.includes(a.request.method)?this.client.request(a):this.getHttpProvider().request(a.request)}setDefaultChain(a,b){this.httpProviders[a]||this.setHttpProvider(a,b),this.chainId=a,this.events.emit(h0.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getAccounts(){let a=this.namespace.accounts;return a?[...new Set(a.filter(a=>a.split(":")[1]===this.chainId.toString()).map(a=>a.split(":")[2]))]:[]}createHttpProviders(){let a={};return this.namespace.chains.forEach(b=>{let c=this.getCardanoRPCUrl(b),d=ir(b);a[d]=this.createHttpProvider(d,c)}),a}getHttpProvider(){let a=`${this.name}:${this.chainId}`,b=this.httpProviders[a];if(typeof b>"u")throw Error(`JSON-RPC provider for ${a} not found`);return b}getCardanoRPCUrl(a){let b=this.namespace.rpcMap;if(b)return b[a]}setHttpProvider(a,b){let c=this.createHttpProvider(a,b);c&&(this.httpProviders[a]=c)}createHttpProvider(a,b){let c=b||this.getCardanoRPCUrl(a);if(!c)throw Error(`No RPC url provided for chainId: ${a}`);return new eF.JsonRpcProvider(new hW.default(c,iz("disableProviderPing")))}}var i_=Object.defineProperty,i0=(a,b,c)=>((a,b,c)=>b in a?i_(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c)(a,"symbol"!=typeof b?b+"":b,c);class i1{constructor(a){i0(this,"name","elrond"),i0(this,"client"),i0(this,"httpProviders"),i0(this,"events"),i0(this,"namespace"),i0(this,"chainId"),this.namespace=a.namespace,this.events=iz("events"),this.client=iz("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(a){this.namespace=Object.assign(this.namespace,a)}requestAccounts(){return this.getAccounts()}request(a){return this.namespace.methods.includes(a.request.method)?this.client.request(a):this.getHttpProvider().request(a.request)}setDefaultChain(a,b){this.httpProviders[a]||this.setHttpProvider(a,b),this.chainId=a,this.events.emit(h0.DEFAULT_CHAIN_CHANGED,`${this.name}:${a}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let a=this.namespace.chains[0];if(!a)throw Error("ChainId not found");return a.split(":")[1]}getAccounts(){let a=this.namespace.accounts;return a?[...new Set(a.filter(a=>a.split(":")[1]===this.chainId.toString()).map(a=>a.split(":")[2]))]:[]}createHttpProviders(){let a={};return this.namespace.chains.forEach(b=>{var c;let d=ir(b);a[d]=this.createHttpProvider(d,null==(c=this.namespace.rpcMap)?void 0:c[b])}),a}getHttpProvider(){let a=`${this.name}:${this.chainId}`,b=this.httpProviders[a];if(typeof b>"u")throw Error(`JSON-RPC provider for ${a} not found`);return b}setHttpProvider(a,b){let c=this.createHttpProvider(a,b);c&&(this.httpProviders[a]=c)}createHttpProvider(a,b){let c=b||iq(a,this.namespace,this.client.core.projectId);return new eF.JsonRpcProvider(new hW.default(c,iz("disableProviderPing")))}}var i2=Object.defineProperty,i3=(a,b,c)=>((a,b,c)=>b in a?i2(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c)(a,"symbol"!=typeof b?b+"":b,c);class i4{constructor(a){i3(this,"name","multiversx"),i3(this,"client"),i3(this,"httpProviders"),i3(this,"events"),i3(this,"namespace"),i3(this,"chainId"),this.namespace=a.namespace,this.events=iz("events"),this.client=iz("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(a){this.namespace=Object.assign(this.namespace,a)}requestAccounts(){return this.getAccounts()}request(a){return this.namespace.methods.includes(a.request.method)?this.client.request(a):this.getHttpProvider().request(a.request)}setDefaultChain(a,b){this.httpProviders[a]||this.setHttpProvider(a,b),this.chainId=a,this.events.emit(h0.DEFAULT_CHAIN_CHANGED,`${this.name}:${a}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let a=this.namespace.chains[0];if(!a)throw Error("ChainId not found");return a.split(":")[1]}getAccounts(){let a=this.namespace.accounts;return a?[...new Set(a.filter(a=>a.split(":")[1]===this.chainId.toString()).map(a=>a.split(":")[2]))]:[]}createHttpProviders(){let a={};return this.namespace.chains.forEach(b=>{var c;let d=ir(b);a[d]=this.createHttpProvider(d,null==(c=this.namespace.rpcMap)?void 0:c[b])}),a}getHttpProvider(){let a=`${this.name}:${this.chainId}`,b=this.httpProviders[a];if(typeof b>"u")throw Error(`JSON-RPC provider for ${a} not found`);return b}setHttpProvider(a,b){let c=this.createHttpProvider(a,b);c&&(this.httpProviders[a]=c)}createHttpProvider(a,b){let c=b||iq(a,this.namespace,this.client.core.projectId);return new eF.JsonRpcProvider(new hW.default(c,iz("disableProviderPing")))}}var i5=Object.defineProperty,i6=(a,b,c)=>((a,b,c)=>b in a?i5(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c)(a,"symbol"!=typeof b?b+"":b,c);class i7{constructor(a){i6(this,"name","near"),i6(this,"client"),i6(this,"httpProviders"),i6(this,"events"),i6(this,"namespace"),i6(this,"chainId"),this.namespace=a.namespace,this.events=iz("events"),this.client=iz("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(a){this.namespace=Object.assign(this.namespace,a)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let a=this.namespace.chains[0];if(!a)throw Error("ChainId not found");return a.split(":")[1]}request(a){return this.namespace.methods.includes(a.request.method)?this.client.request(a):this.getHttpProvider().request(a.request)}setDefaultChain(a,b){if(this.chainId=a,!this.httpProviders[a]){let c=b||iq(`${this.name}:${a}`,this.namespace);this.setHttpProvider(a,c)}this.events.emit(h0.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getAccounts(){let a=this.namespace.accounts;return a&&a.filter(a=>a.split(":")[1]===this.chainId.toString()).map(a=>a.split(":")[2])||[]}createHttpProviders(){let a={};return this.namespace.chains.forEach(b=>{var c;a[b]=this.createHttpProvider(b,null==(c=this.namespace.rpcMap)?void 0:c[b])}),a}getHttpProvider(){let a=`${this.name}:${this.chainId}`,b=this.httpProviders[a];if(typeof b>"u")throw Error(`JSON-RPC provider for ${a} not found`);return b}setHttpProvider(a,b){let c=this.createHttpProvider(a,b);c&&(this.httpProviders[a]=c)}createHttpProvider(a,b){let c=b||iq(a,this.namespace);return typeof c>"u"?void 0:new eF.JsonRpcProvider(new hW.default(c,iz("disableProviderPing")))}}var i8=Object.defineProperty,i9=(a,b,c)=>((a,b,c)=>b in a?i8(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c)(a,"symbol"!=typeof b?b+"":b,c);class ja{constructor(a){i9(this,"name","tezos"),i9(this,"client"),i9(this,"httpProviders"),i9(this,"events"),i9(this,"namespace"),i9(this,"chainId"),this.namespace=a.namespace,this.events=iz("events"),this.client=iz("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(a){this.namespace=Object.assign(this.namespace,a)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let a=this.namespace.chains[0];if(!a)throw Error("ChainId not found");return a.split(":")[1]}request(a){return this.namespace.methods.includes(a.request.method)?this.client.request(a):this.getHttpProvider().request(a.request)}setDefaultChain(a,b){if(this.chainId=a,!this.httpProviders[a]){let c=b||iq(`${this.name}:${a}`,this.namespace);this.setHttpProvider(a,c)}this.events.emit(h0.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getAccounts(){let a=this.namespace.accounts;return a&&a.filter(a=>a.split(":")[1]===this.chainId.toString()).map(a=>a.split(":")[2])||[]}createHttpProviders(){let a={};return this.namespace.chains.forEach(b=>{a[b]=this.createHttpProvider(b)}),a}getHttpProvider(){let a=`${this.name}:${this.chainId}`,b=this.httpProviders[a];if(typeof b>"u")throw Error(`JSON-RPC provider for ${a} not found`);return b}setHttpProvider(a,b){let c=this.createHttpProvider(a,b);c&&(this.httpProviders[a]=c)}createHttpProvider(a,b){let c=b||iq(a,this.namespace);return typeof c>"u"?void 0:new eF.JsonRpcProvider(new hW.default(c))}}var jb=Object.defineProperty,jc=(a,b,c)=>((a,b,c)=>b in a?jb(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c)(a,"symbol"!=typeof b?b+"":b,c);class jd{constructor(a){jc(this,"name",h$),jc(this,"client"),jc(this,"httpProviders"),jc(this,"events"),jc(this,"namespace"),jc(this,"chainId"),this.namespace=a.namespace,this.events=iz("events"),this.client=iz("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(a){this.namespace.chains=[...new Set((this.namespace.chains||[]).concat(a.chains||[]))],this.namespace.accounts=[...new Set((this.namespace.accounts||[]).concat(a.accounts||[]))],this.namespace.methods=[...new Set((this.namespace.methods||[]).concat(a.methods||[]))],this.namespace.events=[...new Set((this.namespace.events||[]).concat(a.events||[]))],this.httpProviders=this.createHttpProviders()}requestAccounts(){return this.getAccounts()}request(a){return this.namespace.methods.includes(a.request.method)?this.client.request(a):this.getHttpProvider(a.chainId).request(a.request)}setDefaultChain(a,b){this.httpProviders[a]||this.setHttpProvider(a,b),this.chainId=a,this.events.emit(h0.DEFAULT_CHAIN_CHANGED,`${this.name}:${a}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let a=this.namespace.chains[0];if(!a)throw Error("ChainId not found");return a.split(":")[1]}getAccounts(){let a=this.namespace.accounts;return a?[...new Set(a.filter(a=>a.split(":")[1]===this.chainId.toString()).map(a=>a.split(":")[2]))]:[]}createHttpProviders(){var a,b;let c={};return null==(b=null==(a=this.namespace)?void 0:a.accounts)||b.forEach(a=>{let b=ae(a);c[`${b.namespace}:${b.reference}`]=this.createHttpProvider(a)}),c}getHttpProvider(a){let b=this.httpProviders[a];if(typeof b>"u")throw Error(`JSON-RPC provider for ${a} not found`);return b}setHttpProvider(a,b){let c=this.createHttpProvider(a,b);c&&(this.httpProviders[a]=c)}createHttpProvider(a,b){let c=b||iq(a,this.namespace,this.client.core.projectId);return new eF.JsonRpcProvider(new hW.default(c,iz("disableProviderPing")))}}var je=Object.defineProperty,jf=Object.defineProperties,jg=Object.getOwnPropertyDescriptors,jh=Object.getOwnPropertySymbols,ji=Object.prototype.hasOwnProperty,jj=Object.prototype.propertyIsEnumerable,jk=(a,b,c)=>b in a?je(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c,jl=(a,b)=>{for(var c in b||(b={}))ji.call(b,c)&&jk(a,c,b[c]);if(jh)for(var c of jh(b))jj.call(b,c)&&jk(a,c,b[c]);return a},jm=(a,b)=>jf(a,jg(b)),jn=(a,b,c)=>jk(a,"symbol"!=typeof b?b+"":b,c);class jo{constructor(a){jn(this,"client"),jn(this,"namespaces"),jn(this,"optionalNamespaces"),jn(this,"sessionProperties"),jn(this,"scopedProperties"),jn(this,"events",new b.default),jn(this,"rpcProviders",{}),jn(this,"session"),jn(this,"providerOpts"),jn(this,"logger"),jn(this,"uri"),jn(this,"disableProviderPing",!1),this.providerOpts=a,this.logger="u">typeof a?.logger&&"string"!=typeof a?.logger?a.logger:(0,ek.pino)((0,ej.getDefaultLoggerOptions)({level:a?.logger||hX})),this.disableProviderPing=a?.disableProviderPing||!1}static async init(a){let b=new jo(a);return await b.initialize(),b}async request(a,b,c){let[d,e]=this.validateChain(b);if(!this.session)throw Error("Please call connect() before request()");return await this.getProvider(d).request({request:jl({},a),chainId:`${d}:${e}`,topic:this.session.topic,expiry:c})}sendAsync(a,b,c,d){let e=new Date().getTime();this.request(a,c,d).then(a=>b(null,(0,eG.formatJsonRpcResult)(e,a))).catch(a=>b(a,void 0))}async enable(){if(!this.client)throw Error("Sign Client not initialized");return this.session||await this.connect({namespaces:this.namespaces,optionalNamespaces:this.optionalNamespaces,sessionProperties:this.sessionProperties,scopedProperties:this.scopedProperties}),await this.requestAccounts()}async disconnect(){var a;if(!this.session)throw Error("Please call connect() before enable()");await this.client.disconnect({topic:null==(a=this.session)?void 0:a.topic,reason:d$("USER_DISCONNECTED")}),await this.cleanup()}async connect(a){if(!this.client)throw Error("Sign Client not initialized");if(this.setNamespaces(a),await this.cleanupPendingPairings(),!a.skipPairing)return await this.pair(a.pairingTopic)}async authenticate(a,b){if(!this.client)throw Error("Sign Client not initialized");this.setNamespaces(a),await this.cleanupPendingPairings();let{uri:c,response:d}=await this.client.authenticate(a,b);c&&(this.uri=c,this.events.emit("display_uri",c));let e=await d();if(this.session=e.session,this.session){let a=iw(this.session.namespaces);this.namespaces=it(this.namespaces,a),await this.persist("namespaces",this.namespaces),this.onConnect()}return e}on(a,b){this.events.on(a,b)}once(a,b){this.events.once(a,b)}removeListener(a,b){this.events.removeListener(a,b)}off(a,b){this.events.off(a,b)}get isWalletConnect(){return!0}async pair(a){let{uri:b,approval:c}=await this.client.connect({pairingTopic:a,requiredNamespaces:this.namespaces,optionalNamespaces:this.optionalNamespaces,sessionProperties:this.sessionProperties,scopedProperties:this.scopedProperties});b&&(this.uri=b,this.events.emit("display_uri",b));let d=await c();this.session=d;let e=iw(d.namespaces);return this.namespaces=it(this.namespaces,e),await this.persist("namespaces",this.namespaces),await this.persist("optionalNamespaces",this.optionalNamespaces),this.onConnect(),this.session}setDefaultChain(a,b){try{if(!this.session)return;let[c,d]=this.validateChain(a),e=this.getProvider(c);e.name===h$?e.setDefaultChain(`${c}:${d}`,b):e.setDefaultChain(d,b)}catch(a){if(!/Please call connect/.test(a.message))throw a}}async cleanupPendingPairings(a={}){this.logger.info("Cleaning up inactive pairings...");let b=this.client.pairing.getAll();if(d_(b)){for(let c of b)a.deletePairings?this.client.core.expirer.set(c.topic,0):await this.client.core.relayer.subscriber.unsubscribe(c.topic);this.logger.info(`Inactive pairings cleared: ${b.length}`)}}abortPairingAttempt(){this.logger.warn("abortPairingAttempt is deprecated. This is now a no-op.")}async checkStorage(){this.namespaces=await this.getFromStore("namespaces")||{},this.optionalNamespaces=await this.getFromStore("optionalNamespaces")||{},this.session&&this.createProviders()}async initialize(){this.logger.trace("Initialized"),await this.createClient(),await this.checkStorage(),this.registerEventListeners()}async createClient(){var a,b;if(this.client=this.providerOpts.client||await hV.init({core:this.providerOpts.core,logger:this.providerOpts.logger||hX,relayUrl:this.providerOpts.relayUrl||"wss://relay.walletconnect.org",projectId:this.providerOpts.projectId,metadata:this.providerOpts.metadata,storageOptions:this.providerOpts.storageOptions,storage:this.providerOpts.storage,name:this.providerOpts.name,customStoragePrefix:this.providerOpts.customStoragePrefix,telemetryEnabled:this.providerOpts.telemetryEnabled}),this.providerOpts.session)try{this.session=this.client.session.get(this.providerOpts.session.topic)}catch(c){throw this.logger.error("Failed to get session",c),Error(`The provided session: ${null==(b=null==(a=this.providerOpts)?void 0:a.session)?void 0:b.topic} doesn't exist in the Sign client`)}else{let a=this.client.session.getAll();this.session=a[0]}this.logger.trace("SignClient Initialized")}createProviders(){if(!this.client)throw Error("Sign Client not initialized");if(!this.session)throw Error("Session not initialized. Please call connect() before enable()");let a=[...new Set(Object.keys(this.session.namespaces).map(a=>dU(a)))];iA("client",this.client),iA("events",this.events),iA("disableProviderPing",this.disableProviderPing),a.forEach(a=>{if(!this.session)return;let b=function(a,b){let c=Object.keys(b.namespaces).filter(b=>b.includes(a));if(!c.length)return[];let d=[];return c.forEach(a=>{let c=b.namespaces[a].accounts;d.push(...c)}),d}(a,this.session),c=is(b),d=jm(jl({},it(this.namespaces,this.optionalNamespaces)[a]),{accounts:b,chains:c});switch(a){case"eip155":this.rpcProviders[a]=new iO({namespace:d});break;case"algorand":this.rpcProviders[a]=new iX({namespace:d});break;case"solana":this.rpcProviders[a]=new iR({namespace:d});break;case"cosmos":this.rpcProviders[a]=new iU({namespace:d});break;case"polkadot":this.rpcProviders[a]=new iD({namespace:d});break;case"cip34":this.rpcProviders[a]=new i$({namespace:d});break;case"elrond":this.rpcProviders[a]=new i1({namespace:d});break;case"multiversx":this.rpcProviders[a]=new i4({namespace:d});break;case"near":this.rpcProviders[a]=new i7({namespace:d});break;case"tezos":this.rpcProviders[a]=new ja({namespace:d});break;default:this.rpcProviders[h$]?this.rpcProviders[h$].updateNamespace(d):this.rpcProviders[h$]=new jd({namespace:d})}})}registerEventListeners(){if(typeof this.client>"u")throw Error("Sign Client is not initialized");this.client.on("session_ping",a=>{var b;let{topic:c}=a;c===(null==(b=this.session)?void 0:b.topic)&&this.events.emit("session_ping",a)}),this.client.on("session_event",a=>{var b;let{params:c,topic:d}=a;if(d!==(null==(b=this.session)?void 0:b.topic))return;let{event:e}=c;if("accountsChanged"===e.name){let a=e.data;a&&d_(a)&&this.events.emit("accountsChanged",a.map(iv))}else if("chainChanged"===e.name){let a=c.chainId,b=c.event.data,d=dU(a),e=ix(a)!==ix(b)?`${d}:${ix(b)}`:a;this.onChainChanged(e)}else this.events.emit(e.name,e.data);this.events.emit("session_event",a)}),this.client.on("session_update",({topic:a,params:b})=>{var c,d;if(a!==(null==(c=this.session)?void 0:c.topic))return;let{namespaces:e}=b,f=null==(d=this.client)?void 0:d.session.get(a);this.session=jm(jl({},f),{namespaces:e}),this.onSessionUpdate(),this.events.emit("session_update",{topic:a,params:b})}),this.client.on("session_delete",async a=>{var b;a.topic===(null==(b=this.session)?void 0:b.topic)&&(await this.cleanup(),this.events.emit("session_delete",a),this.events.emit("disconnect",jm(jl({},d$("USER_DISCONNECTED")),{data:a.topic})))}),this.on(h0.DEFAULT_CHAIN_CHANGED,a=>{this.onChainChanged(a,!0)})}getProvider(a){return this.rpcProviders[a]||this.rpcProviders[h$]}onSessionUpdate(){Object.keys(this.rpcProviders).forEach(a=>{var b;this.getProvider(a).updateNamespace(null==(b=this.session)?void 0:b.namespaces[a])})}setNamespaces(a){let{namespaces:b={},optionalNamespaces:c={},sessionProperties:d,scopedProperties:e}=a;this.optionalNamespaces=it(b,c),this.sessionProperties=d,this.scopedProperties=e}validateChain(a){let[b,c]=a?.split(":")||["",""];if(!this.namespaces||!Object.keys(this.namespaces).length)return[b,c];if(b&&!Object.keys(this.namespaces||{}).map(a=>dU(a)).includes(b))throw Error(`Namespace '${b}' is not configured. Please call connect() first with namespace config.`);if(b&&c)return[b,c];let d=dU(Object.keys(this.namespaces)[0]),e=this.rpcProviders[d].getDefaultChain();return[d,e]}async requestAccounts(){let[a]=this.validateChain();return await this.getProvider(a).requestAccounts()}async onChainChanged(a,b=!1){if(!this.namespaces)return;let[c,d]=this.validateChain(a);if(!d)return;this.updateNamespaceChain(c,d),this.events.emit("chainChanged",d);let e=this.getProvider(c).getDefaultChain();b||this.getProvider(c).setDefaultChain(d),this.emitAccountsChangedOnChainChange({namespace:c,previousChainId:e,newChainId:a}),await this.persist("namespaces",this.namespaces)}emitAccountsChangedOnChainChange({namespace:a,previousChainId:b,newChainId:c}){var d,e;try{if(b===c)return;let f=null==(e=null==(d=this.session)?void 0:d.namespaces[a])?void 0:e.accounts;if(!f)return;let g=f.filter(a=>a.includes(`${c}:`)).map(iv);if(!d_(g))return;this.events.emit("accountsChanged",g)}catch(a){this.logger.warn("Failed to emit accountsChanged on chain change",a)}}updateNamespaceChain(a,b){if(!this.namespaces)return;let c=this.namespaces[a]?a:`${a}:${b}`;this.namespaces[c]?this.namespaces[c]&&(this.namespaces[c].defaultChain=b):this.namespaces[c]={chains:[],methods:[],events:[],defaultChain:b}}onConnect(){this.createProviders(),this.events.emit("connect",{session:this.session})}async cleanup(){this.namespaces=void 0,this.optionalNamespaces=void 0,this.sessionProperties=void 0,await this.deleteFromStore("namespaces"),await this.deleteFromStore("optionalNamespaces"),await this.deleteFromStore("sessionProperties"),this.session=void 0,await this.cleanupPendingPairings({deletePairings:!0}),await this.cleanupStorage()}async persist(a,b){var c;let d=(null==(c=this.session)?void 0:c.topic)||"";await this.client.core.storage.setItem(`${hY}/${a}${d}`,b)}async getFromStore(a){var b;let c=(null==(b=this.session)?void 0:b.topic)||"";return await this.client.core.storage.getItem(`${hY}/${a}${c}`)}async deleteFromStore(a){var b;let c=(null==(b=this.session)?void 0:b.topic)||"";await this.client.core.storage.removeItem(`${hY}/${a}${c}`)}async cleanupStorage(){var a;try{if((null==(a=this.client)?void 0:a.session.length)>0)return;for(let a of(await this.client.core.storage.getKeys()))a.startsWith(hY)&&await this.client.core.storage.removeItem(a)}catch(a){this.logger.warn("Failed to cleanup storage",a)}}}let jp=["eth_sendTransaction","personal_sign"],jq=["eth_accounts","eth_requestAccounts","eth_sendRawTransaction","eth_sign","eth_signTransaction","eth_signTypedData","eth_signTypedData_v3","eth_signTypedData_v4","eth_sendTransaction","personal_sign","wallet_switchEthereumChain","wallet_addEthereumChain","wallet_getPermissions","wallet_requestPermissions","wallet_registerOnboarding","wallet_watchAsset","wallet_scanQRCode","wallet_sendCalls","wallet_getCapabilities","wallet_getCallsStatus","wallet_showCallsStatus"],jr=["chainChanged","accountsChanged"],js=["chainChanged","accountsChanged","message","disconnect","connect"],jt=async()=>{let{createAppKit:b}=await a.A(225206);return b};var ju=Object.defineProperty,jv=Object.defineProperties,jw=Object.getOwnPropertyDescriptors,jx=Object.getOwnPropertySymbols,jy=Object.prototype.hasOwnProperty,jz=Object.prototype.propertyIsEnumerable,jA=(a,b,c)=>b in a?ju(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c,jB=(a,b)=>{for(var c in b||(b={}))jy.call(b,c)&&jA(a,c,b[c]);if(jx)for(var c of jx(b))jz.call(b,c)&&jA(a,c,b[c]);return a},jC=(a,b)=>jv(a,jw(b)),jD=(a,b,c)=>jA(a,"symbol"!=typeof b?b+"":b,c);function jE(a){return Number(a[0].split(":")[1])}function jF(a){return`0x${a.toString(16)}`}class jG{constructor(){jD(this,"events",new b.EventEmitter),jD(this,"namespace","eip155"),jD(this,"accounts",[]),jD(this,"signer"),jD(this,"chainId",1),jD(this,"modal"),jD(this,"rpc"),jD(this,"STORAGE_KEY","wc@2:ethereum_provider:"),jD(this,"on",(a,b)=>(this.events.on(a,b),this)),jD(this,"once",(a,b)=>(this.events.once(a,b),this)),jD(this,"removeListener",(a,b)=>(this.events.removeListener(a,b),this)),jD(this,"off",(a,b)=>(this.events.off(a,b),this)),jD(this,"parseAccount",a=>this.isCompatibleChainId(a)?this.parseAccountId(a).address:a),this.signer={},this.rpc={}}static async init(a){let b=new jG;return await b.initialize(a),b}async request(a,b){return await this.signer.request(a,this.formatChainId(this.chainId),b)}sendAsync(a,b,c){this.signer.sendAsync(a,b,this.formatChainId(this.chainId),c)}get connected(){return!!this.signer.client&&this.signer.client.core.relayer.connected}get connecting(){return!!this.signer.client&&this.signer.client.core.relayer.connecting}async enable(){return this.session||await this.connect(),await this.request({method:"eth_requestAccounts"})}async connect(a){var b;if(!this.signer.client)throw Error("Provider not initialized. Call init() first");this.loadConnectOpts(a);let{required:c,optional:d}=function(a){let{chains:b,optionalChains:c,methods:d,optionalMethods:e,events:f,optionalEvents:g,rpcMap:h}=a;if(!d_(b))throw Error("Invalid chains");let i={chains:b,methods:d||jp,events:f||jr,rpcMap:jB({},b.length?{[jE(b)]:h[jE(b)]}:{})},j=f?.filter(a=>!jr.includes(a)),k=d?.filter(a=>!jp.includes(a));if(!c&&!g&&!e&&!(null!=j&&j.length)&&!(null!=k&&k.length))return{required:b.length?i:void 0};let l={chains:[...new Set(j?.length&&k?.length||!c?i.chains.concat(c||[]):c)],methods:[...new Set(i.methods.concat(null!=e&&e.length?e:jq))],events:[...new Set(i.events.concat(null!=g&&g.length?g:js))],rpcMap:h};return{required:b.length?i:void 0,optional:c.length?l:void 0}}(this.rpc);try{let b=await new Promise(async(b,e)=>{var f,g;this.rpc.showQrModal&&(null==(f=this.modal)||f.open(),null==(g=this.modal)||g.subscribeState(a=>{a.open||this.signer.session||(this.signer.abortPairingAttempt(),e(Error("Connection request reset. Please try again.")))}));let h=null!=a&&a.scopedProperties?{[this.namespace]:a.scopedProperties}:void 0;await this.signer.connect(jC(jB({namespaces:jB({},c&&{[this.namespace]:c})},d&&{optionalNamespaces:{[this.namespace]:d}}),{pairingTopic:a?.pairingTopic,scopedProperties:h})).then(a=>{b(a)}).catch(a=>{var b;null==(b=this.modal)||b.showErrorMessage("Unable to connect"),e(Error(a.message))})});if(!b)return;let e=af(b.namespaces,[this.namespace]);this.setChainIds(this.rpc.chains.length?this.rpc.chains:e),this.setAccounts(e),this.events.emit("connect",{chainId:jF(this.chainId)})}catch(a){throw this.signer.logger.error(a),a}finally{null==(b=this.modal)||b.close()}}async authenticate(a,b){var c;if(!this.signer.client)throw Error("Provider not initialized. Call init() first");this.loadConnectOpts({chains:a?.chains});try{let c=await new Promise(async(c,d)=>{var e,f;this.rpc.showQrModal&&(null==(e=this.modal)||e.open(),null==(f=this.modal)||f.subscribeState(a=>{a.open||this.signer.session||(this.signer.abortPairingAttempt(),d(Error("Connection request reset. Please try again.")))})),await this.signer.authenticate(jC(jB({},a),{chains:this.rpc.chains}),b).then(a=>{c(a)}).catch(a=>{var b;null==(b=this.modal)||b.showErrorMessage("Unable to connect"),d(Error(a.message))})}),d=c.session;if(d){let a=af(d.namespaces,[this.namespace]);this.setChainIds(this.rpc.chains.length?this.rpc.chains:a),this.setAccounts(a),this.events.emit("connect",{chainId:jF(this.chainId)})}return c}catch(a){throw this.signer.logger.error(a),a}finally{null==(c=this.modal)||c.close()}}async disconnect(){this.session&&await this.signer.disconnect(),this.reset()}get isWalletConnect(){return!0}get session(){return this.signer.session}registerEventListeners(){this.signer.on("session_event",a=>{let{params:b}=a,{event:c}=b;"accountsChanged"===c.name?(this.accounts=this.parseAccounts(c.data),this.events.emit("accountsChanged",this.accounts)):"chainChanged"===c.name?this.setChainId(this.formatChainId(c.data)):this.events.emit(c.name,c.data),this.events.emit("session_event",a)}),this.signer.on("accountsChanged",a=>{this.accounts=this.parseAccounts(a),this.events.emit("accountsChanged",this.accounts)}),this.signer.on("chainChanged",a=>{let b=parseInt(a);this.chainId=b,this.events.emit("chainChanged",jF(this.chainId)),this.persist()}),this.signer.on("session_update",a=>{this.events.emit("session_update",a)}),this.signer.on("session_delete",a=>{this.reset(),this.events.emit("session_delete",a),this.events.emit("disconnect",jC(jB({},d$("USER_DISCONNECTED")),{data:a.topic,name:"USER_DISCONNECTED"}))}),this.signer.on("display_uri",a=>{this.events.emit("display_uri",a)})}switchEthereumChain(a){this.request({method:"wallet_switchEthereumChain",params:[{chainId:a.toString(16)}]})}isCompatibleChainId(a){return"string"==typeof a&&a.startsWith(`${this.namespace}:`)}formatChainId(a){return`${this.namespace}:${a}`}parseChainId(a){return Number(a.split(":")[1])}setChainIds(a){let b=a.filter(a=>this.isCompatibleChainId(a)).map(a=>this.parseChainId(a));b.length&&(this.chainId=b[0],this.events.emit("chainChanged",jF(this.chainId)),this.persist())}setChainId(a){if(this.isCompatibleChainId(a)){let b=this.parseChainId(a);this.chainId=b,this.switchEthereumChain(b)}}parseAccountId(a){let[b,c,d]=a.split(":");return{chainId:`${b}:${c}`,address:d}}setAccounts(a){this.accounts=a.filter(a=>this.parseChainId(this.parseAccountId(a).chainId)===this.chainId).map(a=>this.parseAccountId(a).address),this.events.emit("accountsChanged",this.accounts)}getRpcConfig(a){var b,c;let d=null!=(b=a?.chains)?b:[],e=null!=(c=a?.optionalChains)?c:[],f=d.concat(e);if(!f.length)throw Error("No chains specified in either `chains` or `optionalChains`");let g=d.length?a?.methods||jp:[],h=d.length?a?.events||jr:[],i=a?.optionalMethods||[],j=a?.optionalEvents||[],k=a?.rpcMap||this.buildRpcMap(f,a.projectId),l=a?.qrModalOptions||void 0;return{chains:d?.map(a=>this.formatChainId(a)),optionalChains:e.map(a=>this.formatChainId(a)),methods:g,events:h,optionalMethods:i,optionalEvents:j,rpcMap:k,showQrModal:!!(null!=a&&a.showQrModal),qrModalOptions:l,projectId:a.projectId,metadata:a.metadata}}buildRpcMap(a,b){let c={};return a.forEach(a=>{c[a]=this.getRpcUrl(a,b)}),c}async initialize(a){if(this.rpc=this.getRpcConfig(a),this.chainId=this.rpc.chains.length?jE(this.rpc.chains):jE(this.rpc.optionalChains),this.signer=await jo.init({projectId:this.rpc.projectId,metadata:this.rpc.metadata,disableProviderPing:a.disableProviderPing,relayUrl:a.relayUrl,storage:a.storage,storageOptions:a.storageOptions,customStoragePrefix:a.customStoragePrefix,telemetryEnabled:a.telemetryEnabled,logger:a.logger}),this.registerEventListeners(),await this.loadPersistedSession(),this.rpc.showQrModal){let a;try{let b=await jt(),{convertWCMToAppKitOptions:c}=await Promise.resolve().then(function(){return jS}),d=c(jC(jB({},this.rpc.qrModalOptions),{chains:[...new Set([...this.rpc.chains,...this.rpc.optionalChains])],metadata:this.rpc.metadata,projectId:this.rpc.projectId}));if(!d.networks.length)throw Error("No networks found for WalletConnect·");a=b(jC(jB({},d),{universalProvider:this.signer,manualWCControl:!0}))}catch(a){throw console.warn(a),Error("To use QR modal, please install @reown/appkit package")}if(a)try{this.modal=a}catch(a){throw this.signer.logger.error(a),Error("Could not generate WalletConnectModal Instance")}}}loadConnectOpts(a){if(!a)return;let{chains:b,optionalChains:c,rpcMap:d}=a;b&&d_(b)&&(this.rpc.chains=b.map(a=>this.formatChainId(a)),b.forEach(a=>{this.rpc.rpcMap[a]=d?.[a]||this.getRpcUrl(a)})),c&&d_(c)&&(this.rpc.optionalChains=[],this.rpc.optionalChains=c?.map(a=>this.formatChainId(a)),c.forEach(a=>{this.rpc.rpcMap[a]=d?.[a]||this.getRpcUrl(a)}))}getRpcUrl(a,b){var c;return(null==(c=this.rpc.rpcMap)?void 0:c[a])||`https://rpc.walletconnect.org/v1/?chainId=eip155:${a}&projectId=${b||this.rpc.projectId}`}async loadPersistedSession(){if(this.session)try{let a=await this.signer.client.core.storage.getItem(`${this.STORAGE_KEY}/chainId`),b=this.session.namespaces[`${this.namespace}:${a}`]?this.session.namespaces[`${this.namespace}:${a}`]:this.session.namespaces[this.namespace];this.setChainIds(a?[this.formatChainId(a)]:b?.accounts),this.setAccounts(b?.accounts)}catch(a){this.signer.logger.error("Failed to load persisted session, clearing state..."),this.signer.logger.error(a),await this.disconnect().catch(a=>this.signer.logger.warn(a))}}reset(){this.chainId=1,this.accounts=[]}persist(){this.session&&this.signer.client.core.storage.setItem(`${this.STORAGE_KEY}/chainId`,this.chainId)}parseAccounts(a){return"string"==typeof a||a instanceof String?[this.parseAccount(a)]:a.map(a=>this.parseAccount(a))}}let jH=jG;var jI=Object.defineProperty,jJ=Object.defineProperties,jK=Object.getOwnPropertyDescriptors,jL=Object.getOwnPropertySymbols,jM=Object.prototype.hasOwnProperty,jN=Object.prototype.propertyIsEnumerable,jO=(a,b,c)=>b in a?jI(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c,jP=(a,b)=>{for(var c in b||(b={}))jM.call(b,c)&&jO(a,c,b[c]);if(jL)for(var c of jL(b))jN.call(b,c)&&jO(a,c,b[c]);return a};let jQ=a=>{let[b,c]=a.split(":");return jR({id:c,caipNetworkId:a,chainNamespace:b,name:"",nativeCurrency:{name:"",symbol:"",decimals:8},rpcUrls:{default:{http:["https://rpc.walletconnect.org/v1"]}}})};function jR(a){return jP({formatters:void 0,fees:void 0,serializers:void 0},a)}var jS=Object.freeze({__proto__:null,convertWCMToAppKitOptions:function(a){var b,c,d,e,f,g,h;let i=null==(b=a.chains)?void 0:b.map(jQ).filter(Boolean);if(0===i.length)throw Error("At least one chain must be specified");let j=i.find(b=>{var c;return b.id===(null==(c=a.defaultChain)?void 0:c.id)}),k={projectId:a.projectId,networks:i,themeMode:a.themeMode,themeVariables:function(a){if(a)return{"--w3m-font-family":a["--wcm-font-family"],"--w3m-accent":a["--wcm-accent-color"],"--w3m-color-mix":a["--wcm-background-color"],"--w3m-z-index":a["--wcm-z-index"]?Number(a["--wcm-z-index"]):void 0,"--w3m-qr-color":a["--wcm-accent-color"],"--w3m-font-size-master":a["--wcm-text-medium-regular-size"],"--w3m-border-radius-master":a["--wcm-container-border-radius"],"--w3m-color-mix-strength":0}}(a.themeVariables),chainImages:a.chainImages,connectorImages:a.walletImages,defaultNetwork:j,metadata:jJ(jP({},a.metadata),jK({name:(null==(c=a.metadata)?void 0:c.name)||"WalletConnect",description:(null==(d=a.metadata)?void 0:d.description)||"Connect to WalletConnect-compatible wallets",url:(null==(e=a.metadata)?void 0:e.url)||"https://walletconnect.org",icons:(null==(f=a.metadata)?void 0:f.icons)||["https://walletconnect.org/walletconnect-logo.png"]})),showWallets:!0,featuredWalletIds:"NONE"===a.explorerRecommendedWalletIds?[]:Array.isArray(a.explorerRecommendedWalletIds)?a.explorerRecommendedWalletIds:[],excludeWalletIds:"ALL"===a.explorerExcludedWalletIds?[]:Array.isArray(a.explorerExcludedWalletIds)?a.explorerExcludedWalletIds:[],enableEIP6963:!1,enableInjected:!1,enableCoinbase:!0,enableWalletConnect:!0,features:{email:!1,socials:!1}};if(null!=(g=a.mobileWallets)&&g.length||null!=(h=a.desktopWallets)&&h.length){let b=[...(a.mobileWallets||[]).map(a=>({id:a.id,name:a.name,links:a.links})),...(a.desktopWallets||[]).map(a=>({id:a.id,name:a.name,links:{native:a.links.native,universal:a.links.universal}}))],c=[...k.featuredWalletIds||[],...k.excludeWalletIds||[]],d=b.filter(a=>!c.includes(a.id));d.length&&(k.customWallets=d)}return k},defineChain:jR})}];

//# sourceMappingURL=node_modules_%40walletconnect_ethereum-provider_dist_index_es_123f914a.js.map